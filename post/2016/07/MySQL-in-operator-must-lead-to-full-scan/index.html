<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.css" rel="stylesheet"><link href="//cdn.bootcss.com/animate.css/3.5.0/animate.css" rel="stylesheet"><link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet"><link href="//fonts.proxy.ustclug.org/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css?v=5.0.1" rel="stylesheet"><meta name="keywords" content="SQL,MySQL,"><link rel="alternate" href="/atom.xml" title="Cat's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1"><meta name="description" content="起始发布的文章是针对SQL server数据库的47条优化建议，已经太过久远，这些优化技巧是否还完全适用现今的数据库呢？更别提是否还适用于MySQL数据库了。我猜想是哪位“DBA大牛”应付交差，东抄一段西抄一段放上网，哪想到会有人当了真，更惨的是还完全信了。还真是：尽信书，不如无书。干我们这行，获取信息很容易，但甄别信息很难，希望大家引以为戒。"><meta property="og:type" content="article"><meta property="og:title" content="MySQL集锦 - IN 真会导致全表扫描吗？"><meta property="og:url" content="https://www.kisscat.pro/post/2016/07/MySQL-in-operator-must-lead-to-full-scan/index.html"><meta property="og:site_name" content="Cat's Blog"><meta property="og:description" content="起始发布的文章是针对SQL server数据库的47条优化建议，已经太过久远，这些优化技巧是否还完全适用现今的数据库呢？更别提是否还适用于MySQL数据库了。我猜想是哪位“DBA大牛”应付交差，东抄一段西抄一段放上网，哪想到会有人当了真，更惨的是还完全信了。还真是：尽信书，不如无书。干我们这行，获取信息很容易，但甄别信息很难，希望大家引以为戒。"><meta property="og:image" content="https://www.kisscat.pro/img/showIndexFromSitingOpportunity.png"><meta property="og:image" content="https://www.kisscat.pro/img/withoutIndex.png"><meta property="og:image" content="https://www.kisscat.pro/img/userUniqueIndex.png"><meta property="og:image" content="https://www.kisscat.pro/img/userPrimaryIndex.png"><meta property="og:image" content="https://www.kisscat.pro/img/useFKIndex.png"><meta property="og:image" content="https://www.kisscat.pro/img/userNormalIndex.png"><meta property="og:updated_time" content="2016-07-05T02:07:14.562Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="MySQL集锦 - IN 真会导致全表扫描吗？"><meta name="twitter:description" content="起始发布的文章是针对SQL server数据库的47条优化建议，已经太过久远，这些优化技巧是否还完全适用现今的数据库呢？更别提是否还适用于MySQL数据库了。我猜想是哪位“DBA大牛”应付交差，东抄一段西抄一段放上网，哪想到会有人当了真，更惨的是还完全信了。还真是：尽信书，不如无书。干我们这行，获取信息很容易，但甄别信息很难，希望大家引以为戒。"><meta name="twitter:image" content="https://www.kisscat.pro/img/showIndexFromSitingOpportunity.png"><script id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0x56ed168b0c000400,author:"这是作者大大"}}</script><title>MySQL集锦 - IN 真会导致全表扫描吗？ | Cat's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Cat's Blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">一饮一啄，莫非前定.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-index"><a href="/index/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>索引</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="#" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline">MySQL集锦 - IN 真会导致全表扫描吗？</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2016-07-04T14:47:12+08:00" content="2016-07-04">2016-07-04</time></span> <span class="post-category">&nbsp; | &nbsp;<span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/CodeReview/" itemprop="url" rel="index"><span itemprop="name">CodeReview</span></a></span></span> <span id="busuanzi_container_page_pv">&nbsp; | &nbsp; 热度&nbsp;<span id="busuanzi_value_page_pv"></span> °C</span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/post/2016/07/MySQL-in-operator-must-lead-to-full-scan/#comments" itemprop="discussionUrl"><span class="post-comments-count ds-thread-count" data-thread-key="post/2016/07/MySQL-in-operator-must-lead-to-full-scan/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>项目版本迭代慢了下来，有了段空闲时间，就对近些阶段的代码进行Code review，主要还是保持设计正确性和易维护性吧。</p><h1 id="有意思的代码"><a href="#有意思的代码" class="headerlink" title="有意思的代码"></a>有意思的代码</h1><p>由于积累了数个里程碑，review的工作量还挺大，我们分工协作，我这块主要看推荐模块，发现了几段有意思的代码，贴出来看看吧。</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Result&lt;Record1&lt;<span class="built_in">Integer</span>&gt;&gt; ids = create.<span class="keyword">select</span>(SITING_OPPORTUNITY_DISTRICT.OPPORTUNITY_ID).</span><br><span class="line">        from(SITING_OPPORTUNITY_DISTRICT).</span><br><span class="line">        <span class="keyword">where</span>(SITING_OPPORTUNITY_DISTRICT.DISTRICT_ID.like(districtId + <span class="string">"%"</span>)).</span><br><span class="line">        groupBy(SITING_OPPORTUNITY_DISTRICT.OPPORTUNITY_ID).</span><br><span class="line">        fetch();</span><br><span class="line"><span class="built_in">Set</span>&lt;<span class="built_in">Integer</span>&gt; opportunityIds = <span class="literal">new</span> HashSet&lt;&gt;(ids.size());</span><br><span class="line">for (Record1&lt;<span class="built_in">Integer</span>&gt; r : ids) &#123;</span><br><span class="line">    opportunityIds.add(r.getValue(SITING_OPPORTUNITY_DISTRICT.OPPORTUNITY_ID));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (opportunityIds.size() == <span class="number">1</span>) &#123;</span><br><span class="line">    condition = condition.<span class="keyword">and</span>(SITING_OPPORTUNITY.OPPORTUNITY_ID.<span class="literal">eq</span>(getSetFirstElement(opportunityIds)));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    condition = condition.<span class="keyword">and</span>(SITING_OPPORTUNITY.OPPORTUNITY_ID.<span class="keyword">in</span>(opportunityIds));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码的大意是：在MySQL数据库，表SITING_OPPORTUNITY_DISTRICT中，查询符合DISTRICT_ID字段条件的不重复OPPORTUNITY_ID字段，将这些字段放到一个集合。为描述方便，这个集合下文用ids代替。</p><p>1.如果ids的大小等于一，则拼上了一个SQL where条件，使用equal过滤ids中的第一个元素值，我们称这个SQL为A。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQL A template</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> SITING_OPPORTUNITY <span class="keyword">WHERE</span> OPPORTUNITY_ID=?;</span><br></pre></td></tr></table></figure><p>2.如果ids的大小大于一，则拼上了一个SQL where条件，使用in过滤ids中的所有元素值，我们称这个SQL为B。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQL B template</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> SITING_OPPORTUNITY <span class="keyword">WHERE</span> OPPORTUNITY_ID <span class="keyword">in</span>(?,?,?,?,?...);</span><br></pre></td></tr></table></figure><h1 id="存疑"><a href="#存疑" class="headerlink" title="存疑"></a>存疑</h1><p>项目中，类似这样的写法大概有10多处，都是按照集合大小来动态build SQL语句。ids的大小是跟用户的个性化数据有关的，统计了一下，超过70%的用户数据，ids大小是小于等于一的，所以这样调整代码的目的是为了降低全表扫描的概率？问了一下，得到确定的答复！但是SITING_OPPORTUNITY表在数据库结构设计评审时，已经加上了UNIQUE索引，为什么还需要这样写代码呢？难道MySQL强大的SQL优化器不能自动来完成？非得要在应用层来做？</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">目标表SITING_OPPORTUNITY结构示意：</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`siting_opportunity`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'ID'</span>,</span><br><span class="line">  <span class="string">`opportunity_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'商机ID'</span>,</span><br><span class="line">  <span class="string">`industry_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'行业id'</span>,</span><br><span class="line">  <span class="string">`min_area`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'最小面积'</span>,</span><br><span class="line">  <span class="string">`max_area`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'最大面积'</span>,</span><br><span class="line">  <span class="string">`min_rent`</span> <span class="built_in">bigint</span>(<span class="number">15</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'最小租金'</span>,</span><br><span class="line">  <span class="string">`max_rent`</span> <span class="built_in">bigint</span>(<span class="number">15</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'最大租金'</span>,</span><br><span class="line">  <span class="string">`is_deal`</span> tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'是否成交。0=未成交；1=已成交'</span>,</span><br><span class="line">  <span class="string">`slogan`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'广告语'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`opportunity_id`</span> (<span class="string">`opportunity_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`fk_sitingOpportunity_industry`</span> (<span class="string">`industry_id`</span>),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">`fk_sitingOpportunity_industry`</span> FOREIGN <span class="keyword">KEY</span> (<span class="string">`industry_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`industry`</span> (<span class="string">`code`</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci <span class="keyword">COMMENT</span>=<span class="string">'选址商机表'</span>;</span><br></pre></td></tr></table></figure><h1 id="解谜"><a href="#解谜" class="headerlink" title="解谜"></a>解谜</h1><p>我们绝大多数人，对in操作是否会带来全表扫描开销，还停留在MySQL很古老的版本认识上。网上一篇<a href="http://itindex.net/detail/55421-mysql-sql-%E8%AF%AD%E5%8F%A5" target="_blank" rel="external">30条SQL优化军规</a>流传甚广，大多数人奉此为神道。</p><p>其中有一条这样描述：“5.in 和 not in 也要慎用，否则会导致全表扫描”，但没说为什么这样认为，以及面向的MySQL版本和配置也没有说明。</p><p>这句话在Google上查询，至少在2004年7月就已经发布到网上了，起始发布的站点出自<a href="http://hovertree.com/h/bjaf/u935eb54.htm" target="_blank" rel="external">《SQL语句优化原则_Sql Server_何问起》</a>，整整12年过去了，还有很多圈内知名IT站点在发布同样的文章。</p><ul><li>segmentfault：<a href="https://segmentfault.com/a/1190000005008401" target="_blank" rel="external">《mysql语句优化建议-2016年4月26日发布》</a></li></ul><ul><li>红黑联盟：<a href="http://www.2cto.com/database/201606/514022.html" target="_blank" rel="external">《数据库查询优化方法总结-2016年6月1日发布》</a></li></ul><p>首先，起始发布的文章是针对SQL server数据库的47条优化建议，已经太过久远，这些优化技巧是否还完全适用现今的数据库呢？更别提是否还适用于MySQL数据库了。我猜想是哪位“DBA大牛”应付交差，东抄一段西抄一段放上网，哪想到会有人当了真，更惨的是还完全信了。还真是：尽信书，不如无书。干我们这行，获取信息很容易，但甄别信息很难，希望大家引以为戒。</p><h1 id="求是"><a href="#求是" class="headerlink" title="求是"></a>求是</h1><p>怀抱求是精神，我们一起来实践，看看MySQL对于IN操作符的处理。</p><p>下文中用的MySQL版本：5.7.13 windows x64 解压安装版.</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">MySQL配置文件:</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"><span class="attr">default-character-set=utf8</span></span><br><span class="line">[mysql]</span><br><span class="line"><span class="attr">default-character-set=utf8</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">########basic settings########</span></span><br><span class="line"><span class="comment">#skip-grant-tables,默认注释掉。重置root密码时用得上：http://www.apelearn.com/bbs/thread-9205-1-1.html</span></span><br><span class="line"><span class="comment">#skip-grant-tables</span></span><br><span class="line"></span><br><span class="line">skip-ssl</span><br><span class="line"><span class="attr">secure-file-priv</span> = NULL</span><br><span class="line"><span class="comment">#服务器唯一ID，默认是1，一般取IP最后一段</span></span><br><span class="line"><span class="attr">log-bin=mysql-bin</span></span><br><span class="line"><span class="attr">server-id</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="attr">user</span> = mysql</span><br><span class="line"><span class="attr">bind_address</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">autocommit</span> = <span class="number">0</span></span><br><span class="line"><span class="comment">#character_set_server=utf8mb4</span></span><br><span class="line"><span class="attr">character_set_server=utf8</span></span><br><span class="line"><span class="attr">skip_name_resolve</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">max_connections</span> = <span class="number">8000</span></span><br><span class="line"><span class="attr">max_connect_errors</span> = <span class="number">10000</span></span><br><span class="line"><span class="attr">basedir</span> =<span class="string">"F:\mysql/"</span></span><br><span class="line"><span class="attr">datadir</span> =<span class="string">"F:\mysql/data/"</span></span><br><span class="line"><span class="attr">tmpdir</span> =<span class="string">"F:\mysql/temp/"</span></span><br><span class="line"><span class="attr">socket</span> =<span class="string">"F:\mysql/data/mysql.sock"</span></span><br><span class="line"><span class="attr">pid-file="F:\mysql/data/current.pid"</span></span><br><span class="line"><span class="attr">transaction_isolation</span> = READ-COMMITTED</span><br><span class="line"><span class="attr">explicit_defaults_for_timestamp</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">join_buffer_size</span> = <span class="number">134217728</span></span><br><span class="line"><span class="attr">tmp_table_size</span> = <span class="number">67108864</span></span><br><span class="line"><span class="attr">max_allowed_packet</span> = <span class="number">128</span>MB</span><br><span class="line"><span class="attr">sql_mode</span> = <span class="string">"STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER"</span></span><br><span class="line"><span class="attr">interactive_timeout</span> = <span class="number">1800</span></span><br><span class="line"><span class="attr">wait_timeout</span> = <span class="number">1800</span></span><br><span class="line"><span class="attr">read_buffer_size</span> = <span class="number">16777216</span></span><br><span class="line"><span class="attr">read_rnd_buffer_size</span> = <span class="number">33554432</span></span><br><span class="line"><span class="attr">sort_buffer_size</span> = <span class="number">33554432</span></span><br><span class="line"><span class="comment">########log settings########</span></span><br><span class="line"><span class="attr">log-error="F:\mysql/log/error/error.log"</span></span><br><span class="line"><span class="attr">slow_query_log</span> = ON</span><br><span class="line"><span class="attr">slow_query_log_file</span> = <span class="string">"F:\mysql/log/slow/slow.log"</span></span><br><span class="line"><span class="attr">log_queries_not_using_indexes</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_slow_admin_statements</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_slow_slave_statements</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_throttle_queries_not_using_indexes</span> = <span class="number">10</span></span><br><span class="line"><span class="comment">#保留7天的日志</span></span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="number">7</span></span><br><span class="line"><span class="comment">#记录执行时间超过5秒的慢查询</span></span><br><span class="line"><span class="attr">long_query_time</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">min_examined_row_limit</span> = <span class="number">100</span></span><br><span class="line"><span class="comment">########replication settings########</span></span><br><span class="line"><span class="attr">master_info_repository</span> = TABLE</span><br><span class="line"><span class="attr">relay_log_info_repository</span> = TABLE</span><br><span class="line"><span class="attr">log_bin</span> = bin.log</span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">gtid_mode</span> = on</span><br><span class="line"><span class="attr">enforce_gtid_consistency</span> = <span class="number">1</span></span><br><span class="line">log_slave_updates</span><br><span class="line"><span class="attr">binlog_format</span> = row</span><br><span class="line"><span class="attr">relay_log</span> = relay.log</span><br><span class="line"><span class="attr">relay_log_recovery</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">binlog_gtid_simple_recovery</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slave_skip_errors</span> = ddl_exist_errors</span><br><span class="line"><span class="comment">########innodb settings########</span></span><br><span class="line"><span class="attr">innodb_page_size</span> = <span class="number">16384</span></span><br><span class="line"><span class="comment">#innodb_buffer_pool_size = 6G</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_instances</span> = <span class="number">8</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_load_at_startup</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_dump_at_shutdown</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">innodb_lru_scan_depth</span> = <span class="number">2000</span></span><br><span class="line"><span class="attr">innodb_lock_wait_timeout</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">innodb_io_capacity</span> = <span class="number">4000</span></span><br><span class="line"><span class="attr">innodb_io_capacity_max</span> = <span class="number">8000</span></span><br><span class="line"><span class="comment">#innodb_flush_method = O_DIRECT</span></span><br><span class="line"><span class="attr">innodb_flush_method=normal</span></span><br><span class="line"><span class="comment">#innodb_file_format = Barracuda</span></span><br><span class="line"><span class="comment">#innodb_file_format_max = Barracuda</span></span><br><span class="line"><span class="attr">innodb_log_group_home_dir</span> = <span class="string">"F:\mysql/log/redolog\"</span></span><br><span class="line"><span class="attr">innodb_undo_directory</span> = <span class="string">"F:\mysql/log/undolog/"</span></span><br><span class="line"><span class="attr">innodb_undo_logs</span> = <span class="number">128</span></span><br><span class="line"><span class="attr">innodb_undo_tablespaces</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">innodb_flush_neighbors</span> = <span class="number">0</span></span><br><span class="line"><span class="comment">#innodb_log_file_size = 4G</span></span><br><span class="line"><span class="attr">innodb_log_file_size</span> = <span class="number">256</span>MB</span><br><span class="line"><span class="attr">innodb_log_buffer_size</span> = <span class="number">16777216</span></span><br><span class="line"><span class="attr">innodb_purge_threads</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">innodb_large_prefix</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">innodb_thread_concurrency</span> = <span class="number">64</span></span><br><span class="line"><span class="attr">innodb_print_all_deadlocks</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">innodb_strict_mode</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">innodb_sort_buffer_size</span> = <span class="number">67108864</span></span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="number">2</span></span><br><span class="line"><span class="comment">########semi sync replication settings########</span></span><br><span class="line"><span class="attr">plugin_dir="F:\mysql/lib/plugin"</span></span><br><span class="line"><span class="attr">plugin_load</span> = <span class="string">"rpl_semi_sync_master=semisync_master.dll;rpl_semi_sync_slave=semisync_slave.dll"</span></span><br><span class="line"><span class="attr">loose_rpl_semi_sync_master_enabled</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">loose_rpl_semi_sync_slave_enabled</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">loose_rpl_semi_sync_master_timeout</span> = <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">[mysqld-<span class="number">5.7</span>]</span><br><span class="line"><span class="attr">innodb_buffer_pool_dump_pct</span> = <span class="number">40</span></span><br><span class="line"><span class="attr">innodb_page_cleaners</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">innodb_undo_log_truncate</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">innodb_max_undo_log_size</span> = <span class="number">2</span>G</span><br><span class="line"><span class="attr">innodb_purge_rseg_truncate_frequency</span> = <span class="number">128</span></span><br><span class="line"><span class="attr">binlog_gtid_simple_recovery=1</span></span><br><span class="line"><span class="attr">log_timestamps=system</span></span><br><span class="line"><span class="comment">#transaction_write_set_extraction=MURMUR32</span></span><br><span class="line"><span class="attr">show_compatibility_56=on</span></span><br></pre></td></tr></table></figure><p>先用show index from siting_opportunity;语句查看一下索引情况。</p><p><img src="/img/showIndexFromSitingOpportunity.png" alt=""><br>由于索引opportunity_id（key_name）是unique类型，可以看到其散列程度（Cardinality）是非常高的，因此该索引是很有效的。相应的该表的记录数是：476772行。</p><h2 id="无索引"><a href="#无索引" class="headerlink" title="无索引"></a>无索引</h2><p>字段min_area没有索引，<code>min_area</code> int(11) NOT NULL DEFAULT ‘0’ COMMENT ‘最小面积’。<br><img src="/img/withoutIndex.png" alt=""></p><p>很显然，优化器告诉我们，需要进行476772行扫描才能完成计算，也就是全表扫描了。</p><h2 id="Unique索引"><a href="#Unique索引" class="headerlink" title="Unique索引"></a>Unique索引</h2><p>先看在表SITING_OPPORTUNITY，OPPORTUNITY_ID字段的处理情况。<br><img src="/img/userUniqueIndex.png" alt=""><br>明显的可以看到，MySQL优化器是选择了索引，没有进行全表扫描，而且rows也为7。</p><h2 id="主键索引"><a href="#主键索引" class="headerlink" title="主键索引"></a>主键索引</h2><p>我们知道主键一定是唯一性索引,那情况应该跟上一节差不多？动动手吧！<br><img src="/img/userPrimaryIndex.png" alt=""><br>情况确实跟Unique索引差不多，pass！</p><h2 id="外键索引"><a href="#外键索引" class="headerlink" title="外键索引"></a>外键索引</h2><p>在设置外键时，数据库会同时为这个字段设置一个普通索引，所以外键的设置也应该遵循索引的设置策略。<br><img src="/img/useFKIndex.png" alt=""><br>使用外键字段时，使用in操作符，也使用了索引。</p><h2 id="普通索引"><a href="#普通索引" class="headerlink" title="普通索引"></a>普通索引</h2><p>我们换一个有普通索引，但该字段不是外键的表来验证。<br><img src="/img/userNormalIndex.png" alt=""></p><h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>1.在in操作中，集合体积过大时，索引还会生效吗？</p><p>2.在嵌套查询中，内层查询使用in，是否会有效率问题？</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文中的存储引擎都是innodb，因时间有限，没有对Myisam等其他存储引擎进行类似实验，希望动手能力强的你可以完成！</p><p>MySQL在2010年发布5.5版本中，优化器对in操作符可以自动完成优化，针对建立了索引的列可以使用索引，没有索引的列还是会走全表扫描。因此应用层不需要再进行画蛇添足啦，当然优化的精神是可嘉的，但在猜测中进行的优化可能与实际背离甚远！</p><p>互联网上的信息太过广泛，但这不应该成为我们掉以轻心的借口，抱着存疑求是的精神进行甄别，任何信息只有在我们实践验证后方可全信，用在生产开发上的知识，不容有失！</p></div><div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>Talk is cheap,show me the code.</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/rewards/wechat-reward-image.png" alt="Steven Cheng WeChat Pay"><p>微信打赏</p></div></div></div></div><footer class="post-footer"><div class="copyright" style="clear:both"><p><span>本文标题：</span><a href="/post/2016/07/MySQL-in-operator-must-lead-to-full-scan/">MySQL集锦 - IN 真会导致全表扫描吗？</a></p><p><span>文章作者：</span><a href="/" title="访问 Steven Cheng 的个人博客">Steven Cheng</a></p><p><span>发布时间：</span>2016年7月4日 - 14时07分</p><p><span>本文字数：</span><span class="page-count">5,270字</span></p><p><span>原始链接：</span><a href="/post/2016/07/MySQL-in-operator-must-lead-to-full-scan/" title="MySQL集锦 - IN 真会导致全表扫描吗？">https://www.kisscat.pro/post/2016/07/MySQL-in-operator-must-lead-to-full-scan/</a></p><p><span>许可协议：</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" title="Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)">Attribution-NonCommercial 4.0</a></p><p><span>转载请保留以上信息。</span></p></div><div class="post-tags"><a href="/tags/SQL/" rel="tag">#SQL</a> <a href="/tags/MySQL/" rel="tag">#MySQL</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/2016/06/LeetCode-training-3-elements-sum-zero/" rel="next" title="LeetCode刷题 - 求三个和为零的整数组合"><i class="fa fa-chevron-left"></i> LeetCode刷题 - 求三个和为零的整数组合</a></div><div class="post-nav-prev post-nav-item"><a href="/post/2016/07/mmseg4j-solr-compatible-solr-6-1/" rel="prev" title="开源贡献 - 升级Solr中文分词器 mmseg4j-solr">开源贡献 - 升级Solr中文分词器 mmseg4j-solr<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><p>热评文章</p><div class="ds-top-threads" data-range="weekly" data-num-items="4"></div><div class="comments" id="comments"><div class="ds-thread" data-thread-key="post/2016/07/MySQL-in-operator-must-lead-to-full-scan/" data-title="MySQL集锦 - IN 真会导致全表扫描吗？" data-url="https://www.kisscat.pro/post/2016/07/MySQL-in-operator-must-lead-to-full-scan/"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="https://www.kisscat.pro/about"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Steven Cheng"><p class="site-author-name" itemprop="name">Steven Cheng</p><p class="site-description motion-element" itemprop="description">https://www.kisscat.pro/about</p></a></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags"><span class="site-state-item-count">68</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/amao12580" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://segmentfault.com/blogs" title="SegmentFault" target="_blank">SegmentFault</a></li><li class="links-of-blogroll-item"><a href="http://blog.jobbole.com/" title="伯乐在线" target="_blank">伯乐在线</a></li><li class="links-of-blogroll-item"><a href="http://cnpolitics.org/" title="政见" target="_blank">政见</a></li><li class="links-of-blogroll-item"><a href="http://dajia.qq.com/" title="大家" target="_blank">大家</a></li><li class="links-of-blogroll-item"><a href="http://www.importnew.com/" title="ImportNew" target="_blank">ImportNew</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#写在前面"><span class="nav-number">1.</span> <span class="nav-text">写在前面</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#有意思的代码"><span class="nav-number">2.</span> <span class="nav-text">有意思的代码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#存疑"><span class="nav-number">3.</span> <span class="nav-text">存疑</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#解谜"><span class="nav-number">4.</span> <span class="nav-text">解谜</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#求是"><span class="nav-number">5.</span> <span class="nav-text">求是</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#无索引"><span class="nav-number">5.1.</span> <span class="nav-text">无索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unique索引"><span class="nav-number">5.2.</span> <span class="nav-text">Unique索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主键索引"><span class="nav-number">5.3.</span> <span class="nav-text">主键索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#外键索引"><span class="nav-number">5.4.</span> <span class="nav-text">外键索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#普通索引"><span class="nav-number">5.5.</span> <span class="nav-text">普通索引</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#思考"><span class="nav-number">6.</span> <span class="nav-text">思考</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 - <span itemprop="copyrightYear">2017</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Steven Cheng</span> <span class="post-count">&nbsp全站共168.5k字</span></div><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>访问量<span id="busuanzi_value_site_pv"></span> &nbsp 您是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴<script>var OriginTitile=document.title,st;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(つェ⊂)我藏好了哦~",clearTimeout(st)):(document.title="(*´∇｀*)被你发现啦~ "+OriginTitile,console.log("show"),st=setTimeout(function(){document.title=OriginTitile},4e3))})</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script><script src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script src="//cdn.bootcss.com/velocity/1.2.3/velocity.min.js"></script><script src="//cdn.bootcss.com/velocity/1.2.3/velocity.ui.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script src="/js/src/main.js?v=5.0.1"></script><script src="//cdn.bootcss.com/bootstrap/3.2.0/js/affix.js"></script><script src="/js/src/post.js?v=5.0.1"></script><script>var duoshuoQuery={short_name:"amao12580"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.id="duoshuo-script",t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementById("footer")||document.getElementsByTagName("body")[0]).appendChild(t)}()</script><script>function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=r.url,i=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){i=s.indexOf(e),l=n.indexOf(e),0>i&&0>l?c=!1:(0>l&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;0>u&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").mousedown(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>