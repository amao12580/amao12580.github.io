<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.css" rel="stylesheet"><link href="//cdn.bootcss.com/animate.css/3.5.0/animate.css" rel="stylesheet"><link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet"><link href="//fonts.proxy.ustclug.org/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css?v=5.0.1" rel="stylesheet"><meta name="keywords" content="Nginx,Docker,Alpine,Centos,Patch,"><link rel="alternate" href="/atom.xml" title="Cat's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1"><meta name="description" content="Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。"><meta name="keywords" content="Nginx,Docker,Alpine,Centos,Patch"><meta property="og:type" content="article"><meta property="og:title" content="Nginx与Docker容器系列 - 1.进行编译安装"><meta property="og:url" content="https://amao12580.github.io/post/2016/04/Nginx-with-docker-part-one/index.html"><meta property="og:site_name" content="Cat&#39;s Blog"><meta property="og:description" content="Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2016-06-02T05:25:42.287Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nginx与Docker容器系列 - 1.进行编译安装"><meta name="twitter:description" content="Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。"><script id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:void 0,author:"博主"}}</script><title>Nginx与Docker容器系列 - 1.进行编译安装 | Cat's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Cat's Blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">一饮一啄，莫非前定.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-index"><a href="/index/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>索引</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="#" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline">Nginx与Docker容器系列 - 1.进行编译安装</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2016-04-27T10:47:59+08:00" content="2016-04-27">2016-04-27</time></span> <span class="post-category">&nbsp; | &nbsp;<span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/Record/" itemprop="url" rel="index"><span itemprop="name">Record</span></a></span></span> <span id="busuanzi_container_page_pv">&nbsp; | &nbsp; 热度&nbsp;<span id="busuanzi_value_page_pv"></span> °C</span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。</p><p>我们项目中，对docker的使用非常深入，在线上环境和线下的测试环境、开发环境，都使用了docker作为运行时环境一致性支持。由于linux的发行版本和内核版本的不同组合，在没有docker之前，DevOps很难为不同的运行环境编写统一的软件安装维护的脚本，几乎只能借助虚拟机来达到这一目的，虚拟机的笨重和可调度性差，扩容与缩容也无法做到快速有效，已经被逐渐淘汰。</p><p>Nginx，性能已经毋庸置疑，但在docker hub上的nginx镜像，并不适合我们，没有对安全进行加固，更多的没有加入重要的功能增加，比如主动式地对后端Tomcat进行健康检查并自动failover，这个动能对HA的非常重要的，因此我们选择了在docker环境下，对官方nginx源码进行编译，并打上补丁，以符合实际生产环境的使用。</p><p>本文中的配置文件，已经整理到了GitHub：<a href="https://github.com/amao12580/docker" target="_blank" rel="external">https://github.com/amao12580/docker</a></p><p>本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。</p><h1 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h1><h2 id="宿主机的情况"><a href="#宿主机的情况" class="headerlink" title="宿主机的情况"></a>宿主机的情况</h2><h3 id="操作系统和硬件"><a href="#操作系统和硬件" class="headerlink" title="操作系统和硬件"></a>操作系统和硬件</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">操作系统</div><div class="line">root<span class="variable">@ubuntu</span>-<span class="number">14</span><span class="symbol">:~/docker/test</span><span class="comment"># uname -a</span></div><div class="line">Linux ubuntu-<span class="number">14</span> <span class="number">4.2</span>.<span class="number">0</span>-<span class="number">35</span>-generic <span class="comment">#40~14.04.1-Ubuntu SMP Fri Mar 18 16:37:35 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span></div><div class="line"></div><div class="line">CPU</div><div class="line">root<span class="variable">@ubuntu</span>-<span class="number">14</span><span class="symbol">:~/docker/test</span><span class="comment"># lscpu</span></div><div class="line"><span class="symbol">Architecture:</span>          x86_64</div><div class="line">CPU op-mode(s):        <span class="number">32</span>-bit, <span class="number">64</span>-bit</div><div class="line">Byte <span class="symbol">Order:</span>            Little Endian</div><div class="line">CPU(s):                <span class="number">4</span></div><div class="line">On-line CPU(s) <span class="symbol">list:</span>   <span class="number">0</span>-<span class="number">3</span></div><div class="line">Thread(s) per <span class="symbol">core:</span>    <span class="number">1</span></div><div class="line">Core(s) per <span class="symbol">socket:</span>    <span class="number">4</span></div><div class="line">Socket(s):             <span class="number">1</span></div><div class="line">NUMA node(s):          <span class="number">1</span></div><div class="line">Vendor <span class="symbol">ID:</span>             GenuineIntel</div><div class="line">CPU <span class="symbol">family:</span>            <span class="number">6</span></div><div class="line"><span class="symbol">Model:</span>                 <span class="number">58</span></div><div class="line"><span class="symbol">Stepping:</span>              <span class="number">9</span></div><div class="line">CPU <span class="symbol">MHz:</span>               <span class="number">1600.125</span></div><div class="line"><span class="symbol">BogoMIPS:</span>              <span class="number">6385.87</span></div><div class="line"><span class="symbol">Virtualization:</span>        VT-x</div><div class="line">L1d <span class="symbol">cache:</span>             <span class="number">32</span>K</div><div class="line">L1i <span class="symbol">cache:</span>             <span class="number">32</span>K</div><div class="line">L2 <span class="symbol">cache:</span>              <span class="number">256</span>K</div><div class="line">L3 <span class="symbol">cache:</span>              <span class="number">6144</span>K</div><div class="line"></div><div class="line">Memory</div><div class="line">root<span class="variable">@ubuntu</span>-<span class="number">14</span><span class="symbol">:~/docker/test</span><span class="comment"># free -m</span></div><div class="line">             total       used       free     shared    buffers     cached</div><div class="line"><span class="symbol">Mem:</span>          <span class="number">7881</span>       <span class="number">4751</span>       <span class="number">3130</span>          <span class="number">1</span>        <span class="number">419</span>       <span class="number">3810</span></div><div class="line">-<span class="regexp">/+ buffers/cache</span>:        <span class="number">520</span>       <span class="number">7360</span></div><div class="line"><span class="symbol">Swap:</span>         <span class="number">8087</span>          <span class="number">0</span>       <span class="number">8087</span></div></pre></td></tr></table></figure><h3 id="docker运行时环境"><a href="#docker运行时环境" class="headerlink" title="docker运行时环境"></a>docker运行时环境</h3><p>如果你不知道如何安装docker，请参考我对此的收集：<a href="http://amao12580.github.io/index/">http://amao12580.github.io/index/</a><br></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">root@ubuntu-14:~/docker/<span class="keyword">test</span># docker-compose <span class="keyword">version</span></div><div class="line">docker-compose <span class="keyword">version</span> 1.7.0, build 0d7bf73</div><div class="line">docker-py <span class="keyword">version</span>: 1.8.0</div><div class="line">CPython <span class="keyword">version</span>: 2.7.9</div><div class="line">OpenSSL <span class="keyword">version</span>: OpenSSL 1.0.1e 11 Feb 2013</div><div class="line"></div><div class="line"></div><div class="line">root@ubuntu-14:~/docker/<span class="keyword">test</span># docker <span class="keyword">version</span></div><div class="line">Client:</div><div class="line"> <span class="keyword">Version</span>:      1.9.1</div><div class="line"> API <span class="keyword">version</span>:  1.21</div><div class="line"> Go <span class="keyword">version</span>:   go1.4.3</div><div class="line"> Git commit:   a34a1d5</div><div class="line"> Built:        Fri Nov 20 17:56:04 UTC 2015</div><div class="line"> OS/<span class="keyword">Arch</span>:      linux/amd64</div><div class="line"></div><div class="line">Server:</div><div class="line"> <span class="keyword">Version</span>:      1.9.1</div><div class="line"> API <span class="keyword">version</span>:  1.21</div><div class="line"> Go <span class="keyword">version</span>:   go1.4.3</div><div class="line"> Git commit:   a34a1d5</div><div class="line"> Built:        Fri Nov 20 17:56:04 UTC 2015</div><div class="line"> OS/<span class="keyword">Arch</span>:      linux/amd64</div></pre></td></tr></table></figure><p></p><h1 id="FROM-centos-6-7"><a href="#FROM-centos-6-7" class="headerlink" title="FROM centos:6.7"></a>FROM centos:6.7</h1><p>我的目录结构看起来是这样：<br></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">root@ubuntu-<span class="number">14</span>:~# <span class="keyword">pwd</span></div><div class="line">/root</div><div class="line">root@ubuntu-<span class="number">14</span>:~# tree</div><div class="line">.</div><div class="line">└── docker</div><div class="line">    └── test</div><div class="line">        ├── docker-compose.yml</div><div class="line">        └── nginx</div><div class="line">            ├── <span class="keyword">conf</span></div><div class="line">            │   └── nginx.<span class="keyword">conf</span></div><div class="line">            ├── Dockerfile</div><div class="line">            ├── html</div><div class="line">            │   └── test_xw.html</div><div class="line">            ├── logs</div><div class="line">            │   ├── error.<span class="built_in">log</span></div><div class="line">            │   ├── nginx.pid</div><div class="line">            │   └── xws.access.<span class="built_in">log</span></div><div class="line">            ├── ssl</div><div class="line">            │   ├── www.xw18.<span class="keyword">cn</span>.crt(已经移除，涉及到机密)</div><div class="line">            │   └── www.xw18.<span class="keyword">cn</span>.key(已经移除，涉及到机密)</div><div class="line">            └── static</div><div class="line">                ├── apk</div><div class="line">                ├── css</div><div class="line">                ├── img</div><div class="line">                │   └── photo.jpg</div><div class="line">                └── js</div><div class="line"></div><div class="line"><span class="number">12</span> directories, <span class="number">10</span> <span class="keyword">files</span></div></pre></td></tr></table></figure><p></p><p>想要在shell中打印文件目录结构，请安装“tree”：aptitude install -y tree<br>请确保你的当前用户对这些目录具备必要的权限，下面一起看看docker-compose.yml文件吧。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># cat docker-compose.yml</span></div><div class="line"><span class="symbol">nginx:</span></div><div class="line"><span class="symbol">  build:</span> ./nginx</div><div class="line"><span class="symbol">  mem_limit:</span> <span class="number">4294967296</span></div><div class="line"><span class="symbol">  cpu_shares:</span> <span class="number">2</span></div><div class="line"><span class="symbol">  ports:</span></div><div class="line">    - <span class="string">"80:80"</span></div><div class="line">    - <span class="string">"443:443"</span></div><div class="line"><span class="symbol">  volumes:</span></div><div class="line">    - .<span class="meta-keyword">/nginx/</span>conf/nginx.conf:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>conf/nginx.conf</div><div class="line">    - .<span class="meta-keyword">/nginx/</span>html:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>html</div><div class="line">    - .<span class="meta-keyword">/nginx/</span>static:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>static</div><div class="line">    - .<span class="meta-keyword">/nginx/</span>ssl:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>ssl</div><div class="line">    - .<span class="meta-keyword">/nginx/</span>logs:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>logs:rw</div></pre></td></tr></table></figure><p>是不是看起来很简单呢？因为我们在docker-compose里定义的是服务的运行环境要求，并没有定义如何构建这个服务。</p><p>想看如何构建nginx,那一起来看看Dockerfile文件吧，这个文件就是如何一步步的构建服务的，如果有合适的image，你可以在Dockerfile里定义执行任何可以在宿主机环境下执行的命令哦。是不是很magic呢？<br></p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">root@ubuntu-14:~<span class="string">/docker/test/nginx</span><span class="comment"># cat Dockerfile</span></div><div class="line"><span class="comment">#定义基础镜像</span></div><div class="line">FROM centos<span class="function">:6.7</span></div><div class="line"></div><div class="line"><span class="comment">#定义nginx版本</span></div><div class="line">ENV NGINX_VERSION 1.9.14</div><div class="line"></div><div class="line"><span class="comment">#准备安装环境</span></div><div class="line">RUN yum install -y wget &amp;&amp; \</div><div class="line">wget -O <span class="string">/etc/yum.repos.d/CentOS-Base.repo</span> http:<span class="string">//mirrors.aliyun.com/repo/Centos-6.repo</span>  &amp;&amp; \</div><div class="line">yum clean all  &amp;&amp; \</div><div class="line">yum makecache &amp;&amp; \</div><div class="line"></div><div class="line"><span class="comment">#安装依赖组件</span></div><div class="line">rpm <span class="params">--import</span> <span class="string">/etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-</span>* &amp;&amp; \</div><div class="line">yum install -y epel-release &amp;&amp; \</div><div class="line">rpm <span class="params">--import</span> <span class="string">/etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</span> &amp;&amp; \</div><div class="line">yum install -y <span class="keyword">patch</span> pcre-devel openssl-devel zlib-devel gd-devel tar gcc git supervisor &amp;&amp; \</div><div class="line"></div><div class="line"><span class="comment">#下载安装包和补丁</span></div><div class="line">mkdir -p <span class="string">/var/run/nginx/</span> &amp;&amp; \</div><div class="line">wget -c http:<span class="string">//nginx.org/download/nginx-</span>$&#123;NGINX_VERSION&#125;<span class="string">.tar.gz</span> &amp;&amp; \</div><div class="line">git clone https:<span class="string">//github.com/cuber/ngx_http_google_filter_module.git</span> &amp;&amp; \</div><div class="line">git clone https:<span class="string">//github.com/yaoweibin/ngx_http_substitutions_filter_module.git</span> &amp;&amp; \</div><div class="line">git clone https:<span class="string">//github.com/aperezdc/ngx-fancyindex.git</span> &amp;&amp; \</div><div class="line">git clone https:<span class="string">//github.com/yaoweibin/nginx_upstream_check_module.git</span> &amp;&amp; \</div><div class="line"></div><div class="line"><span class="comment">#进行编译安装，同时打上补丁</span></div><div class="line">tar xf nginx-$&#123;NGINX_VERSION&#125;<span class="string">.tar.gz</span> &amp;&amp; \</div><div class="line"><span class="keyword">cd</span> nginx-$&#123;NGINX_VERSION&#125; &amp;&amp; \</div><div class="line"><span class="keyword">cd</span> src/ &amp;&amp; \</div><div class="line"><span class="comment">#打补丁</span></div><div class="line"><span class="keyword">patch</span> -p1 &lt; <span class="string">/nginx_upstream_check_module/check_1.9.2</span>+<span class="string">.patch</span> &amp;&amp; \</div><div class="line"><span class="keyword">cd</span> <span class="string">..</span> &amp;&amp; \</div><div class="line"><span class="comment">#去除nginx的对外版本号</span></div><div class="line">sed -i -e 's/$&#123;NGINX_VERSION&#125;<span class="string">//g</span>' -e 's/nginx\<span class="string">//ERROR/g</span>' -e 's/<span class="string">"NGINX"</span>/<span class="string">"ERROR"</span><span class="string">/g</span>' src/core/nginx.h  &amp;&amp; \</div><div class="line"><span class="string">./configure</span> <span class="params">--prefix=/usr/local/nginx</span> \</div><div class="line"><span class="params">--with-pcre</span> \</div><div class="line"><span class="params">--with-ipv6</span> \</div><div class="line"><span class="params">--with-http_ssl_module</span> \</div><div class="line"><span class="params">--with-http_flv_module</span> \</div><div class="line"><span class="params">--with-http_v2_module</span> \</div><div class="line"><span class="params">--with-http_realip_module</span> \</div><div class="line"><span class="params">--with-http_gzip_static_module</span> \</div><div class="line"><span class="params">--with-http_stub_status_module</span> \</div><div class="line"><span class="params">--with-http_mp4_module</span> \</div><div class="line"><span class="params">--with-http_image_filter_module</span> \</div><div class="line"><span class="params">--with-http_addition_module</span> \</div><div class="line"><span class="params">--with-http_sub_module</span>  \</div><div class="line"><span class="params">--with-http_dav_module</span>  \</div><div class="line"><span class="params">--http-client-body-temp-path=/usr/local/nginx/client/</span> \</div><div class="line"><span class="params">--http-proxy-temp-path=/usr/local/nginx/proxy/</span> \</div><div class="line"><span class="params">--http-fastcgi-temp-path=/usr/local/nginx/fcgi/</span> \</div><div class="line"><span class="params">--http-uwsgi-temp-path=/usr/local/nginx/uwsgi</span> \</div><div class="line"><span class="params">--http-scgi-temp-path=/usr/local/nginx/scgi</span> \</div><div class="line"><span class="params">--add-module=</span><span class="string">../ngx_http_google_filter_module</span> \</div><div class="line"><span class="params">--add-module=</span><span class="string">../ngx_http_substitutions_filter_module</span> \</div><div class="line"><span class="params">--add-module=</span><span class="string">../ngx-fancyindex</span> \</div><div class="line"><span class="params">--add-module=</span><span class="string">../nginx_upstream_check_module</span> &amp;&amp; \</div><div class="line"><span class="comment">#开始编译</span></div><div class="line">make -j $<span class="params">(awk '/processor/&#123;i++&#125;END&#123;print i&#125;' /proc/cpuinfo)</span> &amp;&amp; make install &amp;&amp; \</div><div class="line"><span class="comment">#设置一些工作目录</span></div><div class="line">mkdir -p <span class="string">/usr/local/nginx/cache/</span> &amp;&amp; \</div><div class="line">mkdir -p <span class="string">/usr/local/nginx/temp/</span> &amp;&amp; \</div><div class="line">rm -rf <span class="string">../</span>&#123;ngx*,nginx*&#125; &amp;&amp; \</div><div class="line">yum clean packages</div><div class="line"></div><div class="line"><span class="comment">#启动nginx，保留一个前台进程，以免被docker强制退出</span></div><div class="line">CMD <span class="string">./usr/local/nginx/sbin/nginx</span> &amp;&amp; tail -f <span class="string">/usr/local/nginx/logs/error.log</span></div></pre></td></tr></table></figure><p></p><p>是不是感觉内容太多了呢？每一步都有说明的，为了节省磁盘空间，我们将很多命令聚合到了一起。<br>事实上确实减少了一部分的磁盘占用，我们来看看现在build出来的镜像有多大吧。<br></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># pwd</span></div><div class="line"><span class="meta-keyword">/root/</span>docker/test</div><div class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># ls</span></div><div class="line">docker-compose.yml  nginx</div><div class="line"></div><div class="line">这里开始进行构建、启动并在后台保持运行</div><div class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># docker-compose up -d nginx</span></div><div class="line">后面的内容实在是太多了，就不贴出来了。如果你的网络环境很差，这个过程会很漫长。</div><div class="line"></div><div class="line">已经成功运行了，test一下</div><div class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># curl http:<span class="comment">//192.168.2.200/test_xw.html</span></span></div><div class="line"><span class="params">&lt;html&gt;</span></div><div class="line"><span class="params">&lt;body&gt;</span></div><div class="line"><span class="params">&lt;h2&gt;</span>Hello World! xw.<span class="params">&lt;/h2&gt;</span></div><div class="line"><span class="params">&lt;h2&gt;</span>这是测试内容.<span class="params">&lt;/h2&gt;</span></div><div class="line"><span class="params">&lt;/body&gt;</span></div><div class="line"></div><div class="line">容器运行后，nginx会处于listener状态，我们来看看images有多大</div><div class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># docker images</span></div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</div><div class="line">test_nginx          latest              e50ecf326484        <span class="number">2</span> hours ago         <span class="number">986.3</span> MB</div></pre></td></tr></table></figure><p></p><p>将近1个GB了，虽然说可以使用docker export -gzip 来压缩，并结合docker import命令直接导入，但是这个体积还是太肥大了，不利于轻量化运行和传播，我们来想想办法来减减肥吧。</p><h1 id="FROM-alpine-3-3"><a href="#FROM-alpine-3-3" class="headerlink" title="FROM alpine:3.3"></a>FROM alpine:3.3</h1><p>Alpine Linux，一个只有5M的Docker镜像。</p><p>Alpine Linux Docker镜像基于Alpine Linux操作系统，后者是一个面向安全的轻型Linux发行版。不同于通常Linux发行版，Alpine Linux采用了musl libc和busybox以减小系统的体积和运行时资源消耗。在保持瘦身的同时，Alpine Linux还提供了自己的包管理工具apk，可以在其网站上查询，或者直接通过apk命令查询和安装。</p><p>Alpine Linux Docker镜像也继承了Alpine Linux发行版的这些优势。相比于其他Docker镜像，它的容量非常小，仅仅只有5M，且拥有非常友好的包管理器。</p><p>可以直接使用的DockerFile：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#说明：因为我所在的网络环境非常差，所以将很多需要下载的Step单独用RUN定义了，以免每次网络连不上而重复下载。如果你的网络环境OK，可以考虑合并多个RUN,以进一步减少imags的大小</span></div><div class="line"></div><div class="line"><span class="comment">#定义基础镜像</span></div><div class="line">FROM alpine<span class="function">:latest</span></div><div class="line"></div><div class="line"><span class="comment">#定义nginx版本</span></div><div class="line">ENV NGINX_VERSION 1.9.14</div><div class="line"></div><div class="line"><span class="comment">#将安装源切换为国内环境(中国科学技术大学)，大大加快了安装速度，同时稳定性也有了保障</span></div><div class="line">ENV MIRROR_URL http:<span class="string">//mirrors.ustc.edu.cn/alpine/</span></div><div class="line"></div><div class="line">ENV MIRROR_URL_BACKUP http:<span class="string">//alpine.gliderlabs.com/alpine/</span></div><div class="line"></div><div class="line">ENV MIRROR_URL_SLOWEST http:<span class="string">//dl-cdn.alpinelinux.org/alpine/</span></div><div class="line"></div><div class="line"><span class="comment">#准备安装环境</span></div><div class="line">RUN <span class="keyword">echo</span> '' &gt; <span class="string">/etc/apk/repositories</span> &amp;&amp; \</div><div class="line">    <span class="keyword">echo</span> <span class="string">"$&#123;MIRROR_URL&#125;v3.3//main"</span>     &gt;&gt; <span class="string">/etc/apk/repositories</span> &amp;&amp; \</div><div class="line">    <span class="keyword">echo</span> <span class="string">"$&#123;MIRROR_URL&#125;v3.3//community"</span> &gt;&gt; <span class="string">/etc/apk/repositories</span> &amp;&amp; \</div><div class="line">    <span class="keyword">echo</span> '185.31.17.249 github.com' &gt;&gt; <span class="string">/etc/hosts</span> &amp;&amp; \</div><div class="line">    <span class="keyword">echo</span> '202.141.160.110 mirrors.ustc.edu.cn' &gt;&gt; <span class="string">/etc/hosts</span> &amp;&amp; \</div><div class="line">    <span class="keyword">echo</span> '206.251.255.63 nginx.org' &gt;&gt; <span class="string">/etc/hosts</span></div><div class="line"></div><div class="line"><span class="comment">#安装必要的组件(如果发生  ERROR: Service 'nginx' failed to build: The command '/bin/sh -c apk add... returned a non-zero code: 12。  这是网络问题：请删干净未完成container和images，10分钟后再来一遍)</span></div><div class="line">RUN apk add <span class="params">--no-cache</span> <span class="params">--virtual</span> <span class="string">.build-deps</span> \</div><div class="line">    gcc \</div><div class="line">    libc-dev \</div><div class="line">    make \</div><div class="line">    openssl-dev \</div><div class="line">    pcre-dev \</div><div class="line">    zlib-dev \</div><div class="line">    linux-headers \</div><div class="line">    curl \</div><div class="line">    jemalloc-dev \</div><div class="line">    gd-dev \</div><div class="line">    git</div><div class="line"><span class="comment">#下载安装包和补丁</span></div><div class="line">RUN mkdir -p <span class="string">/var/run/nginx/</span></div><div class="line">RUN wget -c http:<span class="string">//nginx.org/download/nginx-</span>$&#123;NGINX_VERSION&#125;<span class="string">.tar.gz</span></div><div class="line">RUN git clone https:<span class="string">//github.com/cuber/ngx_http_google_filter_module.git</span></div><div class="line">RUN git clone https:<span class="string">//github.com/yaoweibin/ngx_http_substitutions_filter_module.git</span></div><div class="line">RUN git clone https:<span class="string">//github.com/aperezdc/ngx-fancyindex.git</span></div><div class="line">RUN git clone https:<span class="string">//github.com/yaoweibin/nginx_upstream_check_module.git</span></div><div class="line"></div><div class="line"><span class="comment">#进行编译安装，同时打上补丁</span></div><div class="line">RUN tar -xzvf nginx-$&#123;NGINX_VERSION&#125;<span class="string">.tar.gz</span> &amp;&amp; \</div><div class="line"><span class="keyword">cd</span> nginx-$&#123;NGINX_VERSION&#125; &amp;&amp; \</div><div class="line"><span class="keyword">cd</span> src/ &amp;&amp; \</div><div class="line"><span class="comment">#打补丁</span></div><div class="line"><span class="keyword">patch</span> -p1 &lt; <span class="string">/nginx_upstream_check_module/check_1.9.2</span>+<span class="string">.patch</span> &amp;&amp; \</div><div class="line"><span class="keyword">cd</span> <span class="string">..</span> &amp;&amp; \</div><div class="line"><span class="comment">#去除nginx的对外版本号</span></div><div class="line">sed -i -e 's/$&#123;NGINX_VERSION&#125;<span class="string">//g</span>' -e 's/nginx\<span class="string">//ERROR/g</span>' -e 's/<span class="string">"NGINX"</span>/<span class="string">"ERROR"</span><span class="string">/g</span>' src/core/nginx.h  &amp;&amp; \</div><div class="line"><span class="string">./configure</span> <span class="params">--prefix=/usr/local/nginx</span> \</div><div class="line"><span class="params">--with-pcre</span> \</div><div class="line"><span class="params">--with-ipv6</span> \</div><div class="line"><span class="params">--with-http_ssl_module</span> \</div><div class="line"><span class="params">--with-http_flv_module</span> \</div><div class="line"><span class="params">--with-http_v2_module</span> \</div><div class="line"><span class="params">--with-http_realip_module</span> \</div><div class="line"><span class="params">--with-http_gzip_static_module</span> \</div><div class="line"><span class="params">--with-http_stub_status_module</span> \</div><div class="line"><span class="params">--with-http_mp4_module</span> \</div><div class="line"><span class="params">--with-http_image_filter_module</span> \</div><div class="line"><span class="params">--with-http_addition_module</span> \</div><div class="line"><span class="params">--with-http_sub_module</span>  \</div><div class="line"><span class="params">--with-http_dav_module</span>  \</div><div class="line"><span class="params">--http-client-body-temp-path=/usr/local/nginx/client/</span> \</div><div class="line"><span class="params">--http-proxy-temp-path=/usr/local/nginx/proxy/</span> \</div><div class="line"><span class="params">--http-fastcgi-temp-path=/usr/local/nginx/fcgi/</span> \</div><div class="line"><span class="params">--http-uwsgi-temp-path=/usr/local/nginx/uwsgi</span> \</div><div class="line"><span class="params">--http-scgi-temp-path=/usr/local/nginx/scgi</span> \</div><div class="line"><span class="params">--add-module=</span><span class="string">../ngx_http_google_filter_module</span> \</div><div class="line"><span class="params">--add-module=</span><span class="string">../ngx_http_substitutions_filter_module</span> \</div><div class="line"><span class="params">--add-module=</span><span class="string">../ngx-fancyindex</span> \</div><div class="line"><span class="params">--add-module=</span><span class="string">../nginx_upstream_check_module</span> \</div><div class="line"><span class="params">--with-ld-opt=</span><span class="string">"-ljemalloc"</span> &amp;&amp; \</div><div class="line"><span class="comment">#开始编译</span></div><div class="line">make -j $<span class="params">(awk '/processor/&#123;i++&#125;END&#123;print i&#125;' /proc/cpuinfo)</span> &amp;&amp; make install &amp;&amp; \</div><div class="line"></div><div class="line"><span class="comment">#设置一些工作目录</span></div><div class="line">mkdir -p <span class="string">/usr/local/nginx/cache/</span> &amp;&amp; \</div><div class="line">mkdir -p <span class="string">/usr/local/nginx/temp/</span> &amp;&amp; \</div><div class="line">rm -rf <span class="string">../</span>&#123;ngx*,nginx*&#125;</div><div class="line"></div><div class="line"><span class="comment">#启动nginx，保留一个前台进程，以免被docker强制退出</span></div><div class="line">CMD <span class="string">./usr/local/nginx/sbin/nginx</span> &amp;&amp; tail -f <span class="string">/usr/local/nginx/logs/error.log</span></div></pre></td></tr></table></figure><p>看看我们最后基于alpine的镜像大小是多少？<br></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root<span class="variable">@ubuntu</span>-<span class="number">14</span><span class="symbol">:~/docker/alpine</span><span class="comment"># docker images</span></div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</div><div class="line">alpine_nginx        latest              <span class="number">81</span>b30220a198        <span class="number">3</span> minutes ago       <span class="number">167.3</span> MB</div></pre></td></tr></table></figure><p></p><p>不到200MB，成功瘦身80%。合并一些RUN定义，提及还可以更小的。</p><p>我们现在做了2个版本的nginx编译增强镜像，来看看最后的文件目录吧！</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">root@ubuntu-<span class="number">14</span>:~# <span class="keyword">pwd</span></div><div class="line">/root</div><div class="line">root@ubuntu-<span class="number">14</span>:~# tree</div><div class="line">.</div><div class="line">└── docker</div><div class="line">    ├── alpine</div><div class="line">    │   ├── docker-compose.yml</div><div class="line">    │   └── nginx</div><div class="line">    │       ├── <span class="keyword">conf</span></div><div class="line">    │       │   └── nginx.<span class="keyword">conf</span></div><div class="line">    │       ├── Dockerfile</div><div class="line">    │       ├── html</div><div class="line">    │       │   └── test_xw.html</div><div class="line">    │       ├── logs</div><div class="line">    │       │   ├── error.<span class="built_in">log</span></div><div class="line">    │       │   ├── nginx.pid</div><div class="line">    │       │   └── xws.access.<span class="built_in">log</span></div><div class="line">    │       ├── ssl</div><div class="line">    │       │   ├── www.xw18.<span class="keyword">cn</span>.crt</div><div class="line">    │       │   └── www.xw18.<span class="keyword">cn</span>.key</div><div class="line">    │       └── static</div><div class="line">    │           ├── apk</div><div class="line">    │           ├── css</div><div class="line">    │           ├── img</div><div class="line">    │           │   ├── <span class="number">50</span>.jpg</div><div class="line">    │           │   └── photo.jpg</div><div class="line">    │           └── js</div><div class="line">    └── test</div><div class="line">        ├── docker-compose.yml</div><div class="line">        └── nginx</div><div class="line">            ├── <span class="keyword">conf</span></div><div class="line">            │   └── nginx.<span class="keyword">conf</span></div><div class="line">            ├── Dockerfile</div><div class="line">            ├── html</div><div class="line">            │   └── test_xw.html</div><div class="line">            ├── logs</div><div class="line">            │   ├── error.<span class="built_in">log</span></div><div class="line">            │   ├── nginx.pid</div><div class="line">            │   └── xws.access.<span class="built_in">log</span></div><div class="line">            ├── ssl</div><div class="line">            │   ├── www.xw18.<span class="keyword">cn</span>.crt</div><div class="line">            │   └── www.xw18.<span class="keyword">cn</span>.key</div><div class="line">            └── static</div><div class="line">                ├── apk</div><div class="line">                ├── css</div><div class="line">                ├── img</div><div class="line">                │   ├── <span class="number">50</span>.jpg</div><div class="line">                │   └── photo.jpg</div><div class="line">                └── js</div><div class="line"></div><div class="line"><span class="number">23</span> directories, <span class="number">22</span> <span class="keyword">files</span></div></pre></td></tr></table></figure><p>参考资料：<a href="http://dockone.io/article/1243?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">http://dockone.io/article/1243?utm_source=tuicool&amp;utm_medium=referral</a></p><h1 id="常用命令总结"><a href="#常用命令总结" class="headerlink" title="常用命令总结"></a>常用命令总结</h1><ul><li>docker进入到正在运行的容器内部</li></ul><p>docker exec -it test_redis_1 /bin/bash</p><ul><li>运行一个image_id为195eb90b5349的容器，并命名为shell，然后进入到容器内部</li></ul><p>docker run –name shell -i -t 195eb90b5349 /bin/bash</p><ul><li>运行一个名为alpine的容器，并进入到容器内部</li></ul><p>docker run -it alpine /bin/sh</p><ul><li>docker查看本地image</li></ul><p>docker images</p><ul><li>重启docker服务</li></ul><p>service docker restart</p><ul><li>查看所有的容器</li></ul><p>docker ps -a</p><ul><li>删除多个容器</li></ul><p>docker rm -v id1 id2</p><ul><li>删除所有容器</li></ul><p>docker rm $(docker ps -a -q)</p><ul><li>删除多个镜像</li></ul><p>dicker rmi id1 id2</p><ul><li>查询所有未成功build的镜像<none></none></li></ul><p>docker images -q -f dangling=true</p><ul><li>删除所有未成功build的镜像<none></none></li></ul><p>docker rmi $(docker images -q -f dangling=true)</p></div><div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>Talk is cheap,show me the code.</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/rewards/wechat-reward-image.png" alt="Steven Cheng WeChat Pay"><p>微信打赏</p></div></div></div></div><footer class="post-footer"><div class="copyright" style="clear:both"><p><span>本文标题：</span><a href="/post/2016/04/Nginx-with-docker-part-one/">Nginx与Docker容器系列 - 1.进行编译安装</a></p><p><span>文章作者：</span><a href="/" title="访问 Steven Cheng 的个人博客">Steven Cheng</a></p><p><span>发布时间：</span>2016年4月27日 - 10时04分</p><p><span>本文字数：</span><span class="page-count">7,839字</span></p><p><span>原始链接：</span><a href="/post/2016/04/Nginx-with-docker-part-one/" title="Nginx与Docker容器系列 - 1.进行编译安装">https://amao12580.github.io/post/2016/04/Nginx-with-docker-part-one/</a></p><p><span>许可协议：</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" title="Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)">Attribution-NonCommercial 4.0</a></p><p><span>转载请保留以上信息。</span></p></div><div class="post-tags"><a href="/tags/Nginx/" rel="tag">#Nginx</a> <a href="/tags/Docker/" rel="tag">#Docker</a> <a href="/tags/Alpine/" rel="tag">#Alpine</a> <a href="/tags/Centos/" rel="tag">#Centos</a> <a href="/tags/Patch/" rel="tag">#Patch</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/2016/04/Nginx-reverse-proxy-with-tomcat-in-docker/" rel="next" title="Nginx与Tomcat 8在Docker环境的反向代理配置过程"><i class="fa fa-chevron-left"></i> Nginx与Tomcat 8在Docker环境的反向代理配置过程</a></div><div class="post-nav-prev post-nav-item"><a href="/post/2016/04/Nginx-with-docker-part-two/" rel="prev" title="Nginx与Docker容器系列 - 2.在生产环境的实践">Nginx与Docker容器系列 - 2.在生产环境的实践<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="gitment_container"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="https://amao12580.github.io/about"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Steven Cheng"><p class="site-author-name" itemprop="name">Steven Cheng</p><p class="site-description motion-element" itemprop="description">https://amao12580.github.io/about</p></a></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags"><span class="site-state-item-count">68</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/amao12580" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://segmentfault.com/blogs" title="SegmentFault" target="_blank">SegmentFault</a></li><li class="links-of-blogroll-item"><a href="http://blog.jobbole.com/" title="伯乐在线" target="_blank">伯乐在线</a></li><li class="links-of-blogroll-item"><a href="http://cnpolitics.org/" title="政见" target="_blank">政见</a></li><li class="links-of-blogroll-item"><a href="http://dajia.qq.com/" title="大家" target="_blank">大家</a></li><li class="links-of-blogroll-item"><a href="http://www.importnew.com/" title="ImportNew" target="_blank">ImportNew</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装环境"><span class="nav-number">2.</span> <span class="nav-text">安装环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#宿主机的情况"><span class="nav-number">2.1.</span> <span class="nav-text">宿主机的情况</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#操作系统和硬件"><span class="nav-number">2.1.1.</span> <span class="nav-text">操作系统和硬件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker运行时环境"><span class="nav-number">2.1.2.</span> <span class="nav-text">docker运行时环境</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FROM-centos-6-7"><span class="nav-number">3.</span> <span class="nav-text">FROM centos:6.7</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FROM-alpine-3-3"><span class="nav-number">4.</span> <span class="nav-text">FROM alpine:3.3</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常用命令总结"><span class="nav-number">5.</span> <span class="nav-text">常用命令总结</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 - <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Steven Cheng</span> <span class="post-count">&nbsp全站共170.8k字</span></div><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>访问量<span id="busuanzi_value_site_pv"></span> &nbsp 您是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴<script>var OriginTitile=document.title,st;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(つェ⊂)我藏好了哦~",clearTimeout(st)):(document.title="(*´∇｀*)被你发现啦~ "+OriginTitile,console.log("show"),st=setTimeout(function(){document.title=OriginTitile},4e3))})</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script><script src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script src="//cdn.bootcss.com/velocity/1.2.3/velocity.min.js"></script><script src="//cdn.bootcss.com/velocity/1.2.3/velocity.ui.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script src="/js/src/main.js?v=5.0.1"></script><script src="//cdn.bootcss.com/bootstrap/3.2.0/js/affix.js"></script><script src="/js/src/post.js?v=5.0.1"></script><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment=new Gitment({owner:"amao12580",repo:"amao12580.github.io",oauth:{client_id:"4af869efcafad6f5df55",client_secret:"778c271d1b466eca5b6d4d9bddde1a49dabb7511"}});gitment.render("gitment_container")</script><script>function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=r.url,i=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){i=s.indexOf(e),l=n.indexOf(e),0>i&&0>l?c=!1:(0>l&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;0>u&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").mousedown(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>