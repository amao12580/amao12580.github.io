<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet"><link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css?v=5.0.1" rel="stylesheet"><meta name="keywords" content="Nginx,Docker,Alpine,Centos,Patch,"><link rel="alternate" href="/atom.xml" title="Cat's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1"><meta name="description" content="Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。"><meta property="og:type" content="article"><meta property="og:title" content="Nginx与Docker容器系列 - 1.进行编译安装"><meta property="og:url" content="http://amao12580.github.io/post/2016/04/Nginx-with-docker-part-one/index.html"><meta property="og:site_name" content="Cat's Blog"><meta property="og:description" content="Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。"><meta property="og:updated_time" content="2016-06-02T05:25:42.287Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nginx与Docker容器系列 - 1.进行编译安装"><meta name="twitter:description" content="Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。"><script id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0x56ed168b0c000400,author:"这是作者大大"}}</script><title>Nginx与Docker容器系列 - 1.进行编译安装 | Cat's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Cat's Blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">一饮一啄，莫非前定.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-index"><a href="/index" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>索引</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="#" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline">Nginx与Docker容器系列 - 1.进行编译安装</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2016-04-27T10:47:59+08:00" content="2016-04-27">2016-04-27</time></span> <span class="post-category">&nbsp; | &nbsp;<span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/Record/" itemprop="url" rel="index"><span itemprop="name">Record</span></a></span></span> <span id="busuanzi_container_page_pv">&nbsp; | &nbsp; 热度&nbsp;<span id="busuanzi_value_page_pv"></span> °C</span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/post/2016/04/Nginx-with-docker-part-one/#comments" itemprop="discussionUrl"><span class="post-comments-count ds-thread-count" data-thread-key="post/2016/04/Nginx-with-docker-part-one/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。</p><p>我们项目中，对docker的使用非常深入，在线上环境和线下的测试环境、开发环境，都使用了docker作为运行时环境一致性支持。由于linux的发行版本和内核版本的不同组合，在没有docker之前，DevOps很难为不同的运行环境编写统一的软件安装维护的脚本，几乎只能借助虚拟机来达到这一目的，虚拟机的笨重和可调度性差，扩容与缩容也无法做到快速有效，已经被逐渐淘汰。</p><p>Nginx，性能已经毋庸置疑，但在docker hub上的nginx镜像，并不适合我们，没有对安全进行加固，更多的没有加入重要的功能增加，比如主动式地对后端Tomcat进行健康检查并自动failover，这个动能对HA的非常重要的，因此我们选择了在docker环境下，对官方nginx源码进行编译，并打上补丁，以符合实际生产环境的使用。</p><p>本文中的配置文件，已经整理到了GitHub：<a href="https://github.com/amao12580/docker" target="_blank" rel="external">https://github.com/amao12580/docker</a></p><p>本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。</p><h1 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h1><h2 id="宿主机的情况"><a href="#宿主机的情况" class="headerlink" title="宿主机的情况"></a>宿主机的情况</h2><h3 id="操作系统和硬件"><a href="#操作系统和硬件" class="headerlink" title="操作系统和硬件"></a>操作系统和硬件</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">操作系统</span><br><span class="line">root<span class="variable">@ubuntu</span>-<span class="number">14</span><span class="symbol">:~/docker/test</span><span class="comment"># uname -a</span></span><br><span class="line">Linux ubuntu-<span class="number">14</span> <span class="number">4.2</span>.<span class="number">0</span>-<span class="number">35</span>-generic <span class="comment">#40~14.04.1-Ubuntu SMP Fri Mar 18 16:37:35 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line">CPU</span><br><span class="line">root<span class="variable">@ubuntu</span>-<span class="number">14</span><span class="symbol">:~/docker/test</span><span class="comment"># lscpu</span></span><br><span class="line"><span class="symbol">Architecture:</span>          x86_64</span><br><span class="line">CPU op-mode(s)<span class="symbol">:</span>        <span class="number">32</span>-bit, <span class="number">64</span>-bit</span><br><span class="line">Byte <span class="symbol">Order:</span>            Little Endian</span><br><span class="line">CPU(s)<span class="symbol">:</span>                <span class="number">4</span></span><br><span class="line">On-line CPU(s) <span class="symbol">list:</span>   <span class="number">0</span>-<span class="number">3</span></span><br><span class="line">Thread(s) per <span class="symbol">core:</span>    <span class="number">1</span></span><br><span class="line">Core(s) per <span class="symbol">socket:</span>    <span class="number">4</span></span><br><span class="line">Socket(s)<span class="symbol">:</span>             <span class="number">1</span></span><br><span class="line">NUMA node(s)<span class="symbol">:</span>          <span class="number">1</span></span><br><span class="line">Vendor <span class="symbol">ID:</span>             GenuineIntel</span><br><span class="line">CPU <span class="symbol">family:</span>            <span class="number">6</span></span><br><span class="line"><span class="symbol">Model:</span>                 <span class="number">58</span></span><br><span class="line"><span class="symbol">Stepping:</span>              <span class="number">9</span></span><br><span class="line">CPU <span class="symbol">MHz:</span>               <span class="number">1600.125</span></span><br><span class="line"><span class="symbol">BogoMIPS:</span>              <span class="number">6385.87</span></span><br><span class="line"><span class="symbol">Virtualization:</span>        VT-x</span><br><span class="line">L1d <span class="symbol">cache:</span>             <span class="number">32</span>K</span><br><span class="line">L1i <span class="symbol">cache:</span>             <span class="number">32</span>K</span><br><span class="line">L2 <span class="symbol">cache:</span>              <span class="number">256</span>K</span><br><span class="line">L3 <span class="symbol">cache:</span>              <span class="number">6144</span>K</span><br><span class="line"></span><br><span class="line">Memory</span><br><span class="line">root<span class="variable">@ubuntu</span>-<span class="number">14</span><span class="symbol">:~/docker/test</span><span class="comment"># free -m</span></span><br><span class="line">             total       used       free     shared    buffers     cached</span><br><span class="line"><span class="symbol">Mem:</span>          <span class="number">7881</span>       <span class="number">4751</span>       <span class="number">3130</span>          <span class="number">1</span>        <span class="number">419</span>       <span class="number">3810</span></span><br><span class="line">-<span class="regexp">/+ buffers/cache</span><span class="symbol">:</span>        <span class="number">520</span>       <span class="number">7360</span></span><br><span class="line"><span class="symbol">Swap:</span>         <span class="number">8087</span>          <span class="number">0</span>       <span class="number">8087</span></span><br></pre></td></tr></table></figure><h3 id="docker运行时环境"><a href="#docker运行时环境" class="headerlink" title="docker运行时环境"></a>docker运行时环境</h3><p>如果你不知道如何安装docker，请参考我对此的收集：<a href="http://amao12580.github.io/index/">http://amao12580.github.io/index/</a><br></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-14:~/docker/<span class="keyword">test</span># docker-compose <span class="keyword">version</span></span><br><span class="line">docker-compose <span class="keyword">version</span> 1.7.0, build 0d7bf73</span><br><span class="line">docker-py <span class="keyword">version</span>: 1.8.0</span><br><span class="line">CPython <span class="keyword">version</span>: 2.7.9</span><br><span class="line">OpenSSL <span class="keyword">version</span>: OpenSSL 1.0.1e 11 Feb 2013</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@ubuntu-14:~/docker/<span class="keyword">test</span># docker <span class="keyword">version</span></span><br><span class="line">Client:</span><br><span class="line"> <span class="keyword">Version</span>:      1.9.1</span><br><span class="line"> API <span class="keyword">version</span>:  1.21</span><br><span class="line"> Go <span class="keyword">version</span>:   go1.4.3</span><br><span class="line"> Git commit:   a34a1d5</span><br><span class="line"> Built:        Fri Nov 20 17:56:04 UTC 2015</span><br><span class="line"> OS/<span class="keyword">Arch</span>:      linux/amd64</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> <span class="keyword">Version</span>:      1.9.1</span><br><span class="line"> API <span class="keyword">version</span>:  1.21</span><br><span class="line"> Go <span class="keyword">version</span>:   go1.4.3</span><br><span class="line"> Git commit:   a34a1d5</span><br><span class="line"> Built:        Fri Nov 20 17:56:04 UTC 2015</span><br><span class="line"> OS/<span class="keyword">Arch</span>:      linux/amd64</span><br></pre></td></tr></table></figure><p></p><h1 id="FROM-centos-6-7"><a href="#FROM-centos-6-7" class="headerlink" title="FROM centos:6.7"></a>FROM centos:6.7</h1><p>我的目录结构看起来是这样：<br></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span><span class="number">-14</span>:~<span class="meta"># pwd</span></span><br><span class="line">/root</span><br><span class="line">root<span class="symbol">@ubuntu</span><span class="number">-14</span>:~<span class="meta"># tree</span></span><br><span class="line">.</span><br><span class="line">└── docker</span><br><span class="line">    └── test</span><br><span class="line">        ├── docker-compose.yml</span><br><span class="line">        └── nginx</span><br><span class="line">            ├── conf</span><br><span class="line">            │   └── nginx.conf</span><br><span class="line">            ├── Dockerfile</span><br><span class="line">            ├── html</span><br><span class="line">            │   └── test_xw.html</span><br><span class="line">            ├── logs</span><br><span class="line">            │   ├── error.<span class="built_in">log</span></span><br><span class="line">            │   ├── nginx.pid</span><br><span class="line">            │   └── xws.access.<span class="built_in">log</span></span><br><span class="line">            ├── ssl</span><br><span class="line">            │   ├── www.xw18.cn.crt(已经移除，涉及到机密)</span><br><span class="line">            │   └── www.xw18.cn.key(已经移除，涉及到机密)</span><br><span class="line">            └── <span class="keyword">static</span></span><br><span class="line">                ├── apk</span><br><span class="line">                ├── css</span><br><span class="line">                ├── img</span><br><span class="line">                │   └── photo.jpg</span><br><span class="line">                └── js</span><br><span class="line"></span><br><span class="line"><span class="number">12</span> directories, <span class="number">10</span> files</span><br></pre></td></tr></table></figure><p></p><p>想要在shell中打印文件目录结构，请安装“tree”：aptitude install -y tree<br>请确保你的当前用户对这些目录具备必要的权限，下面一起看看docker-compose.yml文件吧。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># cat docker-compose.yml</span></span><br><span class="line"><span class="symbol">nginx:</span></span><br><span class="line"><span class="symbol">  build:</span> ./nginx</span><br><span class="line"><span class="symbol">  mem_limit:</span> <span class="number">4294967296</span></span><br><span class="line"><span class="symbol">  cpu_shares:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">  ports:</span></span><br><span class="line">    - <span class="string">"80:80"</span></span><br><span class="line">    - <span class="string">"443:443"</span></span><br><span class="line"><span class="symbol">  volumes:</span></span><br><span class="line">    - .<span class="meta-keyword">/nginx/</span>conf/nginx.conf:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>conf/nginx.conf</span><br><span class="line">    - .<span class="meta-keyword">/nginx/</span>html:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>html</span><br><span class="line">    - .<span class="meta-keyword">/nginx/</span>static:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>static</span><br><span class="line">    - .<span class="meta-keyword">/nginx/</span>ssl:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>ssl</span><br><span class="line">    - .<span class="meta-keyword">/nginx/</span>logs:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>logs:rw</span><br></pre></td></tr></table></figure><p>是不是看起来很简单呢？因为我们在docker-compose里定义的是服务的运行环境要求，并没有定义如何构建这个服务。</p><p>想看如何构建nginx,那一起来看看Dockerfile文件吧，这个文件就是如何一步步的构建服务的，如果有合适的image，你可以在Dockerfile里定义执行任何可以在宿主机环境下执行的命令哦。是不是很magic呢？<br></p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-14:~/docker/test/nginx# cat Dockerfile</span><br><span class="line">#定义基础镜像</span><br><span class="line">FROM centos:6.7</span><br><span class="line"></span><br><span class="line">#定义nginx版本</span><br><span class="line">ENV NGINX_VERSION 1.9.14</span><br><span class="line"></span><br><span class="line">#准备安装环境</span><br><span class="line">RUN yum install -y wget &amp;&amp; \</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo  &amp;&amp; \</span><br><span class="line">yum clean all  &amp;&amp; \</span><br><span class="line">yum makecache &amp;&amp; \</span><br><span class="line"></span><br><span class="line">#安装依赖组件</span><br><span class="line">rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-* &amp;&amp; \</span><br><span class="line">yum install -y epel-release &amp;&amp; \</span><br><span class="line">rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 &amp;&amp; \</span><br><span class="line">yum install -y patch pcre-devel openssl-devel zlib-devel gd-devel tar gcc git supervisor &amp;&amp; \</span><br><span class="line"></span><br><span class="line">#下载安装包和补丁</span><br><span class="line">mkdir -p /var/run/nginx/ &amp;&amp; \</span><br><span class="line">wget -c http://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">git clone https://github.com/cuber/ngx_http_google_filter_module.git &amp;&amp; \</span><br><span class="line">git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git &amp;&amp; \</span><br><span class="line">git clone https://github.com/aperezdc/ngx-fancyindex.git &amp;&amp; \</span><br><span class="line">git clone https://github.com/yaoweibin/nginx_upstream_check_module.git &amp;&amp; \</span><br><span class="line"></span><br><span class="line">#进行编译安装，同时打上补丁</span><br><span class="line">tar xf nginx-$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">cd nginx-$&#123;NGINX_VERSION&#125; &amp;&amp; \</span><br><span class="line">cd src/ &amp;&amp; \</span><br><span class="line">#打补丁</span><br><span class="line">patch -p1 &lt; /nginx_upstream_check_module/check_1.9.2+.patch &amp;&amp; \</span><br><span class="line">cd .. &amp;&amp; \</span><br><span class="line">#去除nginx的对外版本号</span><br><span class="line">sed -i -e 's/$&#123;NGINX_VERSION&#125;//g' -e 's/nginx\//ERROR/g' -e 's/"NGINX"/"ERROR"/g' src/core/nginx.h  &amp;&amp; \</span><br><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">-<span class="ruby">-with-pcre \</span><br><span class="line"></span>-<span class="ruby">-with-ipv6 \</span><br><span class="line"></span>-<span class="ruby">-with-http_ssl_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_flv_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_v2_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_realip_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_gzip_static_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_stub_status_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_mp4_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_image_filter_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_addition_module \</span><br><span class="line"></span>-<span class="ruby">-with-http_sub_module  \</span><br><span class="line"></span>-<span class="ruby">-with-http_dav_module  \</span><br><span class="line"></span>-<span class="ruby">-http-client-body-temp-path=<span class="regexp">/usr/local</span><span class="regexp">/nginx/client</span><span class="regexp">/ \</span><br><span class="line"></span></span>-<span class="ruby"><span class="regexp">-http-proxy-temp-path=/usr</span><span class="regexp">/local/nginx</span><span class="regexp">/proxy/</span> \</span><br><span class="line"></span>-<span class="ruby">-http-fastcgi-temp-path=<span class="regexp">/usr/local</span><span class="regexp">/nginx/fcgi</span><span class="regexp">/ \</span><br><span class="line"></span></span>-<span class="ruby"><span class="regexp">-http-uwsgi-temp-path=/usr</span><span class="regexp">/local/nginx</span><span class="regexp">/uwsgi \</span><br><span class="line"></span></span>-<span class="ruby"><span class="regexp">-http-scgi-temp-path=/usr</span><span class="regexp">/local/nginx</span><span class="regexp">/scgi \</span><br><span class="line"></span></span>-<span class="ruby"><span class="regexp">-add-module=../ngx</span>_http_google_filter_module \</span><br><span class="line"></span>-<span class="ruby">-add-<span class="class"><span class="keyword">module</span>=../<span class="title">ngx_http_substitutions_filter_module</span> \</span></span><br><span class="line"></span>-<span class="ruby">-add-<span class="class"><span class="keyword">module</span>=../<span class="title">ngx</span>-<span class="title">fancyindex</span> \</span></span><br><span class="line"></span>-<span class="ruby">-add-<span class="class"><span class="keyword">module</span>=../<span class="title">nginx_upstream_check_module</span> &amp;&amp; \</span></span><br><span class="line"></span>#开始编译</span><br><span class="line">make -j $(awk '/processor/&#123;i++&#125;END&#123;print i&#125;' /proc/cpuinfo) &amp;&amp; make install &amp;&amp; \</span><br><span class="line">#设置一些工作目录</span><br><span class="line">mkdir -p /usr/local/nginx/cache/ &amp;&amp; \</span><br><span class="line">mkdir -p /usr/local/nginx/temp/ &amp;&amp; \</span><br><span class="line">rm -rf ../&#123;ngx*,nginx*&#125; &amp;&amp; \</span><br><span class="line">yum clean packages</span><br><span class="line"></span><br><span class="line">#启动nginx，保留一个前台进程，以免被docker强制退出</span><br><span class="line">CMD ./usr/local/nginx/sbin/nginx &amp;&amp; tail -f /usr/local/nginx/logs/error.log</span><br></pre></td></tr></table></figure><p></p><p>是不是感觉内容太多了呢？每一步都有说明的，为了节省磁盘空间，我们将很多命令聚合到了一起。<br>事实上确实减少了一部分的磁盘占用，我们来看看现在build出来的镜像有多大吧。<br></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># pwd</span></span><br><span class="line"><span class="meta-keyword">/root/</span>docker/test</span><br><span class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># ls</span></span><br><span class="line">docker-compose.yml  nginx</span><br><span class="line"></span><br><span class="line">这里开始进行构建、启动并在后台保持运行</span><br><span class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># docker-compose up -d nginx</span></span><br><span class="line">后面的内容实在是太多了，就不贴出来了。如果你的网络环境很差，这个过程会很漫长。</span><br><span class="line"></span><br><span class="line">已经成功运行了，test一下</span><br><span class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># curl http:<span class="comment">//192.168.2.200/test_xw.html</span></span></span><br><span class="line"><span class="params">&lt;html&gt;</span></span><br><span class="line"><span class="params">&lt;body&gt;</span></span><br><span class="line"><span class="params">&lt;h2&gt;</span>Hello World! xw.<span class="params">&lt;/h2&gt;</span></span><br><span class="line"><span class="params">&lt;h2&gt;</span>这是测试内容.<span class="params">&lt;/h2&gt;</span></span><br><span class="line"><span class="params">&lt;/body&gt;</span></span><br><span class="line"></span><br><span class="line">容器运行后，nginx会处于listener状态，我们来看看images有多大</span><br><span class="line">root@ubuntu<span class="number">-14</span>:~<span class="meta-keyword">/docker/</span>test<span class="meta"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">test_nginx          latest              e50ecf326484        <span class="number">2</span> hours ago         <span class="number">986.3</span> MB</span><br></pre></td></tr></table></figure><p></p><p>将近1个GB了，虽然说可以使用docker export -gzip 来压缩，并结合docker import命令直接导入，但是这个体积还是太肥大了，不利于轻量化运行和传播，我们来想想办法来减减肥吧。</p><h1 id="FROM-alpine-3-3"><a href="#FROM-alpine-3-3" class="headerlink" title="FROM alpine:3.3"></a>FROM alpine:3.3</h1><p>Alpine Linux，一个只有5M的Docker镜像。</p><p>Alpine Linux Docker镜像基于Alpine Linux操作系统，后者是一个面向安全的轻型Linux发行版。不同于通常Linux发行版，Alpine Linux采用了musl libc和busybox以减小系统的体积和运行时资源消耗。在保持瘦身的同时，Alpine Linux还提供了自己的包管理工具apk，可以在其网站上查询，或者直接通过apk命令查询和安装。</p><p>Alpine Linux Docker镜像也继承了Alpine Linux发行版的这些优势。相比于其他Docker镜像，它的容量非常小，仅仅只有5M，且拥有非常友好的包管理器。</p><p>可以直接使用的DockerFile：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#说明：因为我所在的网络环境非常差，所以将很多需要下载的Step单独用RUN定义了，以免每次网络连不上而重复下载。如果你的网络环境OK，可以考虑合并多个RUN,以进一步减少imags的大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义nginx版本</span></span><br><span class="line"><span class="keyword">ENV</span> NGINX_VERSION <span class="number">1.9</span>.<span class="number">14</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将安装源切换为国内环境(中国科学技术大学)，大大加快了安装速度，同时稳定性也有了保障</span></span><br><span class="line"><span class="keyword">ENV</span> MIRROR_URL http://mirrors.ustc.edu.cn/alpine/</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MIRROR_URL_BACKUP http://alpine.gliderlabs.com/alpine/</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MIRROR_URL_SLOWEST http://dl-cdn.alpinelinux.org/alpine/</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备安装环境</span></span><br><span class="line"><span class="keyword">RUN</span> <span class="bash"><span class="built_in">echo</span> <span class="string">''</span> &gt; /etc/apk/repositories &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MIRROR_URL&#125;</span>v3.3//main"</span>     &gt;&gt; /etc/apk/repositories &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MIRROR_URL&#125;</span>v3.3//community"</span> &gt;&gt; /etc/apk/repositories &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'185.31.17.249 github.com'</span> &gt;&gt; /etc/hosts &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'202.141.160.110 mirrors.ustc.edu.cn'</span> &gt;&gt; /etc/hosts &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'206.251.255.63 nginx.org'</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span></span><br><span class="line"><span class="comment">#安装必要的组件(如果发生  ERROR: Service 'nginx' failed to build: The command '/bin/sh -c apk add... returned a non-zero code: 12。  这是网络问题：请删干净未完成container和images，10分钟后再来一遍)</span></span><br><span class="line"><span class="keyword">RUN</span> <span class="bash">apk add --no-cache --virtual .build-deps \</span><br><span class="line">    gcc \</span><br><span class="line">    libc-dev \</span><br><span class="line">    make \</span><br><span class="line">    openssl-dev \</span><br><span class="line">    pcre-dev \</span><br><span class="line">    zlib-dev \</span><br><span class="line">    linux-headers \</span><br><span class="line">    curl \</span><br><span class="line">    jemalloc-dev \</span><br><span class="line">    gd-dev \</span><br><span class="line">    git</span><br><span class="line"></span><span class="comment">#下载安装包和补丁</span></span><br><span class="line"><span class="keyword">RUN</span> <span class="bash">mkdir -p /var/run/nginx/</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">wget -c http://nginx.org/download/nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar.gz</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">git <span class="built_in">clone</span> https://github.com/cuber/ngx_http_google_filter_module.git</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">git <span class="built_in">clone</span> https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">git <span class="built_in">clone</span> https://github.com/aperezdc/ngx-fancyindex.git</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">git <span class="built_in">clone</span> https://github.com/yaoweibin/nginx_upstream_check_module.git</span><br><span class="line"></span></span><br><span class="line"><span class="comment">#进行编译安装，同时打上补丁</span></span><br><span class="line"><span class="keyword">RUN</span> <span class="bash">tar -xzvf nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar.gz &amp;&amp; \</span><br><span class="line"><span class="built_in">cd</span> nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span> &amp;&amp; \</span><br><span class="line"><span class="built_in">cd</span> src/ &amp;&amp; \</span><br><span class="line"><span class="comment">#打补丁</span></span><br><span class="line"></span>patch -p1 &lt; /nginx_upstream_check_module/check_1.9.2+.patch &amp;&amp; \</span><br><span class="line">cd .. &amp;&amp; \</span><br><span class="line"><span class="comment">#去除nginx的对外版本号</span></span><br><span class="line">sed -i -e 's/$&#123;NGINX_VERSION&#125;//g' -e 's/nginx\//ERROR/g' -e 's/"NGINX"/"ERROR"/g' src/core/nginx.h  &amp;&amp; \</span><br><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-ipv6 \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_flv_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_mp4_module \</span><br><span class="line">--with-http_image_filter_module \</span><br><span class="line">--with-http_addition_module \</span><br><span class="line">--with-http_sub_module  \</span><br><span class="line">--with-http_dav_module  \</span><br><span class="line">--http-client-body-temp-path=/usr/local/nginx/client/ \</span><br><span class="line">--http-proxy-temp-path=/usr/local/nginx/proxy/ \</span><br><span class="line">--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \</span><br><span class="line">--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \</span><br><span class="line">--http-scgi-temp-path=/usr/local/nginx/scgi \</span><br><span class="line">--<span class="keyword">add</span>-module=../ngx_http_google_filter_module \</span><br><span class="line">--<span class="keyword">add</span>-module=../ngx_http_substitutions_filter_module \</span><br><span class="line">--<span class="keyword">add</span>-module=../ngx-fancyindex \</span><br><span class="line">--<span class="keyword">add</span>-module=../nginx_upstream_check_module \</span><br><span class="line">--with-ld-opt="-ljemalloc" &amp;&amp; \</span><br><span class="line"><span class="comment">#开始编译</span></span><br><span class="line">make -j $(awk '/processor/&#123;i++&#125;END&#123;print i&#125;' /proc/cpuinfo) &amp;&amp; make install &amp;&amp; \</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置一些工作目录</span></span><br><span class="line">mkdir -p /usr/local/nginx/cache/ &amp;&amp; \</span><br><span class="line">mkdir -p /usr/local/nginx/temp/ &amp;&amp; \</span><br><span class="line">rm -rf ../&#123;ngx*,nginx*&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动nginx，保留一个前台进程，以免被docker强制退出</span></span><br><span class="line"><span class="keyword">CMD</span> <span class="bash">./usr/<span class="built_in">local</span>/nginx/sbin/nginx &amp;&amp; tail <span class="_">-f</span> /usr/<span class="built_in">local</span>/nginx/logs/error.log</span></span><br></pre></td></tr></table></figure><p>看看我们最后基于alpine的镜像大小是多少？<br></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@ubuntu</span>-<span class="number">14</span><span class="symbol">:~/docker/alpine</span><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">alpine_nginx        latest              <span class="number">81</span>b30220a198        <span class="number">3</span> minutes ago       <span class="number">167.3</span> MB</span><br></pre></td></tr></table></figure><p></p><p>不到200MB，成功瘦身80%。合并一些RUN定义，提及还可以更小的。</p><p>我们现在做了2个版本的nginx编译增强镜像，来看看最后的文件目录吧！</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-14:~# <span class="keyword">pwd</span></span><br><span class="line">/root</span><br><span class="line">root@ubuntu-14:~# tree</span><br><span class="line">.</span><br><span class="line">└── docker</span><br><span class="line">    ├── alpine</span><br><span class="line">    │   ├── docker-compose.yml</span><br><span class="line">    │   └── nginx</span><br><span class="line">    │       ├── <span class="keyword">conf</span></span><br><span class="line">    │       │   └── nginx.<span class="keyword">conf</span></span><br><span class="line">    │       ├── Dockerfile</span><br><span class="line">    │       ├── html</span><br><span class="line">    │       │   └── test_xw.html</span><br><span class="line">    │       ├── logs</span><br><span class="line">    │       │   ├── <span class="keyword">error</span>.<span class="built_in">log</span></span><br><span class="line">    │       │   ├── nginx.pid</span><br><span class="line">    │       │   └── xws.access.<span class="built_in">log</span></span><br><span class="line">    │       ├── ssl</span><br><span class="line">    │       │   ├── www.xw18.cn.crt</span><br><span class="line">    │       │   └── www.xw18.cn.key</span><br><span class="line">    │       └── static</span><br><span class="line">    │           ├── apk</span><br><span class="line">    │           ├── css</span><br><span class="line">    │           ├── img</span><br><span class="line">    │           │   ├── 50.jpg</span><br><span class="line">    │           │   └── photo.jpg</span><br><span class="line">    │           └── js</span><br><span class="line">    └── <span class="keyword">test</span></span><br><span class="line">        ├── docker-compose.yml</span><br><span class="line">        └── nginx</span><br><span class="line">            ├── <span class="keyword">conf</span></span><br><span class="line">            │   └── nginx.<span class="keyword">conf</span></span><br><span class="line">            ├── Dockerfile</span><br><span class="line">            ├── html</span><br><span class="line">            │   └── test_xw.html</span><br><span class="line">            ├── logs</span><br><span class="line">            │   ├── <span class="keyword">error</span>.<span class="built_in">log</span></span><br><span class="line">            │   ├── nginx.pid</span><br><span class="line">            │   └── xws.access.<span class="built_in">log</span></span><br><span class="line">            ├── ssl</span><br><span class="line">            │   ├── www.xw18.cn.crt</span><br><span class="line">            │   └── www.xw18.cn.key</span><br><span class="line">            └── static</span><br><span class="line">                ├── apk</span><br><span class="line">                ├── css</span><br><span class="line">                ├── img</span><br><span class="line">                │   ├── 50.jpg</span><br><span class="line">                │   └── photo.jpg</span><br><span class="line">                └── js</span><br><span class="line"></span><br><span class="line">23 directories, 22 files</span><br></pre></td></tr></table></figure><p>参考资料：<a href="http://dockone.io/article/1243?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">http://dockone.io/article/1243?utm_source=tuicool&amp;utm_medium=referral</a></p><h1 id="常用命令总结"><a href="#常用命令总结" class="headerlink" title="常用命令总结"></a>常用命令总结</h1><ul><li>docker进入到正在运行的容器内部</li></ul><p>docker exec -it test_redis_1 /bin/bash</p><ul><li>运行一个image_id为195eb90b5349的容器，并命名为shell，然后进入到容器内部</li></ul><p>docker run –name shell -i -t 195eb90b5349 /bin/bash</p><ul><li>运行一个名为alpine的容器，并进入到容器内部</li></ul><p>docker run -it alpine /bin/sh</p><ul><li>docker查看本地image</li></ul><p>docker images</p><ul><li>重启docker服务</li></ul><p>service docker restart</p><ul><li>查看所有的容器</li></ul><p>docker ps -a</p><ul><li>删除多个容器</li></ul><p>docker rm -v id1 id2</p><ul><li>删除所有容器</li></ul><p>docker rm $(docker ps -a -q)</p><ul><li>删除多个镜像</li></ul><p>dicker rmi id1 id2</p><ul><li>查询所有未成功build的镜像<none></none></li></ul><p>docker images -q -f dangling=true</p><ul><li>删除所有未成功build的镜像<none></none></li></ul><p>docker rmi $(docker images -q -f dangling=true)</p></div><div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>Talk is cheap，show me the code.</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/rewards/wechat-reward-image.png" alt="Steven Cheng WeChat Pay"><p>微信打赏</p></div></div></div></div><footer class="post-footer"><div class="copyright" style="clear:both"><p><span>本文标题：</span><a href="/post/2016/04/Nginx-with-docker-part-one/">Nginx与Docker容器系列 - 1.进行编译安装</a></p><p><span>文章作者：</span><a href="/" title="访问 Steven Cheng 的个人博客">Steven Cheng</a></p><p><span>发布时间：</span>2016年4月27日 - 10时04分</p><p><span>本文字数：</span><span class="page-count">8,283字</span></p><p><span>原始链接：</span><a href="/post/2016/04/Nginx-with-docker-part-one/" title="Nginx与Docker容器系列 - 1.进行编译安装">http://amao12580.github.io/post/2016/04/Nginx-with-docker-part-one/</a></p><p><span>许可协议：</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" title="Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)">Attribution-NonCommercial 4.0</a></p><p><span>转载请保留以上信息。</span></p></div><div class="post-tags"><a href="/tags/Nginx/" rel="tag">#Nginx</a> <a href="/tags/Docker/" rel="tag">#Docker</a> <a href="/tags/Alpine/" rel="tag">#Alpine</a> <a href="/tags/Centos/" rel="tag">#Centos</a> <a href="/tags/Patch/" rel="tag">#Patch</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/2016/04/Nginx-reverse-proxy-with-tomcat-in-docker/" rel="next" title="Nginx与Tomcat 8在Docker环境的反向代理配置过程"><i class="fa fa-chevron-left"></i> Nginx与Tomcat 8在Docker环境的反向代理配置过程</a></div><div class="post-nav-prev post-nav-item"><a href="/post/2016/04/Nginx-with-docker-part-two/" rel="prev" title="Nginx与Docker容器系列 - 2.在生产环境的实践">Nginx与Docker容器系列 - 2.在生产环境的实践<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><p>热评文章</p><div class="ds-top-threads" data-range="weekly" data-num-items="4"></div><div class="comments" id="comments"><div class="ds-thread" data-thread-key="post/2016/04/Nginx-with-docker-part-one/" data-title="Nginx与Docker容器系列 - 1.进行编译安装" data-url="http://amao12580.github.io/post/2016/04/Nginx-with-docker-part-one/"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Steven Cheng"><p class="site-author-name" itemprop="name">Steven Cheng</p><p class="site-description motion-element" itemprop="description">http://amao12580.github.io/about</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/"><span class="site-state-item-count">12</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">38</span> <span class="site-state-item-name">标签</span></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/amao12580" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://segmentfault.com/blogs" title="SegmentFault" target="_blank">SegmentFault</a></li><li class="links-of-blogroll-item"><a href="http://blog.jobbole.com/" title="伯乐在线" target="_blank">伯乐在线</a></li><li class="links-of-blogroll-item"><a href="http://cnpolitics.org/" title="政见" target="_blank">政见</a></li><li class="links-of-blogroll-item"><a href="http://dajia.qq.com/" title="大家" target="_blank">大家</a></li><li class="links-of-blogroll-item"><a href="http://www.importnew.com/" title="ImportNew" target="_blank">ImportNew</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装环境"><span class="nav-number">2.</span> <span class="nav-text">安装环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#宿主机的情况"><span class="nav-number">2.1.</span> <span class="nav-text">宿主机的情况</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#操作系统和硬件"><span class="nav-number">2.1.1.</span> <span class="nav-text">操作系统和硬件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker运行时环境"><span class="nav-number">2.1.2.</span> <span class="nav-text">docker运行时环境</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FROM-centos-6-7"><span class="nav-number">3.</span> <span class="nav-text">FROM centos:6.7</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FROM-alpine-3-3"><span class="nav-number">4.</span> <span class="nav-text">FROM alpine:3.3</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常用命令总结"><span class="nav-number">5.</span> <span class="nav-text">常用命令总结</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2016</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Steven Cheng</span> <span class="post-count">&nbsp全站共84.5k字</span></div><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>访问量<span id="busuanzi_value_site_pv"></span> &nbsp 您是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴<script>var OriginTitile=document.title,st;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(つェ⊂)我藏好了哦",clearTimeout(st)):(document.title="(*´∇｀*)  被你发现啦~ "+OriginTitile,console.log("show"),st=setTimeout(function(){document.title=OriginTitile},4e3))})</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script><script src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script><script src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script><script src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script><script src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script><script src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script src="/js/src/utils.js?v=5.0.1"></script><script src="/js/src/motion.js?v=5.0.1"></script><script src="/js/src/affix.js?v=5.0.1"></script><script src="/js/src/schemes/pisces.js?v=5.0.1"></script><script src="/js/src/scrollspy.js?v=5.0.1"></script><script src="/js/src/post-details.js?v=5.0.1"></script><script src="/js/src/bootstrap.js?v=5.0.1"></script><script>var duoshuoQuery={short_name:"amao12580"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.id="duoshuo-script",t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementById("footer")||document.getElementsByTagName("body")[0]).appendChild(t)}()</script><script>function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=r.url,i=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){i=s.indexOf(e),l=n.indexOf(e),0>i&&0>l?c=!1:(0>l&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;0>u&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").mousedown(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>