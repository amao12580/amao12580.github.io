<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.css" rel="stylesheet"><link href="//cdn.bootcss.com/animate.css/3.5.0/animate.css" rel="stylesheet"><link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet"><link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css?v=5.0.1" rel="stylesheet"><meta name="keywords" content="JOOQ,SQL,ARM,ORM,Transaction,"><link rel="alternate" href="/atom.xml" title="Cat's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1"><meta name="description" content="JOOQ (Java Object Oriented Querying) 作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。"><meta property="og:type" content="article"><meta property="og:title" content="JOOQ 3.8.2 使用 教程：从入门到提高"><meta property="og:url" content="http://amao12580.github.io/post/2016/04/JOOQ-from-entry-to-improve/index.html"><meta property="og:site_name" content="Cat's Blog"><meta property="og:description" content="JOOQ (Java Object Oriented Querying) 作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。"><meta property="og:image" content="http://amao12580.github.io/img/jooq-flyway.png"><meta property="og:updated_time" content="2016-06-22T02:54:13.352Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="JOOQ 3.8.2 使用 教程：从入门到提高"><meta name="twitter:description" content="JOOQ (Java Object Oriented Querying) 作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。"><meta name="twitter:image" content="http://amao12580.github.io/img/jooq-flyway.png"><script id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0x56ed168b0c000400,author:"这是作者大大"}}</script><title>JOOQ 3.8.2 使用 教程：从入门到提高 | Cat's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Cat's Blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">一饮一啄，莫非前定.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-index"><a href="/index" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>索引</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="#" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline">JOOQ 3.8.2 使用 教程：从入门到提高</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2016-04-01T17:38:14+08:00" content="2016-04-01">2016-04-01</time></span> <span class="post-category">&nbsp; | &nbsp;<span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/Learning/" itemprop="url" rel="index"><span itemprop="name">Learning</span></a></span></span> <span id="busuanzi_container_page_pv">&nbsp; | &nbsp; 热度&nbsp;<span id="busuanzi_value_page_pv"></span> °C</span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/post/2016/04/JOOQ-from-entry-to-improve/#comments" itemprop="discussionUrl"><span class="post-comments-count ds-thread-count" data-thread-key="post/2016/04/JOOQ-from-entry-to-improve/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>2016年后换了一家公司干，后台ORM框架用的JOOQ，完全陌生的东西。干这一行越久，越觉得有更多有趣的新事物需要去探索。想起小说<a href="https://book.douban.com/subject/26586492/" target="_blank" rel="external">《火星救援》</a>，Mark侥幸在火星风暴中幸存后，一步步将自己救出困境，遇到的难题或大或小，皆有优雅解决之法。一切看似偶然蹊跷，其实与Mark的长期知识储备分不开。所谓艺多不压身，应该在有限的时间里，得到更多成长，以期待机会来时不辜负。</p><p>下文中的学习示例代码，已经整理完毕：</p><ul><li><p>原味基础学习：<a href="https://github.com/amao12580/JOOQ" target="_blank" rel="external">https://github.com/amao12580/JOOQ</a></p></li><li><p>与Spring深度整合：<a href="https://github.com/amao12580/JOOQ-With-Spring" target="_blank" rel="external">https://github.com/amao12580/JOOQ-With-Spring</a></p></li></ul><h2 id="什么是JOOQ？"><a href="#什么是JOOQ？" class="headerlink" title="什么是JOOQ？"></a>什么是JOOQ？</h2><p><a href="http://www.jooq.org/" target="_blank" rel="external">JOOQ</a>，全称Java Object Oriented Querying，即面向Java对象查询。它是<a href="http://www.datageekery.com/" target="_blank" rel="external">Data Geekery</a>公司研发的DA方案(Data Access Layer)，主要解决两个问题：</p><ol><li>Hibernate的抽象使得我们离SQL太远，对SQL的掌控力度弱</li><li>JDBC又过于嘈杂，需要干的事情太多</li></ol><p>JOOQ希望干的就是在上述两者中寻找一个最佳的平衡。它依据数据库中的表生成DA相关的代码，开发者将生成的代码引入项目中即可使用。</p><p>有好几个版本</p><ul><li>OpenSource</li><li>Express</li><li>Professional</li><li>Enterprise</li></ul><p>OpenSource版本针对开源数据库，已经够用了。其它的几个版本针对非开源数据库，差异在于不同的后续支持。</p><p>想了解各版本的更多区别，跟我一起看吧。</p><ul><li><p><a href="http://www.jooq.org/legal/licensing" target="_blank" rel="external">http://www.jooq.org/legal/licensing</a></p></li><li><p><a href="http://www.jooq.org/download/" target="_blank" rel="external">http://www.jooq.org/download/</a></p></li></ul><p>JOOQ作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。</p><p>它与Hibernate不同，不依赖使用字符串变量在Java代码中拼接SQL语句。在复杂SQL语句中，与变量的组合拼接时，SQL被割裂成多个部分，失去了宝贵的可读性，这简直是噩梦。而且Hibernate饱受诟病的连接查询配置复杂以及HQL语法的问题，在JOOQ中不复存在。</p><p>它与Mybatis不同，不依赖繁琐分散的XML进行SQL预定义。代码与SQL语句的分离，初衷是为了解决SQL嵌入代码时带来不直观的复杂性，但是分离的代价是维护工作倍增以及类型转换问题，经常遭遇到应用层代码变更，而XML定义未同步变更，IDE几乎无法解决。又或者开发人员改动一个XML文件，却意外影响多处上层代码，而这个问题很难避免。</p><p>更进一步的，JOOQ提供原生的类型安全转换，以及POJO维护，免去大量一次性代码的编写。当然，你也可以使用Eclipse<a href="http://my.oschina.net/lujianing/blog/200135" target="_blank" rel="external">代码生成插件</a>解决这个问题，但是如果ORM能自动解决(结合Maven Plugin)，为什么拒绝呢？</p><p>使用这种DAO模式，可以通过类的方式来进行数据库访问了。而且对SQL控制粒度加大的同时，维护工作并没有因此倍增，这对于开发人员是更好的解决方案，也是未来的趋势。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">使用JOOQ进行2张表内连接查询示例</span><br><span class="line"></span><br><span class="line">// Typesafely <span class="keyword">execute</span> the <span class="keyword">SQL</span> <span class="keyword">statement</span> directly <span class="keyword">with</span> jOOQ</span><br><span class="line"><span class="keyword">Result</span>&lt;Record3&lt;<span class="keyword">String</span>, <span class="keyword">String</span>, <span class="keyword">String</span>&gt;&gt; <span class="keyword">result</span> =</span><br><span class="line"><span class="keyword">create</span>.<span class="keyword">select</span>(BOOK.TITLE, AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME)</span><br><span class="line">    .<span class="keyword">from</span>(BOOK)</span><br><span class="line">    .<span class="keyword">join</span>(AUTHOR)</span><br><span class="line">    .<span class="keyword">on</span>(BOOK.AUTHOR_ID.equal(AUTHOR.<span class="keyword">ID</span>))</span><br><span class="line">    .<span class="keyword">where</span>(BOOK.PUBLISHED_IN.equal(<span class="number">1948</span>))</span><br><span class="line">    .<span class="keyword">fetch</span>();</span><br></pre></td></tr></table></figure><h3 id="VS-主流ORM框架"><a href="#VS-主流ORM框架" class="headerlink" title="VS 主流ORM框架"></a>VS 主流ORM框架</h3><ul><li><a href="http://blog.jooq.org/2015/03/24/jooq-vs-hibernate-when-to-choose-which/" target="_blank" rel="external">JOOQ vs. Hibernate: When to Choose Which</a></li><li><a href="http://blog.jooq.org/2013/07/13/sql-templating-with-jooq-or-mybatis/" target="_blank" rel="external">SQL Templating with jOOQ or MyBatis</a><h3 id="优势和局限性"><a href="#优势和局限性" class="headerlink" title="优势和局限性"></a>优势和局限性</h3></li></ul><p>优势</p><ul><li>JOOQ 高效的合并了复杂SQL、<a href="http://blog.jooq.org/2015/05/26/type-safe-queries-for-jpas-native-query-api/" target="_blank" rel="external">类型安全</a>、<a href="#Code-Generation">源码生成</a>、Active Records、存储过程以及高级数据类型的 Java 类库。支持DB2, Derby, Ingres, H2, HSQLDB, MySQL, Oracle, Postgres, SQLite, SQL Server, Sybase。</li></ul><p>局限性</p><ul><li>开发人员需要转换思维，接受新事物，May be better？</li></ul><h2 id="入门篇"><a href="#入门篇" class="headerlink" title="入门篇"></a>入门篇</h2><h3 id="With-MySQL"><a href="#With-MySQL" class="headerlink" title="With MySQL"></a>With MySQL</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--MySQL JDBC driver, 数据库迁移等情况下需要. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.36<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Code-Generation"><a href="#Code-Generation" class="headerlink" title="Code Generation"></a>Code Generation</h3><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!--数据库schema代码生成器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jooq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jooq-codegen<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--数据库代码生成的插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Specify the maven code generator plugin --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jooq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jooq-codegen-maven<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- The plugin should hook into the generate goal --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>generate<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- JDBC connection parameters --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbc</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">driver</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>$</span><span class="template-variable">&#123;db.url&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">user</span>&gt;</span>$</span><span class="template-variable">&#123;db.username&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span>$</span><span class="template-variable">&#123;db.password&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdbc</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Generator parameters --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">generator</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">database</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>org.jooq.util.mysql.MySQLDatabase<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span>.*<span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">inputSchema</span>&gt;</span>$</span><span class="template-variable">&#123;db.schema&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">inputSchema</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">forcedTypes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">forcedType</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">name</span>&gt;</span>BOOLEAN<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">expression</span>&gt;</span>.*\.HANDMADE<span class="tag">&lt;/<span class="name">expression</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">types</span>&gt;</span>.*<span class="tag">&lt;/<span class="name">types</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">forcedType</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">forcedTypes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">packageName</span>&gt;</span>com.study.jooq.common.generated<span class="tag">&lt;/<span class="name">packageName</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">generator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="With-Flyway"><a href="#With-Flyway" class="headerlink" title="With Flyway"></a>With Flyway</h3><p>Flyway 是独立于数据库的应用、管理并跟踪数据库变更的数据库版本管理工具。</p><p><a href="http://www.cnblogs.com/huang0925/p/4409506.html" target="_blank" rel="external">Flyway， 数据库Schema管理利器</a></p><p>在pom.xml的配置<br></p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--防止maven改动IDE的language level --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--数据库迁移所用的参数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">db.url</span>&gt;</span>jdbc:mysql://localhost:3306<span class="tag">&lt;/<span class="name">db.url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">db.username</span>&gt;</span>root<span class="tag">&lt;/<span class="name">db.username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">db.password</span>&gt;</span>********<span class="tag">&lt;/<span class="name">db.password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">db.schema</span>&gt;</span>study<span class="tag">&lt;/<span class="name">db.schema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--数据库迁移, 同步的插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.flywaydb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flyway-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Note that we're executing the Flyway plugin in the "generate-sources" phase --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>migrate<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Note that we need to prefix the db/migration path with filesystem:</span><br><span class="line">    to prevent Flyway from looking for our migration scripts only on the classpath --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>$</span><span class="template-variable">&#123;db.url&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">user</span>&gt;</span>$</span><span class="template-variable">&#123;db.username&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>$</span><span class="template-variable">&#123;db.password&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>$</span><span class="template-variable">&#123;project.build.sourceEncoding&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">schemas</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">schema</span>&gt;</span>$</span><span class="template-variable">&#123;db.schema&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">schemas</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">locations</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">location</span>&gt;</span>filesystem:src/main/resources/db/migration<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">locations</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p></p><p>在工程：src/main/resources/db/migration目录下，没有目录文件夹时需要先创建文件夹。放入数据库初始化SQL脚本：V1__init_database.sql。注意在maven中配置的db.schema=study，表明需要使用的数据库名称是study，study需要事先不存在。</p><p>执行maven -clean、maven -install成功后，发现数据库有了新的数据库study，并且该数据库有了order、user、schema_version三张表，user、order是我们在脚本中定义需要生成的表，而schema_version是flyway生成的，维护数据库版本升级时的信息。对应的在代码中，生成了三个POJO。</p><p>代码生成示例：<br><img src="/img/jooq-flyway.png" alt="IDEA使用JOOQ自动生成代码"></p><h3 id="With-HikariCp"><a href="#With-HikariCp" class="headerlink" title="With HikariCp"></a>With HikariCp</h3><p>HikariCP号称是现在性能最好的JDBC连接池组件，具体的性能到底如何，我也没有仔细的测试过，不过从它现在的发展来看，其可能确实如它宣传的那样其性能高过目前所有的连接池组件。之前对连接池的记忆一直都是C3P0、DBCP、BoneCP，这三者中BoneCP的性能是最好的，C3P0的性能在现在来说确实是非常差的了，好像C3P0很久都没有更新了，所以我们应该杜绝在项目中使用C3P0，至于是否要使用HikariCP，我觉得可以尝试。HikariCP毕竟是才出来不久，其性能到底如何，也需要实践的检验，若是担心新东西有坑，我推荐使用BoneCP。Spring现在也集成了HikariCP，所以我觉得很有尝试它的必要。前不久我在项目中使用了HikariCP，也没出现什么问题，运行比较稳定。</p><p>HikariCP在github上的地址：<a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="external">https://github.com/brettwooldridge/HikariCP</a></p><p><a href="http://blog.csdn.net/clementad/article/details/46928621" target="_blank" rel="external">为什么HikariCP被号称为性能最好的Java数据库连接池，如何配置使用?</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--JDBC连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="简单的CRUD"><a href="#简单的CRUD" class="headerlink" title="简单的CRUD"></a>简单的CRUD</h3><p>为保持example的干净与轻便，不使用Spring进行ORM层的管理，我采用<a href="http://www.oschina.net/question/12_10706" target="_blank" rel="external">ARM</a>的方式来管理SQL链接，在try with resource块结束后自动释放SQL链接。</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">try(ScopedContext scopedContext=<span class="keyword">new</span> ScopedContext())&#123;<span class="comment">//try with resource</span></span><br><span class="line">    DSLContext <span class="keyword">create</span>=scopedContext.getDSLContext();</span><br><span class="line">    int uid =<span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//add</span></span><br><span class="line">    UserRecord userRecord=<span class="keyword">create</span>.newRecord(USER);</span><br><span class="line">    userRecord.setAge((byte) <span class="number">18</span>);</span><br><span class="line">    userRecord.setMobile(<span class="string">"15985236985"</span>);</span><br><span class="line">    userRecord.setName(<span class="string">"赵六"</span>);</span><br><span class="line">    userRecord.setUid(uid);</span><br><span class="line">    userRecord.setSex((byte) <span class="number">1</span>);</span><br><span class="line">    userRecord.setPassword(<span class="keyword">String</span>.valueOf(<span class="keyword">System</span>.nanoTime()));</span><br><span class="line">    userRecord.setRegisterTime(<span class="keyword">new</span> Timestamp(<span class="keyword">System</span>.currentTimeMillis()));</span><br><span class="line">    int insertRet=userRecord.insert();<span class="comment">//执行insert sql</span></span><br><span class="line">    <span class="comment">//userRecord.store();//可能会执行insert，也有可能执行update，文档说明的很清晰</span></span><br><span class="line">    <span class="comment">//userRecord.refresh();//从数据库重新加载该记录</span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"insertRet:&#123;&#125;"</span>, insertRet);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//index</span></span><br><span class="line">    int createIndexRet=<span class="keyword">create</span>.createIndex(<span class="string">"user_index_mobile_unique"</span>)</span><br><span class="line">            .on(USER, USER.MOBILE)</span><br><span class="line">            .execute();<span class="comment">//为手机号码字段创建唯一索引</span></span><br><span class="line">    int dropIndexRet=<span class="keyword">create</span>.dropIndex(<span class="string">"user_index_mobile_unique"</span>)</span><br><span class="line">            .on(USER)</span><br><span class="line">            .execute();<span class="comment">//删除索引</span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"dropIndexRet:&#123;&#125;,createIndexRet:&#123;&#125;"</span>, dropIndexRet, createIndexRet);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//select</span></span><br><span class="line">    Record record=<span class="keyword">create</span>.<span class="built_in">select</span>(USER.NAME,USER.UID)</span><br><span class="line">            .from(USER)</span><br><span class="line">            .<span class="built_in">where</span>(USER.MOBILE.eq(<span class="string">"15985236985"</span>))</span><br><span class="line">            .limit(<span class="number">1</span>)</span><br><span class="line">            .fetchOne();</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"姓名:&#123;&#125;，uid:&#123;&#125;"</span>, record.getValue(USER.NAME), record.getValue(USER.UID));</span><br><span class="line"></span><br><span class="line">    Result&lt;UserRecord&gt; userRecords=<span class="keyword">create</span>.selectFrom(USER)</span><br><span class="line">            .<span class="built_in">where</span>(USER.SEX.eq((byte) <span class="number">1</span>).<span class="keyword">and</span>(USER.MOBILE.like(<span class="string">"159%"</span>)))</span><br><span class="line">            .orderBy(USER.MOBILE.asc()).limit(<span class="number">0</span>, <span class="number">20</span>).fetch();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (UserRecord ur:userRecords)&#123;</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"mobile:&#123;&#125;,uid:&#123;&#125;,registerTime:&#123;&#125;"</span>, ur.getMobile(), ur.getUid(), ur.getRegisterTime().getTime());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//delete</span></span><br><span class="line">    int deleteRecordRet=<span class="keyword">create</span>.deleteFrom(USER).<span class="built_in">where</span>(USER.UID.eq(uid)).execute();</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"deleteRecordRet:&#123;&#125;"</span>, deleteRecordRet);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">日志打印信息：</span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">20.009</span> INFO  com.zaxxer.hikari.HikariDataSource <span class="number">72</span> &lt;init&gt; - Hikari pool HikariPool<span class="number">-0</span> is starting.</span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">20.561</span> INFO  org.jooq.tools.JooqLogger <span class="number">331</span> info -</span><br><span class="line"></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>  <span class="comment">@@</span>        <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>        <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>  <span class="comment">@@</span>  <span class="comment">@@</span>    <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>  <span class="comment">@@</span><span class="comment">@@</span>  <span class="comment">@@</span>  <span class="comment">@@</span>    <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>        <span class="comment">@@</span>        <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>        <span class="comment">@@</span>        <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>    <span class="comment">@@</span>  <span class="comment">@@</span>  <span class="comment">@@</span><span class="comment">@@</span>  <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>    <span class="comment">@@</span>  <span class="comment">@@</span>  <span class="comment">@@</span><span class="comment">@@</span>  <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>        <span class="comment">@@</span>  <span class="comment">@  @</span>  <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>        <span class="comment">@@</span>        <span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@  @</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span></span><br><span class="line"><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span><span class="comment">@@</span>  Thank you <span class="keyword">for</span> using jOOQ <span class="number">3.8</span><span class="number">.2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">20.593</span> INFO  com.study.jooq.model.Example <span class="number">42</span> base - insertRet:<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">21.197</span> INFO  com.study.jooq.model.Example <span class="number">51</span> base - dropIndexRet:<span class="number">0</span>,createIndexRet:<span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">21.278</span> INFO  com.study.jooq.model.Example <span class="number">59</span> base - 姓名:赵六，uid:<span class="number">180</span></span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">21.282</span> INFO  com.study.jooq.model.Example <span class="number">66</span> base - mobile:<span class="number">15925874536</span>,uid:<span class="number">102</span>,registerTime:<span class="number">1459331629000</span></span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">21.282</span> INFO  com.study.jooq.model.Example <span class="number">66</span> base - mobile:<span class="number">15985236985</span>,uid:<span class="number">180</span>,registerTime:<span class="number">1459429281000</span></span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">21.285</span> INFO  com.study.jooq.model.Example <span class="number">71</span> base - deleteRecordRet:<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">21.285</span> INFO  com.zaxxer.hikari.pool.HikariPool <span class="number">242</span> shutdown - Hikari pool HikariPool<span class="number">-0</span> is shutting down.</span><br><span class="line"><span class="number">21</span>:<span class="number">01</span>:<span class="number">21.331</span> INFO  com.zaxxer.hikari.util.ConcurrentBag <span class="number">197</span> add - ConcurrentBag has been closed, ignoring add()</span><br></pre></td></tr></table></figure><h2 id="进阶篇"><a href="#进阶篇" class="headerlink" title="进阶篇"></a>进阶篇</h2><h3 id="连接查询"><a href="#连接查询" class="headerlink" title="连接查询"></a>连接查询</h3><p>在处理复杂SQL时，JOOQ的思路是由Java代码以<a href="http://www.jianshu.com/p/540711c1a507" target="_blank" rel="external">链式编程</a>的方式来解决可读性的问题。完全按照SQL语法来链式调用，简单到可怕！从未有过类似的API？</p><p>下文代码构建出的查询SQL，等价于：</p><p>SELECT<br><code>study</code>.<code>user</code>.<code>mobile</code>,<br><code>study</code>.<code>user</code>.<code>name</code>,<br><code>study</code>.<code>user</code>.<code>age</code>,<br><code>study</code>.<code>order</code>.<code>order_id</code>,<br><code>study</code>.<code>order</code>.<code>amout</code>,<br><code>study</code>.<code>order</code>.<code>order_time</code><br>FROM<br><code>study</code>.<code>user</code><br>LEFT OUTER JOIN <code>study</code>.<code>order</code> ON <code>study</code>.<code>user</code>.<code>uid</code> = <code>study</code>.<code>order</code>.<code>uid</code><br>WHERE<br>(<br><code>study</code>.<code>user</code>.<code>uid</code> = 15874523<br>AND <code>study</code>.<code>order</code>.<code>amout</code> &gt;= 1001<br>)<br>LIMIT 10</p><p>可以发现SQL语句与代码保持了很高的相似性，可读性几乎没有损失。</p><p>其他的特性：group by与having、union、union all也都是在api级别支持的。<br></p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">try(ScopedContext scopedContext=<span class="literal">new</span> ScopedContext())&#123;<span class="comment">//try with resource</span></span><br><span class="line">    DSLContext create=scopedContext.getDSLContext();</span><br><span class="line">    int uid=<span class="number">15874523</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//join select</span></span><br><span class="line"></span><br><span class="line">    Result&lt;Record6&lt;<span class="built_in">String</span>,<span class="built_in">String</span>,Byte,<span class="built_in">Integer</span>,Long,Timestamp&gt;&gt; results=create</span><br><span class="line">            .<span class="keyword">select</span>(USER.MOBILE,USER.NAME,USER.AGE,<span class="keyword">ORDER</span>.ORDER_ID,<span class="keyword">ORDER</span>.AMOUT,<span class="keyword">ORDER</span>.ORDER_TIME)</span><br><span class="line">            .from(USER).leftOuterJoin(<span class="keyword">ORDER</span>)</span><br><span class="line">            .<span class="keyword">on</span>(USER.UID.<span class="literal">eq</span>(<span class="keyword">ORDER</span>.UID))</span><br><span class="line">            .<span class="keyword">where</span>(USER.UID.<span class="literal">eq</span>(uid).<span class="keyword">and</span>(<span class="keyword">ORDER</span>.AMOUT.ge(<span class="number">100</span>l)))</span><br><span class="line">            .limit(<span class="number">0</span>,<span class="number">10</span>).fetch();</span><br><span class="line">    for (Record6&lt;<span class="built_in">String</span>,<span class="built_in">String</span>,Byte,<span class="built_in">Integer</span>,Long,Timestamp&gt; record:results)&#123;</span><br><span class="line">        <span class="keyword">log</span>.info(<span class="string">"姓名:&#123;&#125;，手机号码:&#123;&#125;，年龄:&#123;&#125;，订单号:&#123;&#125;，订单金额:&#123;&#125;，订单时间:&#123;&#125;"</span>,</span><br><span class="line">        record.getValue(USER.NAME),record.getValue(USER.MOBILE),record.getValue(USER.AGE),</span><br><span class="line">        record.getValue(<span class="keyword">ORDER</span>.ORDER_ID),record.getValue(<span class="keyword">ORDER</span>.AMOUT),</span><br><span class="line">        record.getValue(<span class="keyword">ORDER</span>.ORDER_TIME));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>:<span class="number">51</span>:<span class="number">14.898</span> INFO  com.study.jooq.model.Example <span class="number">110</span> advance - 姓名:赵六，手机号码:<span class="number">18525874539</span>，年龄:<span class="number">18</span>，订单号:<span class="number">-1725080559</span>，订单金额:<span class="number">25000</span>，订单时间:<span class="number">1459486275000</span></span><br></pre></td></tr></table></figure><p></p><h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h3><p>子查询API的使用稍显麻烦，对于内层table，如果在外层需要参与使用， alias需要在内层构建是指定。并且在外层使用时，也无法显式指定字段名，需要按照field的index值进行指定。</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">try (ScopedContext scopedContext = new ScopedContext()) &#123;//try with resource</span><br><span class="line">    DSLContext create = scopedContext.getDSLContext()<span class="comment">;</span></span><br><span class="line">    //查询指定多个用户的最新一个订单信息</span><br><span class="line">    Set&lt;Integer&gt; uids=new HashSet&lt;&gt;()<span class="comment">;</span></span><br><span class="line">    uids.add(<span class="number">10001</span>)<span class="comment">;</span></span><br><span class="line">    uids.add(<span class="number">10002</span>)<span class="comment">;</span></span><br><span class="line">    uids.add(<span class="number">10003</span>)<span class="comment">;</span></span><br><span class="line">    //构建内层查询语句</span><br><span class="line">    Table&lt;OrderRecord&gt; subTable = create.selectFrom(ORDER).</span><br><span class="line">            where(ORDER.UID.in(uids)).</span><br><span class="line">            orderBy(ORDER.ORDER_TIME.desc()).</span><br><span class="line">            asTable(<span class="string">"A"</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    Result&lt;OrderRecord&gt; oreders = create.selectFrom(subTable).</span><br><span class="line">            groupBy(subTable.field(<span class="number">0</span>), subTable.field(<span class="number">1</span>)).//按照第一个、第二个字段进行group by</span><br><span class="line">            fetch()<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">构建完成的SQL语句：</span><br><span class="line">SELECT</span><br><span class="line">    `A`.`order_id`,</span><br><span class="line">    `A`.`uid`,</span><br><span class="line">    `A`.`amout`,</span><br><span class="line">    `A`.`status`,</span><br><span class="line">    `A`.`order_time`</span><br><span class="line">FROM</span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">            `study`.`order`.`order_id`,</span><br><span class="line">            `study`.`order`.`uid`,</span><br><span class="line">            `study`.`order`.`amout`,</span><br><span class="line">            `study`.`order`.`status`,</span><br><span class="line">            `study`.`order`.`order_time`</span><br><span class="line">        FROM</span><br><span class="line">            `study`.`order`</span><br><span class="line">        WHERE</span><br><span class="line">            `study`.`order`.`uid` IN (<span class="number">10001</span>, <span class="number">10002</span>, <span class="number">10003</span>)</span><br><span class="line">        ORDER BY</span><br><span class="line">            `study`.`order`.`order_time` DESC</span><br><span class="line">    ) AS `A`</span><br><span class="line">GROUP BY</span><br><span class="line">    `A`.`order_id`,</span><br><span class="line">    `A`.`uid`;</span><br></pre></td></tr></table></figure><h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p>JOOQ目前并不支持类似Spring的声明式事务管理，暂时只支持由自身API提供的编程式事务管理。有关声明式事务管理与编程式事务管理的区别，请Follow：<a href="http://blog.csdn.net/u012228718/article/details/42750119#t1" target="_blank" rel="external">编程式事务与声明式事务</a>。但JOOQ作者Lukas Eder明确表示在未来的3.9版本中，会提供解决方案。</p><ul><li><p><a href="http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/" target="_blank" rel="external">http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/</a></p></li><li><p><a href="https://github.com/jOOQ/jOOQ/issues/4836" target="_blank" rel="external">https://github.com/jOOQ/jOOQ/issues/4836</a></p></li></ul><figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">try(ScopedContext scopedContext=new ScopedContext())&#123;<span class="comment">//try with resource</span></span><br><span class="line">    DSLContext create=scopedContext.getDSLContext()<span class="comment">;</span></span><br><span class="line">    final <span class="keyword">int</span>[] uid = new <span class="keyword">int</span>[<span class="number">1</span>]<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//transaction</span></span><br><span class="line"></span><br><span class="line">    create.transaction(configuration -&gt; &#123;</span><br><span class="line">        <span class="comment">//add</span></span><br><span class="line">        UserRecord userRecord=create.newRecord(USER)<span class="comment">;</span></span><br><span class="line">        userRecord.setAge((byte) <span class="number">18</span>)<span class="comment">;</span></span><br><span class="line">        userRecord.setMobile(<span class="string">"18525874539"</span>)<span class="comment">;</span></span><br><span class="line">        userRecord.setName(<span class="string">"赵六"</span>)<span class="comment">;</span></span><br><span class="line">        userRecord.setSex((byte) <span class="number">1</span>)<span class="comment">;</span></span><br><span class="line">        userRecord.setPassword(String.valueOf(<span class="keyword">System</span>.nanoTime()))<span class="comment">;</span></span><br><span class="line">        userRecord.setRegisterTime(new Timestamp(<span class="keyword">System</span>.currentTimeMillis()))<span class="comment">;</span></span><br><span class="line">        <span class="keyword">int</span> insertUserRet=userRecord.insert()<span class="comment">;//执行insert sql</span></span><br><span class="line">        uid[<span class="number">0</span>] =userRecord.getUid()<span class="comment">;</span></span><br><span class="line">        log.info(<span class="string">"insertUserRet:&#123;&#125;"</span>, insertUserRet)<span class="comment">;</span></span><br><span class="line">        <span class="comment">//add</span></span><br><span class="line">        OrderRecord orderRecord=create.newRecord(ORDER)<span class="comment">;</span></span><br><span class="line">        orderRecord.setUid(userRecord.getUid())<span class="comment">;</span></span><br><span class="line">        orderRecord.setAmout(<span class="number">25000</span>l)<span class="comment">;</span></span><br><span class="line">        orderRecord.setOrderId(new BigDecimal(<span class="keyword">System</span>.nanoTime()).intValue())<span class="comment">;</span></span><br><span class="line">        orderRecord.setOrderTime(new Timestamp(<span class="keyword">System</span>.currentTimeMillis()))<span class="comment">;</span></span><br><span class="line">        orderRecord.setStatus((byte)<span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">int</span> insertOrderRet=orderRecord.insert()<span class="comment">;//执行insert sql</span></span><br><span class="line">        log.info(<span class="string">"insertOrderRet:&#123;&#125;"</span>, insertOrderRet)<span class="comment">;</span></span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>:<span class="number">51</span>:<span class="number">14.724</span> INFO  com.study.jooq.model.Example <span class="number">90</span> lambda$advance$<span class="number">0</span> - insertUserRet:<span class="number">1</span></span><br><span class="line"><span class="number">12</span>:<span class="number">51</span>:<span class="number">14.743</span> INFO  com.study.jooq.model.Example <span class="number">99</span> lambda$advance$<span class="number">0</span> - insertOrderRet:<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a>批处理</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">//batchInsert</span><br><span class="line">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class="line">    DSLContext create=scopedContext.getDSLContext();</span><br><span class="line">    List<span class="variable">&lt;UserRecord&gt;</span> list=new ArrayList<span class="variable">&lt;&gt;</span>();</span><br><span class="line"></span><br><span class="line">     //batchInsert</span><br><span class="line">    UserRecord <span class="keyword">user</span>Record=create.newRecord(USER);</span><br><span class="line">    <span class="keyword">user</span>Record.<span class="built_in">set</span>Age((byte) <span class="number">18</span>);</span><br><span class="line">    <span class="keyword">user</span>Record.<span class="built_in">set</span>Mobile(<span class="string">"17058963215"</span>);</span><br><span class="line">    <span class="keyword">user</span>Record.<span class="built_in">set</span>Name(<span class="string">"赵六"</span>);</span><br><span class="line">    <span class="keyword">user</span>Record.<span class="built_in">set</span>Sex((byte) <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">user</span>Record.<span class="built_in">set</span>Password(String.valueOf(System.nanoTime()));</span><br><span class="line">    <span class="keyword">user</span>Record.<span class="built_in">set</span>RegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class="line">    list.add(<span class="keyword">user</span>Record);</span><br><span class="line"></span><br><span class="line">    UserRecord <span class="keyword">user</span>Record2=create.newRecord(USER);</span><br><span class="line">    <span class="keyword">user</span>Record2.<span class="built_in">set</span>Age((byte) <span class="number">29</span>);</span><br><span class="line">    <span class="keyword">user</span>Record2.<span class="built_in">set</span>Mobile(<span class="string">"17058963216"</span>);</span><br><span class="line">    <span class="keyword">user</span>Record2.<span class="built_in">set</span>Name(<span class="string">"马七"</span>);</span><br><span class="line">    <span class="keyword">user</span>Record2.<span class="built_in">set</span>Sex((byte) <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">user</span>Record2.<span class="built_in">set</span>Password(String.valueOf(System.nanoTime()));</span><br><span class="line">    <span class="keyword">user</span>Record2.<span class="built_in">set</span>RegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class="line">    list.add(<span class="keyword">user</span>Record2);</span><br><span class="line">    //使用batchInsert时，无法获取SQL语句</span><br><span class="line">    int insertRetArr[]=create.batchInsert(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class="line"></span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"insertRetArr:&#123;&#125;"</span>, Arrays.<span class="keyword">to</span>String(insertRetArr));//数组每个元素为<span class="number">1</span>时，执行成功</span><br><span class="line">    //使用batchInsert时，无法获取数据自增长的主键值</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"userRecord:uid:&#123;&#125;"</span>, <span class="keyword">user</span>Record.getUid());</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"userRecord2:uid:&#123;&#125;"</span>, <span class="keyword">user</span>Record2.getUid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">user</span>Record.refresh();</span><br><span class="line">    <span class="keyword">user</span>Record2.refresh();</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"userRecord:uid:&#123;&#125;"</span>, <span class="keyword">user</span>Record.getUid());</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"userRecord2:uid:&#123;&#125;"</span>, <span class="keyword">user</span>Record2.getUid());</span><br><span class="line"></span><br><span class="line">    //batchUpdate</span><br><span class="line">    <span class="keyword">user</span>Record.<span class="built_in">set</span>Age((byte) <span class="number">38</span>);</span><br><span class="line">    <span class="keyword">user</span>Record2.<span class="built_in">set</span>Age((byte) <span class="number">78</span>);</span><br><span class="line">    list.clear();</span><br><span class="line">    list.add(<span class="keyword">user</span>Record);</span><br><span class="line">    list.add(<span class="keyword">user</span>Record2);</span><br><span class="line">    //使用batchUpdate时，无法获取SQL语句</span><br><span class="line">    int updateRetArr[]=create.batchUpdate(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"updateRetArr:&#123;&#125;"</span>, Arrays.<span class="keyword">to</span>String(updateRetArr));//数组每个元素为<span class="number">1</span>时，执行成功</span><br><span class="line"></span><br><span class="line">    //batchDelete</span><br><span class="line">    //使用batchDelete时，无法获取SQL语句</span><br><span class="line">    int deleteRetArr[]=create.batchDelete(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"deleteRetArr:&#123;&#125;"</span>, Arrays.<span class="keyword">to</span>String(deleteRetArr));//数组每个元素为<span class="number">1</span>时，执行成功</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">06</span>:<span class="number">46.281</span> INFO  com.study.jooq.model.Example <span class="number">163</span> batch - insertRetArr:[<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line"><span class="number">15</span>:<span class="number">06</span>:<span class="number">46.281</span> INFO  com.study.jooq.model.Example <span class="number">165</span> batch - <span class="keyword">user</span>Record:uid:null</span><br><span class="line"><span class="number">15</span>:<span class="number">06</span>:<span class="number">46.281</span> INFO  com.study.jooq.model.Example <span class="number">166</span> batch - <span class="keyword">user</span>Record2:uid:null</span><br><span class="line"><span class="number">15</span>:<span class="number">06</span>:<span class="number">46.287</span> INFO  com.study.jooq.model.Example <span class="number">176</span> batch - updateRetArr:[<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"><span class="number">15</span>:<span class="number">06</span>:<span class="number">46.291</span> INFO  com.study.jooq.model.Example <span class="number">182</span> batch - deleteRetArr:[<span class="number">0</span>, <span class="number">0</span>]</span><br></pre></td></tr></table></figure><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>对RDBMS内置函数，JOOQ提供了API进行调用，但JOOQ没有提供API对自定义函数进行显式的支持，这意味着不能通过JOOQ进行自定义函数的create/execute/drop。但是JOOQ支持直接执行拼接好的字符串SQL语句，这为我们进行函数execute提供了可行性。实际使用中，使用ORM层对数据库函数进行create/drop的需求几乎不存在。</p><h4 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">求平均数avg()</span><br><span class="line"></span><br><span class="line">Record record = create.select(USER.AGE.avg()).<span class="keyword">from</span>(USER).fetchOne();<span class="comment">//求用户的平均年龄</span></span><br><span class="line"><span class="keyword">if</span> (record != <span class="keyword">null</span>) &#123;</span><br><span class="line">    log.info(<span class="string">"平均年龄是:"</span> + record.<span class="keyword">into</span>(<span class="keyword">Double</span>.<span class="keyword">class</span>).toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h4><p>在Mysql中添加自定义函数，你也可以使用Flyway的方式来做，在migration文件夹下加一个V2 sql文件。重新执行maven-install即可生效，实际上我更推荐使用这种方式来进行数据库历史SQL执行管理。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="title">study</span>;</span><br><span class="line">DROP <span class="function"><span class="keyword">FUNCTION</span> <span class="title">IF</span> <span class="title">EXISTS</span> <span class="title">formatDate</span></span>;</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="comment">//</span></span><br><span class="line">CREATE <span class="function"><span class="keyword">FUNCTION</span> <span class="title">formatDate</span><span class="params">(fdate datetime)</span></span><br><span class="line"><span class="title">RETURNS</span> <span class="title">VARCHAR</span><span class="params">(<span class="number">255</span>)</span></span><br><span class="line"><span class="title">RETURN</span> <span class="title">date_format</span><span class="params">(fdate,<span class="string">'%Y年%m月%d日%h时%i分%s秒'</span>)</span></span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">SELECT formatDate(NOW()) <span class="keyword">AS</span> <span class="string">'时间'</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 使用JOOQ进行函数execute</span><br><span class="line"><span class="keyword">try</span>(ScopedContext scopedContext=<span class="keyword">new</span> ScopedContext())&#123;<span class="comment">//try with resource</span></span><br><span class="line">    DSLContext create=scopedContext.getDSLContext();</span><br><span class="line">    <span class="comment">//formatDate是我们在mysql里自定义的函数</span></span><br><span class="line">    Result&lt;Record&gt; results=create.fetch(<span class="string">"SELECT formatDate(NOW()) AS '时间';"</span>);</span><br><span class="line">    <span class="keyword">for</span> (Record record:results)&#123;</span><br><span class="line">        log.info(<span class="string">"执行结果:&#123;&#125;"</span>,record.getValue(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">54</span>:<span class="number">28.815</span> INFO  com.study.jooq.model.Example <span class="number">199</span> <span class="function"><span class="keyword">function</span> - 执行结果:2016年04月01日03时54分28秒</span></span><br></pre></td></tr></table></figure><h3 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h3><p>存储过程同函数一样，没有进行显式的create/drop支持。<br></p><figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. 先在Mysql中添加存储过程</span><br><span class="line">USE study;</span><br><span class="line">DROP <span class="function"><span class="keyword">PROCEDURE</span> <span class="title">IF</span> <span class="title">EXISTS</span> <span class="title">getAllUid</span>;</span></span><br><span class="line"></span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE <span class="function"><span class="keyword">PROCEDURE</span> <span class="title">getAllUid</span><span class="params">()</span></span><br><span class="line"><span class="title">BEGIN</span></span><br><span class="line">  <span class="title">SELECT</span> <span class="title">uid</span> <span class="title">FROM</span> <span class="title">user</span>;</span></span><br><span class="line"><span class="keyword">END</span>//</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">CALL getAllUid();</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. 使用JOOQ进行存储过程execute</span><br><span class="line">try(ScopedContext scopedContext=new ScopedContext())&#123;//try <span class="keyword">with</span> resource</span><br><span class="line">    DSLContext create=scopedContext.getDSLContext();</span><br><span class="line">    //getAllUid是我们在mysql里定义的存储过程</span><br><span class="line">    Result&lt;Record&gt; results=create.fetch(<span class="string">"CALL getAllUid()"</span>);</span><br><span class="line">    <span class="keyword">for</span> (Record record:results)&#123;</span><br><span class="line">        log.info(<span class="string">"执行结果:&#123;&#125;"</span>,record.getValue(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">16</span>:<span class="number">08</span>:<span class="number">19.333</span> INFO  com.study.jooq.model.Example <span class="number">211</span> <span class="function"><span class="keyword">procedure</span> - 执行结果:</span><span class="number">100</span></span><br><span class="line"><span class="number">16</span>:<span class="number">08</span>:<span class="number">19.333</span> INFO  com.study.jooq.model.Example <span class="number">211</span> <span class="function"><span class="keyword">procedure</span> - 执行结果:</span><span class="number">102</span></span><br><span class="line"><span class="number">16</span>:<span class="number">08</span>:<span class="number">19.334</span> INFO  com.study.jooq.model.Example <span class="number">211</span> <span class="function"><span class="keyword">procedure</span> - 执行结果:</span><span class="number">101</span></span><br></pre></td></tr></table></figure><p></p><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>通过代码构建视图后，JOOQ不能自动生成视图对应的实体类，需要手工做一次maven -install。以下示例中会生成类文件：Userwithorder.java<br></p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">try(ScopedContext scopedContext=<span class="literal">new</span> ScopedContext())&#123;<span class="comment">//try with resource</span></span><br><span class="line">    DSLContext create=scopedContext.getDSLContext();</span><br><span class="line">    <span class="comment">//创建视图</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义视图名称为：userwithorder</span></span><br><span class="line">    CreateViewFinalStep step=create.createView(<span class="string">"userwithorder"</span>,USER.UID.getName(),USER.NAME.getName(),<span class="keyword">ORDER</span>.ORDER_ID.getName(),<span class="keyword">ORDER</span>.STATUS.getName(),<span class="keyword">ORDER</span>.AMOUT.getName())</span><br><span class="line">            .as(</span><br><span class="line">                    create.<span class="keyword">select</span>(USER.UID, USER.NAME, <span class="keyword">ORDER</span>.ORDER_ID, <span class="keyword">ORDER</span>.STATUS, <span class="keyword">ORDER</span>.AMOUT)</span><br><span class="line">                            .from(USER)</span><br><span class="line">                            .leftOuterJoin(<span class="keyword">ORDER</span>)</span><br><span class="line">                            .<span class="keyword">on</span>(USER.UID.<span class="literal">eq</span>(<span class="keyword">ORDER</span>.UID))</span><br><span class="line">            );</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"SQL:&#123;&#125;"</span>,step.getSQL());</span><br><span class="line">    int ret=step.execute();</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"创建视图,执行结果:&#123;&#125;"</span>,ret);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询视图</span></span><br><span class="line">    Result&lt;Record3&lt;<span class="built_in">Integer</span>,<span class="built_in">String</span>,<span class="built_in">Integer</span>&gt;&gt; results=create.<span class="keyword">select</span>(USERWITHORDER.UID,USERWITHORDER.NAME,USERWITHORDER.ORDER_ID)</span><br><span class="line">            .from(USERWITHORDER).<span class="keyword">where</span>(USERWITHORDER.AMOUT.ge(<span class="number">200</span>l)).fetch();</span><br><span class="line">    for (Record3&lt;<span class="built_in">Integer</span>,<span class="built_in">String</span>,<span class="built_in">Integer</span>&gt; record:results)&#123;</span><br><span class="line">        <span class="keyword">log</span>.info(<span class="string">"uid:&#123;&#125;，姓名:&#123;&#125;，订单号:&#123;&#125;"</span>,</span><br><span class="line">                record.getValue(USERWITHORDER.UID),record.getValue(USERWITHORDER.NAME),record.getValue(USERWITHORDER.ORDER_ID));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删除视图</span></span><br><span class="line">    int dropRet=create.dropView(<span class="string">"userwithorder"</span>).execute();</span><br><span class="line">    <span class="keyword">log</span>.info(<span class="string">"删除视图,执行结果:&#123;&#125;"</span>,dropRet);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">10.597</span> INFO  com.study.jooq.model.Example <span class="number">231</span> view - SQL:create view <span class="string">`userwithorder`</span>(<span class="string">`uid`</span>, <span class="string">`name`</span>, <span class="string">`order_id`</span>, <span class="string">`status`</span>, <span class="string">`amout`</span>) as <span class="keyword">select</span> <span class="string">`study`</span>.<span class="string">`user`</span>.<span class="string">`uid`</span>, <span class="string">`study`</span>.<span class="string">`user`</span>.<span class="string">`name`</span>, <span class="string">`study`</span>.<span class="string">`order`</span>.<span class="string">`order_id`</span>, <span class="string">`study`</span>.<span class="string">`order`</span>.<span class="string">`status`</span>, <span class="string">`study`</span>.<span class="string">`order`</span>.<span class="string">`amout`</span> from <span class="string">`study`</span>.<span class="string">`user`</span> left outer <span class="keyword">join</span> <span class="string">`study`</span>.<span class="string">`order`</span> <span class="keyword">on</span> <span class="string">`study`</span>.<span class="string">`user`</span>.<span class="string">`uid`</span> = <span class="string">`study`</span>.<span class="string">`order`</span>.<span class="string">`uid`</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">10.712</span> INFO  com.study.jooq.model.Example <span class="number">233</span> view - 创建视图,执行结果:<span class="number">0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">10.760</span> INFO  com.study.jooq.model.Example <span class="number">239</span> view - uid:<span class="number">100</span>，姓名:张三，订单号:<span class="number">200</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">10.761</span> INFO  com.study.jooq.model.Example <span class="number">239</span> view - uid:<span class="number">100</span>，姓名:张三，订单号:<span class="number">201</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">10.761</span> INFO  com.study.jooq.model.Example <span class="number">239</span> view - uid:<span class="number">101</span>，姓名:李四，订单号:<span class="number">202</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">10.765</span> INFO  com.study.jooq.model.Example <span class="number">244</span> view - 删除视图,执行结果:<span class="number">0</span></span><br></pre></td></tr></table></figure><p></p><h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p>有时候可能需要在SQL中，对字段(或字段之间)进行加减乘除等运算操作。</p><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">需求示例，在箱子规格表(不重复)中，找出前十条，按照箱子的容积的最大值(<span class="built_in">int</span> <span class="number">11</span>)与最小值(<span class="built_in">int</span> <span class="number">11</span>)范围，与给定值(<span class="number">528</span>)进行比较排序，找出最接近的十条。</span><br><span class="line">select * <span class="keyword">from</span> box</span><br><span class="line">    where min_size&lt;=<span class="number">528</span> <span class="keyword">and</span> max_size&gt;=<span class="number">528</span></span><br><span class="line">    order by ((min_size+max_size)/<span class="number">2</span>)-<span class="number">528</span> asc</span><br><span class="line">    limit <span class="number">0</span>,<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">使用<span class="type">JOOQ</span>完全可以满足这样的要求</span><br><span class="line"><span class="keyword">try</span>(<span class="type">ScopedContext</span> scopedContext=new <span class="type">ScopedContext</span>())&#123;//<span class="keyword">try</span> <span class="keyword">with</span> resource</span><br><span class="line">    <span class="type">DSLContext</span> create=scopedContext.getDSLContext();</span><br><span class="line">    <span class="built_in">int</span> conditionSize=<span class="number">528</span>;</span><br><span class="line">    <span class="built_in">int</span> pageNo=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">int</span> pageSize=<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">SortField</span> sortFieldBySize = ((((<span class="type">BOX</span>.<span class="type">MAX_SIZE</span>.add(<span class="type">BOX</span>.<span class="type">MIN_SIZE</span>)).divide(<span class="number">2</span>)).</span><br><span class="line">    minus(conditionSize)).asc();</span><br><span class="line"></span><br><span class="line">    <span class="type">Result</span> <span class="literal">result</span>=create.selectFrom(<span class="type">BOX</span>).</span><br><span class="line">    where(<span class="type">BOX</span>.<span class="type">MIN_SIZE</span>.lessOrEqual(conditionSize)).</span><br><span class="line">    <span class="keyword">and</span>(<span class="type">BOX</span>.<span class="type">MAX_SIZE</span>.greaterOrEqual(conditionSize)).</span><br><span class="line">    orderBy(sortFieldBySize).</span><br><span class="line">    limit((pageNo-<span class="number">1</span>) * pageSize, pageSize).</span><br><span class="line">    fetch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="高级篇"><a href="#高级篇" class="headerlink" title="高级篇"></a>高级篇</h2><p>这部分面向于对JOOQ保持更多热情的读者，谈到JOOQ的高阶特性，这些特性在企业级开发中往往会用的很多，但对于个人开发者可能就没那么重要了。因此个人开发者可以选择性的阅读。</p><p>推荐企业在大面积应用JOOQ之前详细阅读这部分的内容，以更好的在生产环境稳定使用。</p><h3 id="重复使用Statement"><a href="#重复使用Statement" class="headerlink" title="重复使用Statement"></a>重复使用Statement</h3><p>数据库系统对SQL语句的处理一般会经过如下过程。</p><ul><li>1.查询解析器（Query parser）：用于检查查询是否合法</li><li>2.查询重写器（Query rewriter）：用于预优化查询</li><li>3.查询优化器（Query optimizer）：用于优化查询</li><li>4.查询执行器（Query executor）：用于编译和执行查询</li></ul><p>PreparedStatement是java.sql包下面的一个接口，用来执行SQL语句查询，通过调用connection.preparedStatement(sql)方法可以获得PreparedStatment对象。数据库系统会对sql语句进行预编译处理（如果JDBC驱动支持的话），预处理语句将被预先编译好，这条预编译的sql查询语句能在将来的查询中重用，这样一来，它比Statement对象生成的查询速度更快。</p><p>对比以上4条处理过程，复用的PreparedStatement对象，将直接跳过3.5步（最后一步的编译部分也跳过啦），直接被数据库执行，对于复杂并且高频率执行的SQL，这将极大的提高TPS！</p><p>在JDBC中如何做？</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取PreparedStatement对象，此时数据库已经将String类型的SQL预编译过了。</span></span><br><span class="line"><span class="selector-tag">try</span> (PreparedStatement stmt = connection.prepareStatement(<span class="string">"SELECT 1 FROM DUAL"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一次使用，获取结果集</span></span><br><span class="line">    <span class="selector-tag">try</span> (ResultSet rs1 = stmt.executeQuery()) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不关闭，再次使用，获取结果集（此时结果集可能发生了变化）</span></span><br><span class="line">    <span class="selector-tag">try</span> (ResultSet rs2 = stmt.executeQuery()) &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在JOOQ中如何做？</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重复使用Statement</span></span><br><span class="line">try (ScopedContext scopedContext = <span class="literal">new</span> ScopedContext()) &#123;<span class="comment">//try with resource</span></span><br><span class="line">    DSLContext create = scopedContext.getDSLContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个被配置保持打开的Statement</span></span><br><span class="line">    try (ResultQuery&lt;Record1&lt;<span class="built_in">Integer</span>&gt;&gt; query = create.selectOne().keepStatement(<span class="literal">true</span>)) &#123;</span><br><span class="line">        Result&lt;Record1&lt;<span class="built_in">Integer</span>&gt;&gt; result1 = query.fetch(); <span class="comment">// This will lazily create a new PreparedStatement</span></span><br><span class="line">        <span class="keyword">log</span>.info(<span class="string">"result1:"</span> + result1.toString());</span><br><span class="line">        Result&lt;Record1&lt;<span class="built_in">Integer</span>&gt;&gt; result2 = query.fetch(); <span class="comment">// This will reuse the previous PreparedStatement</span></span><br><span class="line">        <span class="keyword">log</span>.info(<span class="string">"result2:"</span> + result2.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="draft-With-Ehcache"><a href="#draft-With-Ehcache" class="headerlink" title="[draft] With Ehcache"></a>[draft] With Ehcache</h3><p>未完成。</p><p>讨论JOOQ与Ehcache等进程级别缓存模块的集成，引申地，会谈到中间件级别的数据库缓存，如：Redis。</p><h3 id="draft-钩子函数：DefaultRecordListener-如何使用？"><a href="#draft-钩子函数：DefaultRecordListener-如何使用？" class="headerlink" title="[draft] 钩子函数：DefaultRecordListener 如何使用？"></a>[draft] 钩子函数：DefaultRecordListener 如何使用？</h3><p>未完成。</p><p>讨论JOOQ重要特性：DefaultRecordListener(简称Listener)。</p><p>Listener的应用场景，数据库操作完成后同步回调。</p><p>示例需求：简书网站，完成MySQL插入或更新文章后，需要在搜索接口(Solr)中半实时的查询到最新文章。</p><p>分析：强一致性需求，在MySQL和搜索引擎同时操作成功，才算一个事务成功。</p><p>使用JOOQ获取MySQL数据库链接时，注册Listener，指向更新Solr的业务逻辑。</p><h3 id="draft-更快的分页-seek"><a href="#draft-更快的分页-seek" class="headerlink" title="[draft] 更快的分页(seek)"></a>[draft] 更快的分页(seek)</h3><p>未完成。</p><p>Seek方法本来就没有跳过OFFSET之前的记录，它跳过的是所有以前获取到的最后一条记录之前的记录。考虑一下谷歌的翻页。从实用角度看的话，你几乎不可能准确地跳过100’000行记录。</p><h2 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h2><h3 id="获取SQL语句"><a href="#获取SQL语句" class="headerlink" title="获取SQL语句"></a>获取SQL语句</h3><p>JOOQ允许在执行(fetch*、excute)前的SQL构建阶段，获取任一阶段的文本SQL语句。<br></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//<span class="number">2</span>张表完成左外连接构建阶段后的Step</span><br><span class="line">SelectForUpdateStep sfus=create</span><br><span class="line">        .select(USER.MOBILE, USER.NAME, USER.AGE, ORDER.ORDER_ID, ORDER.AMOUT, ORDER.ORDER_TIME)</span><br><span class="line">        .from(USER).leftOuterJoin(ORDER)</span><br><span class="line">        .on(USER.UID.eq(ORDER.UID))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">//<span class="number">2</span>张表查询语句构建结束后的Step</span><br><span class="line">SelectForUpdateStep sfus1=create</span><br><span class="line">        .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)</span><br><span class="line">        .from(USER).leftOuterJoin(ORDER)</span><br><span class="line">        .on(USER.UID.eq(ORDER.UID))</span><br><span class="line">        .where(USER.UID.eq(uid[<span class="number">0</span>]).<span class="literal">and</span>(ORDER.AMOUT.ge(<span class="number">100</span>l)))</span><br><span class="line">        .limit(<span class="number">0</span>, <span class="number">10</span>)<span class="comment">;</span></span><br><span class="line">log.info(<span class="string">"s:"</span> + sfus.getSQL())<span class="comment">;</span></span><br><span class="line">log.info(<span class="string">"s1:"</span> + sfus.getSQL())<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="number">14</span>:<span class="number">23</span>:<span class="number">05.305</span> INFO  com.study.jooq.model.Example <span class="number">123</span> advance - s:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`</span><br><span class="line"></span><br><span class="line"><span class="number">14</span>:<span class="number">23</span>:<span class="number">05.306</span> INFO  com.study.jooq.model.Example <span class="number">124</span> advance - s1:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid</span><br></pre></td></tr></table></figure><p></p><h2 id="Some-else"><a href="#Some-else" class="headerlink" title="Some else"></a>Some else</h2><h3 id="JPA与JDBC有什么区别？"><a href="#JPA与JDBC有什么区别？" class="headerlink" title="JPA与JDBC有什么区别？"></a>JPA与JDBC有什么区别？</h3><ul><li>JDBC：Java Data Base Connectivity，java数据库连接，用于直接调用SQL 命令，也就是用于执行SQL语句的Java API，是面向数据库的。</li><li>JPA：Java Persistence API，Java持久性API，用来操作实体对象，持久性提供了很多实现，编程人员只需要编写实体类，实体类中的主要信息为实体与数据库中表、字段、主键的对应，可以免除编写繁琐的SQL。</li></ul><h3 id="JOOQ与JDBC的详细区别"><a href="#JOOQ与JDBC的详细区别" class="headerlink" title="JOOQ与JDBC的详细区别"></a>JOOQ与JDBC的详细区别</h3><ul><li><a href="http://www.jooq.org/doc/3.8/manual/sql-execution/comparison-with-jdbc/" target="_blank" rel="external">Comparison between jOOQ and JDBC</a></li></ul><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="http://blog.jobbole.com/100349/" target="_blank" rel="external">如果有人问你数据库的原理，叫他看这篇文章</a></li></ul></div><div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>Talk is cheap，show me the code.</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/rewards/wechat-reward-image.png" alt="Steven Cheng WeChat Pay"><p>微信打赏</p></div></div></div></div><footer class="post-footer"><div class="copyright" style="clear:both"><p><span>本文标题：</span><a href="/post/2016/04/JOOQ-from-entry-to-improve/">JOOQ 3.8.2 使用 教程：从入门到提高</a></p><p><span>文章作者：</span><a href="/" title="访问 Steven Cheng 的个人博客">Steven Cheng</a></p><p><span>发布时间：</span>2016年4月1日 - 17时04分</p><p><span>本文字数：</span><span class="page-count">17,934字</span></p><p><span>原始链接：</span><a href="/post/2016/04/JOOQ-from-entry-to-improve/" title="JOOQ 3.8.2 使用 教程：从入门到提高">http://amao12580.github.io/post/2016/04/JOOQ-from-entry-to-improve/</a></p><p><span>许可协议：</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" title="Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)">Attribution-NonCommercial 4.0</a></p><p><span>转载请保留以上信息。</span></p></div><div class="post-tags"><a href="/tags/JOOQ/" rel="tag">#JOOQ</a> <a href="/tags/SQL/" rel="tag">#SQL</a> <a href="/tags/ARM/" rel="tag">#ARM</a> <a href="/tags/ORM/" rel="tag">#ORM</a> <a href="/tags/Transaction/" rel="tag">#Transaction</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/2016/04/A-new-start/" rel="next" title="从零开始Blogging with Hexo教程"><i class="fa fa-chevron-left"></i> 从零开始Blogging with Hexo教程</a></div><div class="post-nav-prev post-nav-item"><a href="/post/2016/04/Nginx-reverse-proxy-with-tomcat-in-docker/" rel="prev" title="Nginx与Tomcat 8在Docker环境的反向代理配置过程">Nginx与Tomcat 8在Docker环境的反向代理配置过程<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><p>热评文章</p><div class="ds-top-threads" data-range="weekly" data-num-items="4"></div><div class="comments" id="comments"><div class="ds-thread" data-thread-key="post/2016/04/JOOQ-from-entry-to-improve/" data-title="JOOQ 3.8.2 使用 教程：从入门到提高" data-url="http://amao12580.github.io/post/2016/04/JOOQ-from-entry-to-improve/"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Steven Cheng"><p class="site-author-name" itemprop="name">Steven Cheng</p><p class="site-description motion-element" itemprop="description">http://amao12580.github.io/about</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags"><span class="site-state-item-count">48</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/amao12580" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://segmentfault.com/blogs" title="SegmentFault" target="_blank">SegmentFault</a></li><li class="links-of-blogroll-item"><a href="http://blog.jobbole.com/" title="伯乐在线" target="_blank">伯乐在线</a></li><li class="links-of-blogroll-item"><a href="http://cnpolitics.org/" title="政见" target="_blank">政见</a></li><li class="links-of-blogroll-item"><a href="http://dajia.qq.com/" title="大家" target="_blank">大家</a></li><li class="links-of-blogroll-item"><a href="http://www.importnew.com/" title="ImportNew" target="_blank">ImportNew</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#写在前面"><span class="nav-number">1.</span> <span class="nav-text">写在前面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是JOOQ？"><span class="nav-number">2.</span> <span class="nav-text">什么是JOOQ？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VS-主流ORM框架"><span class="nav-number">2.1.</span> <span class="nav-text">VS 主流ORM框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优势和局限性"><span class="nav-number">2.2.</span> <span class="nav-text">优势和局限性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#入门篇"><span class="nav-number">3.</span> <span class="nav-text">入门篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#With-MySQL"><span class="nav-number">3.1.</span> <span class="nav-text">With MySQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-Generation"><span class="nav-number">3.2.</span> <span class="nav-text">Code Generation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#With-Flyway"><span class="nav-number">3.3.</span> <span class="nav-text">With Flyway</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#With-HikariCp"><span class="nav-number">3.4.</span> <span class="nav-text">With HikariCp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单的CRUD"><span class="nav-number">3.5.</span> <span class="nav-text">简单的CRUD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#进阶篇"><span class="nav-number">4.</span> <span class="nav-text">进阶篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#连接查询"><span class="nav-number">4.1.</span> <span class="nav-text">连接查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子查询"><span class="nav-number">4.2.</span> <span class="nav-text">子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务"><span class="nav-number">4.3.</span> <span class="nav-text">事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#批处理"><span class="nav-number">4.4.</span> <span class="nav-text">批处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数"><span class="nav-number">4.5.</span> <span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#内置函数"><span class="nav-number">4.5.1.</span> <span class="nav-text">内置函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义函数"><span class="nav-number">4.5.2.</span> <span class="nav-text">自定义函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储过程"><span class="nav-number">4.6.</span> <span class="nav-text">存储过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图"><span class="nav-number">4.7.</span> <span class="nav-text">视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运算符"><span class="nav-number">4.8.</span> <span class="nav-text">运算符</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级篇"><span class="nav-number">5.</span> <span class="nav-text">高级篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重复使用Statement"><span class="nav-number">5.1.</span> <span class="nav-text">重复使用Statement</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#draft-With-Ehcache"><span class="nav-number">5.2.</span> <span class="nav-text">[draft] With Ehcache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#draft-钩子函数：DefaultRecordListener-如何使用？"><span class="nav-number">5.3.</span> <span class="nav-text">[draft] 钩子函数：DefaultRecordListener 如何使用？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#draft-更快的分页-seek"><span class="nav-number">5.4.</span> <span class="nav-text">[draft] 更快的分页(seek)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小技巧"><span class="nav-number">6.</span> <span class="nav-text">小技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取SQL语句"><span class="nav-number">6.1.</span> <span class="nav-text">获取SQL语句</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Some-else"><span class="nav-number">7.</span> <span class="nav-text">Some else</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JPA与JDBC有什么区别？"><span class="nav-number">7.1.</span> <span class="nav-text">JPA与JDBC有什么区别？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JOOQ与JDBC的详细区别"><span class="nav-number">7.2.</span> <span class="nav-text">JOOQ与JDBC的详细区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">8.</span> <span class="nav-text">Reference</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2016</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Steven Cheng</span> <span class="post-count">&nbsp全站共116.0k字</span></div><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>访问量<span id="busuanzi_value_site_pv"></span> &nbsp 您是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴<script>var OriginTitile=document.title,st;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(つェ⊂)我藏好了哦~",clearTimeout(st)):(document.title="(*´∇｀*)被你发现啦~ "+OriginTitile,console.log("show"),st=setTimeout(function(){document.title=OriginTitile},4e3))})</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script><script src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script src="//cdn.bootcss.com/velocity/1.2.3/velocity.min.js"></script><script src="//cdn.bootcss.com/velocity/1.2.3/velocity.ui.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script src="/js/src/main.js?v=5.0.1"></script><script src="//cdn.bootcss.com/bootstrap/3.2.0/js/affix.js"></script><script src="/js/src/post.js?v=5.0.1"></script><script>var duoshuoQuery={short_name:"amao12580"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.id="duoshuo-script",t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementById("footer")||document.getElementsByTagName("body")[0]).appendChild(t)}()</script><script>function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=r.url,i=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){i=s.indexOf(e),l=n.indexOf(e),0>i&&0>l?c=!1:(0>l&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;0>u&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").mousedown(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>