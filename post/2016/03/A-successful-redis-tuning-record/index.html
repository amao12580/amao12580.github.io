
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>记一次redis成功调优的过程 | Cat&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Steven Cheng">
    

    
    <meta name="description" content="在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次redis成功调优的过程">
<meta property="og:url" content="http://amao12580.github.io/post/2016/03/A-successful-redis-tuning-record/index.html">
<meta property="og:site_name" content="Cat's Blog">
<meta property="og:description" content="在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。">
<meta property="og:image" content="http://amao12580.github.io/img/photos在redis的数据结构示例.png">
<meta property="og:updated_time" content="2016-03-30T07:22:27.720Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记一次redis成功调优的过程">
<meta name="twitter:description" content="在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。">
<meta name="twitter:image" content="http://amao12580.github.io/img/photos在redis的数据结构示例.png">

    
    <link rel="alternative" href="/atom.xml" title="Cat&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Cat&#39;s Blog" title="Cat&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Cat&#39;s Blog">Cat&#39;s Blog</a></h1>
				<h2 class="blog-motto">一饮一啄，莫非前定.</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/index">索引 | Index</a></li>
					
						<li><a href="/archives">归档 | Archives</a></li>
					
						<li><a href="/about">简介 | About</a></li>
					
					<li>
 					
					<form class="search" action="https://www.google.com.hk/search" method="get" accept-charset="utf-8" target="_blank">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:amao12580.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/2016/03/A-successful-redis-tuning-record/" title="记一次redis成功调优的过程" itemprop="url">记一次redis成功调优的过程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Steven Cheng" target="_blank" itemprop="author">Steven Cheng</a>
		
  <p class="article-time">
  <time datetime="2016-03-23T08:09:12.000Z" itemprop="datePublished"> 发表于 2016-03-23 16:09:12.000</time>
  <time postupdated="2016-03-30T07:22:27.720Z" itemprop="dateModified"> 更新于 2016-03-30 15:22:27.720</time>
</p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#我们怎么使用Redis？"><span class="toc-number">1.</span> <span class="toc-text">我们怎么使用Redis？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存图片信息"><span class="toc-number">1.1.</span> <span class="toc-text">缓存图片信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存登录后的用户信息"><span class="toc-number">1.2.</span> <span class="toc-text">缓存登录后的用户信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#这次的问题的描述？"><span class="toc-number">2.</span> <span class="toc-text">这次的问题的描述？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何一步步的解决问题？"><span class="toc-number">3.</span> <span class="toc-text">如何一步步的解决问题？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#对缓存图片的处理存在的问题"><span class="toc-number">3.1.</span> <span class="toc-text">对缓存图片的处理存在的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方案"><span class="toc-number">3.1.1.</span> <span class="toc-text">方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对缓存用户登录的处理存在的问题"><span class="toc-number">3.2.</span> <span class="toc-text">对缓存用户登录的处理存在的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方案-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#遇到了一些问题"><span class="toc-number">4.</span> <span class="toc-text">遇到了一些问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#常用命令合集"><span class="toc-number">5.1.</span> <span class="toc-text">常用命令合集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker"><span class="toc-number">5.1.1.</span> <span class="toc-text">docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-cli-sh-info"><span class="toc-number">5.1.2.</span> <span class="toc-text">./redis-cli.sh/info</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#set-get"><span class="toc-number">5.1.3.</span> <span class="toc-text">set/get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hset-hmset-hget-hmget"><span class="toc-number">5.1.4.</span> <span class="toc-text">hset/hmset/hget/hmget</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hlen-keys"><span class="toc-number">5.1.5.</span> <span class="toc-text">hlen/keys</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#config-set-get"><span class="toc-number">5.1.6.</span> <span class="toc-text">config set/get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flushdb-flushall"><span class="toc-number">5.1.7.</span> <span class="toc-text">flushdb/flushall</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展阅读"><span class="toc-number">6.</span> <span class="toc-text">扩展阅读</span></a></li></ol>
		
		</div>
		
		<h2 id="我们怎么使用Redis？"><a href="#我们怎么使用Redis？" class="headerlink" title="我们怎么使用Redis？"></a>我们怎么使用Redis？</h2><p>公司目前主力开发的产品，是一个典型的平台电商型产品，包含了平台运营方、商家、消费者等角色。</p>
<p>公司提供电商平台，同时负责系统维护和系统保障；商家与公司进行签约后，入驻平台，将商品投放到平台进行展示；平台依据商家签约信息，进行商品与消费者之间的兴趣推荐，消费者通过商品与商家达成消费订单后，平台按单依据签约与商家抽取利润。商家发现日订单分析有了提升后，可能会与平台达成更多的合作。从而演变出了良好的商业发展模式。</p>
<p>平台电商型产品中，非常满足80/20法则(又称为:<a href="https://zh.wikipedia.org/wiki/%E5%B8%95%E9%9B%B7%E6%89%98%E6%B3%95%E5%88%99" target="_blank" rel="external">帕雷托法则</a>),查询的业务量远远多于写入的业务量，为了提高<a href="http://www.ha97.com/5095.html" target="_blank" rel="external">TPS</a>，降低对数据库的访问。我们也采取常规的做法，选用redis进行缓存常用业务数据。其中典型的就有：1.图片的信息、2.登录后的用户信息、3.全局超时锁、4.验证码。</p>
<p>关于redis的技术选型，其实在我参与产品开发之前就已经完成了，在这个产品里也作为缓存层在使用。产品目前还在雏形孵化阶段，没有考虑太多关于分布式以及高可用的方案，对redis的使用很粗糙，在团队内可能熟悉redis的Developer不多，或者说有空又有耐心还熟悉redis的Developer没有吧？后来与PM的沟通后得知确实如此！</p>
<h3 id="缓存图片信息"><a href="#缓存图片信息" class="headerlink" title="缓存图片信息"></a>缓存图片信息</h3><p>目前有很多业务在使用该缓存：商品的图片编辑，商家店面形象的图文自我介绍，用户针对订单的图文评价.</p>
<p>这一部分的数据，在产品启动时(没有黑科技，就是在web.xml，自定义listener。)，读取Mysql中的File表，load进redis，数据量约120W条，没有做任何的分库分表处理。</p>
<p>File表的结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `file` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;图片ID&apos;,</span><br><span class="line">  `uid` int(11) DEFAULT NULL COMMENT &apos;上传用户Id&apos;,</span><br><span class="line">  `crc32` char(8) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT &apos;crc32校验和&apos;,</span><br><span class="line">  `url` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT &apos;&apos; COMMENT &apos;对外访问的URL&apos;,</span><br><span class="line">  `path` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT &apos;&apos; COMMENT &apos;存储的相对路径&apos;,</span><br><span class="line">  `filename` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &apos;&apos; COMMENT &apos;文件名字&apos;,</span><br><span class="line">  `size` int(11) DEFAULT NULL COMMENT &apos;图片大小(单位byte)&apos;,</span><br><span class="line">  `ext` char(5) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &apos;&apos; COMMENT &apos;图片后缀&apos;,</span><br><span class="line">  `is_image` tinyint(4) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;是否是图片，0为不是，1为是&apos;,</span><br><span class="line">  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;创建时间&apos;,</span><br><span class="line">  `storage_type` tinyint(4) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;图片存储介质，0为fileSystem，1阿里云,2表示ppw老数据&apos;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `filename` (`filename`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1146617 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT=&apos;文件信息表&apos;;</span><br></pre></td></tr></table></figure></p>
<p>有意思的是，每次产品启动时，读取到的所有File表记录，进行for循环，每一次循环中，访问一次redis。而在产品关闭时，删除redis的key，从而清除缓存？如果数据量愈来愈多，不就像做过山车一样，启动时加载全量数据，使用量飚的很高，关闭时删除全量缓存，使用量逐渐落回低谷(redis有<a href="http://wangneng-168.iteye.com/blog/2100379" target="_blank" rel="external">内存释放机制</a>)。对于内存型中间件产品，这样的使用会带来很多的不可靠性。</p>
<p>启动时加载数据到redis时的处理过程,部分为伪码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">File表对应的实体类：</span><br><span class="line">public class File&#123;//与数据库字段名完全的一致</span><br><span class="line">    private int id;</span><br><span class="line">    private int uid;</span><br><span class="line">    private String crc32;</span><br><span class="line">    private String url;</span><br><span class="line">    private String path;</span><br><span class="line">    private String filename;</span><br><span class="line">    private int size;</span><br><span class="line">    private String ext;</span><br><span class="line">    private int is_image;</span><br><span class="line">    private Timestamp create_time;</span><br><span class="line">    private int storage_type;</span><br><span class="line"></span><br><span class="line">    //忽略 getter\setter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//调用Dao层访问Mysql数据库，取回File表的所有记录，每条记录包含所有字段。</span><br><span class="line">List&lt;File&gt; files=this.fileDao.getAll();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//读取File表的SQL：SELECT * FROM FILE;</span><br><span class="line"></span><br><span class="line">for(int i=0;i&lt;files.size();i++)&#123;</span><br><span class="line">    this.cacheDao.setOneFileToRedis(files.get(i).getId(),files.get(i).getUrl());//调用Dao层访问Redis，将数据存入redis</span><br><span class="line">    //WTF?只需要2个字段，然而取回了所有字段？而且不能批量存入redis?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cacheDao的实现</span><br><span class="line">private final static String PHOTO_CACHE_KEY=&quot;photos&quot;;</span><br><span class="line">public void setOneFileToRedis(int id,String url)&#123;</span><br><span class="line">    this.jedis.hset(PHOTO_CACHE_KEY, id.toString(), url);//1.使用[Hash数据结构](https://redis.readthedocs.org/en/2.4/hash.html)。2.没有设置key有效期，即永久有效。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public String getOneFileInRedis(int id)&#123;</span><br><span class="line">    return this.jedis.hget(PHOTO_CACHE_KEY, id.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样图片信息缓存的结构看起来是这样:<br><img src="/img/photos在redis的数据结构示例.png" alt="photos在redis的数据结构示例"><br>实际的情况下，size远大于1000，上文说了约在120w左右，我的这个redis可视化工具(redisclient-win32.x86.2.0)无法获取size这样大的key，报SocketTimeOutException。猜测是向redis获取大key时，无法在一个socket包中写入，造成通讯失败。</p>
<p>以上cacheDao的实现中，没有提供一次批量获取所需的多个图片信息，例如“public Map<integer,string> getBatchFileInRedis(int[] ids)”，甚至在cache interface中都没有提供这样的接口定义。</integer,string></p>
<p>这样导致在上层逻辑中，出现大量一次性代码。因为调用不集中，给重构带来很大麻烦。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">这是分页获取商品列表的伪代码实现</span><br><span class="line"></span><br><span class="line">与数据库product表对应的实体类</span><br><span class="line">public class Product&#123;</span><br><span class="line">    private int id;</span><br><span class="line">    private String name;</span><br><span class="line">    private long price;</span><br><span class="line">    private int photoId;</span><br><span class="line"></span><br><span class="line">    //忽略 getter\setter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">真实的返回到app端的对象</span><br><span class="line">public class ProductFull&#123;</span><br><span class="line">    private int id;</span><br><span class="line">    private String name;</span><br><span class="line">    private long price;</span><br><span class="line">    private int photoId;</span><br><span class="line">    private String photoUrl;</span><br><span class="line"></span><br><span class="line">    //忽略 getter\setter</span><br><span class="line">&#125;</span><br><span class="line">public List&lt;ProductFull&gt; findProductByPage(int pageSize,int pageNo)&#123;</span><br><span class="line">    List&lt;Product&gt; products=this.productDao.findByPage(int pageSize,int pageNo);//调用Dao层访问Mysql</span><br><span class="line">    List&lt;ProductFull&gt; results=new ArrayList&lt;&gt;(products.size());</span><br><span class="line">    for(Product product:products)&#123;</span><br><span class="line">        ProductFull pf=new ProductFull();</span><br><span class="line">        pf.setId(product.getId());//其他的属性值都是类似的拷贝，或借助Apache-Common beanUtils组件进行拷贝。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String url=this.cacheDao.getOneFileInRedis(product.getPhotoId());//每一个循环项都访问了redis</span><br><span class="line">        pf.setPhotoUrl(url);</span><br><span class="line">        results.add(pf);</span><br><span class="line">    &#125;</span><br><span class="line">    return results;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">如果每个商品分页是10条，最坏情况下，需要访问1次Mysql+访问10次redis。非常严重的是，每个分页条数的大小由app端决定，服务端不限制，WTF?</span><br></pre></td></tr></table></figure></p>
<h3 id="缓存登录后的用户信息"><a href="#缓存登录后的用户信息" class="headerlink" title="缓存登录后的用户信息"></a>缓存登录后的用户信息</h3><p>在这个产品面向消费者以及商家，都推出了不同的APP。互联网APP为了提高用户体验，以及降低用户登录登出频次(用户的登录/登出操作，对服务器是比较大的开销)，都会对一次登陆成功的用户，默认在一段时间不需要再次登录。即服务器分配Token给APP本地保存，同时服务器保存Token，设置该Token在一段时间不活动后自动失效，APP后续与服务器的通信中，都需要提交该Token鉴权。这是很常规的做法，短时间有效，而且是非关键性小数据，一次写入多次读取，对于服务器来说，没有比memcached或redis更合适的选择了，那为什么没有选择memcached？我个人的猜测是memcached更适合做Object Store Server，而且很重要的redis的<a href="http://www.cnblogs.com/EE-NovRain/p/3268476.html" target="_blank" rel="external">扩容与容灾机制</a>较好。</p>
<p>用户的第一次登录，服务端进行参数解析，鉴权后，就需要写入2次redis。<br>用户的登出接口中，直接是删除当前会话的redis记录。</p>
<p>第一次：写入本次登入的Token与用户信息的关联<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">登录成功后，从DB或Cache层获取用户数据，构造用户数据JSON</span><br><span class="line">String userLoginSuccessInfo=&quot;&#123;&quot;uid&quot;:12321,&quot;name&quot;:&quot;张三&quot;,&quot;sex&quot;:0,&quot;avatar_id&quot;:345643&#125;&quot;;</span><br><span class="line"></span><br><span class="line">cacheDao的实现</span><br><span class="line">private final static String SESSION_CACHE_KEY=&quot;session:&quot;;</span><br><span class="line">public void setOneLoginSuccessToRedis(String token,String userLoginSuccessInfo)&#123;</span><br><span class="line">    this.jedis.setex(SESSION_CACHE_KEY+token, 30*24*60*60, userLoginSuccessInfo);//1.使用String数据结构。2.设置key有效期30天。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public String getOneLoginSuccessInRedis(String token)&#123;</span><br><span class="line">    return this.jedis.get(SESSION_CACHE_KEY+token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">这个以&quot;session:&quot;开头的key里，并没有实现从uid如何获取token值？</span><br><span class="line">这会引发的问题：一个用户的多次登录，会生成多个以&quot;session:&quot;开头的key，没有覆盖之前登录的token。造成内存空间的浪费，以及不安全。正确的做法在下文会提到。</span><br></pre></td></tr></table></figure></p>
<p>第二次：写入本次登入的用户id与24小时内的积分获取信息。</p>
<p>有一个需求定义用户在登录后可以获取积分，但在24小时内的登录只算一次。</p>
<p>那在服务器端的是实现是，用户第一次登录成功后，在redis写入一个与该用户相关的key，并设置24小时后失效，然后再增加积分。用户在24小时内进行第二次登录，先读取redis是否有相关的key，使用exist命令，如果已经有了，就不增加积分了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">登录成功后，从DB或Cache层获取用户数据，构造用户与积分业务数据JSON</span><br><span class="line">int uid=158263;</span><br><span class="line"></span><br><span class="line">cacheDao的实现</span><br><span class="line">private final static String USER_ACTIVITY_CACHE_KEY=&quot;daily_activity_&quot;;</span><br><span class="line">public void setOneUserWithActivityToRedis(int uid)&#123;</span><br><span class="line">    this.jedis.setex(USER_ACTIVITY_CACHE_KEY+uid, 24*60*60, &quot;&quot;);//1.使用String数据结构。2.设置key有效期24h。3.value部分为空字符串？</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public boolean checkOneUserWithActivityToRedis(int uid)&#123;</span><br><span class="line">    this.jedis.exists(USER_ACTIVITY_CACHE_KEY+uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分的业务属于典型案例，浪费内存空间。<br>第一个问题，不应该使用长前缀，每个key都需要set进内存，长前缀意味着空间占用，以及效率低下。<br>第二个问题，这不是明显可以使用<a href="https://redis.readthedocs.org/en/2.4/sorted_set.html" target="_blank" rel="external">sorted set数据结构</a>?，还可以省掉一次exists检查。</p>
<p>虽然redis的TPS很高，但是我们依旧要避免滥用。</p>
<h2 id="这次的问题的描述？"><a href="#这次的问题的描述？" class="headerlink" title="这次的问题的描述？"></a>这次的问题的描述？</h2><p>测试MM提出在性能测试环境中，有一些API在并发数到250~300时，出现很多报错。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis的相关错误</span><br><span class="line">Could not get a resource from the pool</span><br></pre></td></tr></table></figure></p>
<p>典型报错的接口有</p>
<ul>
<li>分页获取商品列表</li>
<li>用户登录</li>
</ul>
<p>应用中配置redis连接池上限值是1000，而在redis server端配置maxClients=10000;区区这点并发，就耗尽redis连接池资源了？绝不可能，问题还在更远的地方等着我.</p>
<p>性能测试环境配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">硬件配置</span><br><span class="line">操作系统    Linux Ubuntu 14.04.4 LTS</span><br><span class="line">CPU个数   4</span><br><span class="line">CPU时钟频率 2.6G</span><br><span class="line">内存  4G</span><br><span class="line">有无外部存储  云端存储</span><br><span class="line"></span><br><span class="line">软件配置</span><br><span class="line">docker  1.9.1</span><br><span class="line">mysql   5.6</span><br><span class="line">jdk 1.8.0_72</span><br><span class="line">solr    5.3.0</span><br><span class="line">redis   3.0.5</span><br></pre></td></tr></table></figure></p>
<h2 id="如何一步步的解决问题？"><a href="#如何一步步的解决问题？" class="headerlink" title="如何一步步的解决问题？"></a>如何一步步的解决问题？</h2><p>在描述问题产生背景时，其实也提到了很多不合理的地方，但<em>存在即合理</em>，处在现在的困境，一定有当时的无奈。现在我们一起来总结一下问题所在。</p>
<h3 id="对缓存图片的处理存在的问题"><a href="#对缓存图片的处理存在的问题" class="headerlink" title="对缓存图片的处理存在的问题"></a>对缓存图片的处理存在的问题</h3><ul>
<li>产品初始化时全量塞入redis/产品停止运行是全量卸掉</li>
<li>产品初始化时塞入redis时，没有做批量操作</li>
<li>对批量获取图片信息不支持，在接口层面就已经没有定义，对于可预见的需求没有进行考虑，这是架构设计的缺陷。</li>
<li>引申：大量的数据，放在一个key里，会出现问题，需要进行水平切分。</li>
</ul>
<h4 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h4><p>1.图片的Id数据在File表采用了<em>自增长</em>的方式生成，不会出现重复，并且有顺序。我们可以利用这一点，在产品初始化时，在Mysql数据库File表只查找2个字段：id/url。程序处理时，先写入reids一个key，使用Hash数据结构，isInitIng:photos-true，标明到正在初始化，其他产品节点不需要重复初始化。使用hmset的方式，一次性将多个键值对存入到redis。完成后，修改isInitIng:photos-false。当有了新图片时，先在Mysql数据库File表进行保存，得到这个图片的Id以及url，使用hset加入该图片到redis。如果需要修改某一张图片的url，也可以用hset。这样在产品停止运行时，是不需要删除redis关于图片的数据的。</p>
<p>2.cache层加入新接口，支持批量获取图片信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private final static String PHOTO_CACHE_KEY=&quot;photos&quot;;</span><br><span class="line">public void setFileToRedis(Map&lt;Integer,String&gt; photos)&#123;</span><br><span class="line">    this.jedis.hmset(PHOTO_CACHE_KEY, photos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Map&lt;Integer,String&gt; getBatchFileInRedis(int[] ids)&#123;</span><br><span class="line">    return this.jedis.hmget(PHOTO_CACHE_KEY, coverArrayToString(ids));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static String[] coverArrayToString(int[] ids)&#123;</span><br><span class="line">    String[] results=new String[ids.length];</span><br><span class="line">    for (int i = 0; i &lt; ids.length; i++) &#123;</span><br><span class="line">        results[i]=ids[i]+&quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对之前循环调用的上层代码进行修改，改为调用批量获取接口。</p>
<p>3.对于单个key承载大量的数据的情况，方案是对key下的values hash key进行分割，使用一定的算法将块状的数据均匀分布在多个key里。给一个<a href="http://blog.nosqlfan.com/html/3379.html" target="_blank" rel="external">参考链接</a>。</p>
<h3 id="对缓存用户登录的处理存在的问题"><a href="#对缓存用户登录的处理存在的问题" class="headerlink" title="对缓存用户登录的处理存在的问题"></a>对缓存用户登录的处理存在的问题</h3><ul>
<li>session的存储不合理，每次登陆都会生成一个key值</li>
<li>对USER_ACTIVITY_CACHE_KEY在value部分的数据结构不合理，应采用Sorted Set</li>
<li>对USER_ACTIVITY_CACHE_KEY的命名不合适，过长导致空间浪费和效率低下</li>
<li>因采用错误数据结构，USER_ACTIVITY_CACHE_KEY需要进行多一次的exists判断。</li>
</ul>
<h4 id="方案-1"><a href="#方案-1" class="headerlink" title="方案"></a>方案</h4><p>session的存储不合理的解决，通过新的key(uid:token)来反向标记uid与token的关系，2个key的超时时间保持一致，例如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid:158742-token001</span><br></pre></td></tr></table></figure></p>
<p>在写入SESSION_CACHE_KEY时，同时写入到redis，为保证2次写入的原子性，需要使用<a href="https://redis.readthedocs.org/en/2.4/transaction.html" target="_blank" rel="external">redis的事务</a>。如果支持用户的多设备在线，只需要将key(uid:token)更改为Sorted Set结构。因为不存在资源的争夺，这个事务几乎不会失败。在用户登出时，删除掉当前会话信息以及用户关联的会话信息(同样是使用redis事务)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cacheDao的实现</span><br><span class="line">private final static String SESSION_CACHE_KEY=&quot;session:&quot;;</span><br><span class="line">private final static String USER_TOKEN_CACHE_KEY=&quot;uid:&quot;;</span><br><span class="line">public void setOneLoginSuccessToRedis(int uid,String token,String userLoginSuccessInfo)&#123;</span><br><span class="line">    long expireTime=30*24*60*60;</span><br><span class="line">    Transaction tx = this.jedis.multi();</span><br><span class="line">    tx.setex(SESSION_CACHE_KEY+token, expireTime, userLoginSuccessInfo);//1.使用String数据结构。2.设置key有效期30天。</span><br><span class="line">    tx.setex(USER_TOKEN_CACHE_KEY+uid, expireTime, token);//1.使用String数据结构。2.设置key有效期30天。</span><br><span class="line">    List&lt;Object&gt; results = tx.exec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>public<br>按照以上的方案进行重构后，性能得到显著提升，按理论来说稳定性会有提高，因为不具备稳定性测试的条件，没法比较。</p>
<h2 id="遇到了一些问题"><a href="#遇到了一些问题" class="headerlink" title="遇到了一些问题"></a>遇到了一些问题</h2><p>1.redis一次批量hmset过多时报错<br>hmset操作时，对于一次传入参数数量上限有要求。这取决于你的网络环境下，socket一次写入的字节数上限。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public String hmset(final String key, final Map&lt;String, String&gt; hash);</span><br></pre></td></tr></table></figure></p>
<p>在我本机的环境下(应用与redis都在本机，不同端口，redis以默认配置运行)，Map<string, string=""> hash的size大于5w左右就会报错。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis.clients.jedis.exceptions.JedisConnectionException: java.net.SocketException: Software caused connection abort: socket write error</span><br><span class="line">    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:98)</span><br><span class="line">    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:78)</span><br><span class="line">    at redis.clients.jedis.Connection.sendCommand(Connection.java:101)</span><br><span class="line">    at redis.clients.jedis.BinaryClient.hmset(BinaryClient.java:246)</span><br><span class="line">    at redis.clients.jedis.Client.hmset(Client.java:171)</span><br><span class="line">    at redis.clients.jedis.Jedis.hmset(Jedis.java:652)</span><br></pre></td></tr></table></figure></string,></p>
<p>在这种情况下，必需要将大Map切分成一块块的Map，循环调用hmset<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">final static int maxEveryTurn=5000;//定义每次最多批量塞入redis的key数量</span><br><span class="line">    /**</span><br><span class="line">     * 批量存储到redis的key数量太多，必需切分成小块存储</span><br><span class="line">     */</span><br><span class="line">    private static void setTooManyToJedis(Jedis jedis, Map&lt;String, String&gt; map) &#123;</span><br><span class="line">        int size=map.size();</span><br><span class="line">        int pieceNum=size/maxEveryTurn;</span><br><span class="line">        if(size&gt;(pieceNum*maxEveryTurn))&#123;</span><br><span class="line">            pieceNum+=1;</span><br><span class="line">        &#125;</span><br><span class="line">        Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iterator = map.entrySet().iterator();</span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; list=new ArrayList&lt;&gt;(pieceNum);</span><br><span class="line">        for (int i=0;i&lt;pieceNum;i++)&#123;</span><br><span class="line">            list.add(new HashMap&lt;&gt;(maxEveryTurn));</span><br><span class="line">        &#125;</span><br><span class="line">        while (iterator.hasNext()) &#123;</span><br><span class="line">            Map.Entry&lt;String, String&gt; entry = iterator.next();</span><br><span class="line">            String key = entry.getKey();</span><br><span class="line">            int hashCode = Math.abs(String.valueOf(key).hashCode());</span><br><span class="line">            int index=hashCode % pieceNum;</span><br><span class="line">            list.get(index).put(key, map.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">        map.clear();</span><br><span class="line">        for (Map&lt;String, String&gt; pieceMap:list)&#123;</span><br><span class="line">            setToJedis(jedis, pieceMap);</span><br><span class="line">        &#125;</span><br><span class="line">        list.clear();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>2.持续写redis时遇到rdb问题<br>在完成以上方案的改进后，测试人员的用户登录这个接口在进行性能回归测试时，使用gatling配置250个工作线程进行并发，一共完成50w的用户登录后就算是结束，再根据生成的测试报告分析。<br>刚开始每次压到20多w的用户登录时，就会报错，redis连接池无连接了。分析代码是配置了testOnBorrow:true，这个配置会在获取到连接后检查该连接的有效性，如果无效就丢弃，即在连接池删掉一个连接。而此时redis因为问题无法执行用户端的任何命令，所以所有连接都被当做无效连接被丢弃？直到连接池空了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在redis命令行执行</span><br><span class="line">set test 12321</span><br><span class="line">返回错误：</span><br><span class="line">(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.</span><br></pre></td></tr></table></figure></p>
<p>这是因为默认的redis配置是以<a href="http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22" target="_blank" rel="external">RDB的方式</a>进行定期存盘，而存盘时，会拒绝所有外部命令的写入(存盘失败后也会拒绝写入)。因为目前在redis的数据都处于可丢，解决方式也相当的粗暴。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.保证redis处于运行状态，查询系统6379端口的监听情况</span><br><span class="line">2.顺序执行以下命令行，遇到错误请终止</span><br><span class="line">docker exec -it test_redis_1 /bin/bash</span><br><span class="line">cd usr/local/bin</span><br><span class="line">./redis-cli.sh</span><br><span class="line">config set stop-writes-on-bgsave-error no</span><br><span class="line">config set save &quot;&quot;</span><br><span class="line">quit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure></p>
<p>执行完以后，重启应用，再压测，呵呵，bug关闭。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。。注意Slave与Master第一次进行同步时会使用全量复制，对资源会有比较大的消耗，尽量选择在业务平峰期进行。<br>引申阅读，Master在这里成为了单点，为了Master的高可用，还有进一步的方案，1个Master下挂2个Slave，其中1个Slave(称为A)负责2种方式的存盘，另一个Slave(称为B)作为Master的热备，在Master故障后，参与到投票，成为新的Master，而B节点切换到A，接受A的增量同步。注意自动failover时，外部需要关闭写入命令。完成failover后，使用ip映射切换，使应用层重新恢复使用，相应的，应用层需要做到一定的容错性。实际生产中，不会要求应用层去做容错性措施，会有各种中间件(twemproxy)自动处理。</p>
<p>2.以上业务中对<a href="https://www.ttlsa.com/redis/redis-database/" target="_blank" rel="external">redis的16个数据库</a>没有使用好，可以按业务将数据存储到不同数据库，隔离影响。</p>
<h3 id="常用命令合集"><a href="#常用命令合集" class="headerlink" title="常用命令合集"></a>常用命令合集</h3><p>调试过程中，由于可视化工具对redis支持的不够好，使用了很多redis的命令行，现在我们总结一下吧！<br>由于docker的风行，好处多多，我们在测试环境、线上环境也使用了docker/docker-compose</p>
<h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps          //查看yml文件中所有容器的运行情况</span><br><span class="line">docker-compose up -d xw    //将yml文件中容器名称定义为xw的容器，以后台运行的方式运行起来，如果是tomcat镜像，会调用tomcat的startup.sh.</span><br><span class="line">docker-compose stop xw     //将yml文件中容器名称定义为xw的容器停止，如果是tomcat镜像，会调用tomcat的shutdown.sh</span><br><span class="line">docker-compose stop        //查看yml文件中所有容器进行停止</span><br><span class="line">docker-compose rm xw       //移除xw镜像</span><br><span class="line">docker-compose build xw    //对xw进行镜像构建</span><br></pre></td></tr></table></figure>
<h4 id="redis-cli-sh-info"><a href="#redis-cli-sh-info" class="headerlink" title="./redis-cli.sh/info"></a>./redis-cli.sh/info</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">F:\Redis&gt; ./redis-cli</span><br><span class="line">127.0.0.1:6379&gt; info</span><br><span class="line"># Server</span><br><span class="line">redis_version:3.0.501</span><br><span class="line">redis_git_sha1:00000000</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:ba05b51e58eb9205</span><br><span class="line">redis_mode:standalone</span><br><span class="line">os:Windows</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:WinSock_IOCP</span><br><span class="line">process_id:1552</span><br><span class="line">run_id:d3f2efa1c6cf26c7cf9246c2fcaca89b8e109439</span><br><span class="line">tcp_port:6379</span><br><span class="line">uptime_in_seconds:462095</span><br><span class="line">uptime_in_days:5</span><br><span class="line">hz:10</span><br><span class="line">lru_clock:16404129</span><br><span class="line">config_file:F:\Redis\redis.windows.conf</span><br><span class="line"></span><br><span class="line"># Clients</span><br><span class="line">connected_clients:1</span><br><span class="line">client_longest_output_list:0</span><br><span class="line">client_biggest_input_buf:0</span><br><span class="line">blocked_clients:0</span><br><span class="line"></span><br><span class="line"># Memory</span><br><span class="line">used_memory:842704</span><br><span class="line">used_memory_human:822.95K</span><br><span class="line">used_memory_rss:804920</span><br><span class="line">used_memory_peak:374731600</span><br><span class="line">used_memory_peak_human:357.37M</span><br><span class="line">used_memory_lua:36864</span><br><span class="line">mem_fragmentation_ratio:0.96</span><br><span class="line">mem_allocator:jemalloc-3.6.0</span><br><span class="line"></span><br><span class="line"># Persistence</span><br><span class="line">loading:0</span><br><span class="line">rdb_changes_since_last_save:0</span><br><span class="line">rdb_bgsave_in_progress:0</span><br><span class="line">rdb_last_save_time:1459242952</span><br><span class="line">rdb_last_bgsave_status:ok</span><br><span class="line">rdb_last_bgsave_time_sec:1</span><br><span class="line">rdb_current_bgsave_time_sec:-1</span><br><span class="line">aof_enabled:0</span><br><span class="line">aof_rewrite_in_progress:0</span><br><span class="line">aof_rewrite_scheduled:0</span><br><span class="line">aof_last_rewrite_time_sec:-1</span><br><span class="line">aof_current_rewrite_time_sec:-1</span><br><span class="line">aof_last_bgrewrite_status:ok</span><br><span class="line">aof_last_write_status:ok</span><br><span class="line"></span><br><span class="line"># Stats</span><br><span class="line">total_connections_received:1010</span><br><span class="line">total_commands_processed:49859</span><br><span class="line">instantaneous_ops_per_sec:0</span><br><span class="line">total_net_input_bytes:1822381802</span><br><span class="line">total_net_output_bytes:3650427</span><br><span class="line">instantaneous_input_kbps:0.00</span><br><span class="line">instantaneous_output_kbps:0.00</span><br><span class="line">rejected_connections:0</span><br><span class="line">sync_full:0</span><br><span class="line">sync_partial_ok:0</span><br><span class="line">sync_partial_err:0</span><br><span class="line">expired_keys:1073</span><br><span class="line">evicted_keys:0</span><br><span class="line">keyspace_hits:20782</span><br><span class="line">keyspace_misses:738</span><br><span class="line">pubsub_channels:0</span><br><span class="line">pubsub_patterns:0</span><br><span class="line">latest_fork_usec:388023</span><br><span class="line">migrate_cached_sockets:0</span><br><span class="line"></span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br><span class="line"># CPU</span><br><span class="line">used_cpu_sys:9.45</span><br><span class="line">used_cpu_user:38.25</span><br><span class="line">used_cpu_sys_children:0.00</span><br><span class="line">used_cpu_user_children:0.00</span><br><span class="line"></span><br><span class="line"># Cluster</span><br><span class="line">cluster_enabled:0</span><br><span class="line"></span><br><span class="line"># Keyspace</span><br><span class="line">db0:keys=1,expires=0,avg_ttl=0</span><br></pre></td></tr></table></figure>
<h4 id="set-get"><a href="#set-get" class="headerlink" title="set/get"></a>set/get</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set test 123456</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get test</span><br><span class="line">&quot;123456&quot;</span><br></pre></td></tr></table></figure>
<h4 id="hset-hmset-hget-hmget"><a href="#hset-hmset-hget-hmget" class="headerlink" title="hset/hmset/hget/hmget"></a>hset/hmset/hget/hmget</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset testHash key1 value11</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hget testHash</span><br><span class="line">(error) ERR wrong number of arguments for &apos;hget&apos; command</span><br><span class="line">127.0.0.1:6379&gt; hget testHash key1</span><br><span class="line">&quot;value11&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; hset testHash key1 value11 key2 value22</span><br><span class="line">(error) ERR wrong number of arguments for &apos;hset&apos; command</span><br><span class="line">127.0.0.1:6379&gt; hmset testHash key1 value11 key2 value22</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hmget testHash key1 key2</span><br><span class="line">1) &quot;value11&quot;</span><br><span class="line">2) &quot;value22&quot;</span><br></pre></td></tr></table></figure>
<h4 id="hlen-keys"><a href="#hlen-keys" class="headerlink" title="hlen/keys"></a>hlen/keys</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; len test</span><br><span class="line">(error) ERR unknown command &apos;len&apos;</span><br><span class="line">127.0.0.1:6379&gt; hlen testHash</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; keys test</span><br><span class="line">1) &quot;test&quot;</span><br><span class="line">127.0.0.1:6379&gt; keys testHash</span><br><span class="line">1) &quot;testHash&quot;</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;testHash&quot;</span><br><span class="line">2) &quot;test&quot;</span><br><span class="line">3) &quot;message-queue-sms&quot;</span><br></pre></td></tr></table></figure>
<h4 id="config-set-get"><a href="#config-set-get" class="headerlink" title="config set/get"></a>config set/get</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get *</span><br><span class="line">  1) &quot;dbfilename&quot;</span><br><span class="line">  2) &quot;dump.rdb&quot;</span><br><span class="line">  3) &quot;requirepass&quot;</span><br><span class="line">  4) &quot;&quot;</span><br><span class="line">  5) &quot;masterauth&quot;</span><br><span class="line">  6) &quot;&quot;</span><br><span class="line">  7) &quot;unixsocket&quot;</span><br><span class="line">  8) &quot;&quot;</span><br><span class="line">  9) &quot;logfile&quot;</span><br><span class="line"> 10) &quot;&quot;</span><br><span class="line"> 11) &quot;pidfile&quot;</span><br><span class="line"> 12) &quot;/var/run/redis.pid&quot;</span><br><span class="line"> 13) &quot;maxmemory&quot;</span><br><span class="line"> 14) &quot;512000000&quot;</span><br><span class="line"> 15) &quot;maxmemory-samples&quot;</span><br><span class="line"> 16) &quot;5&quot;</span><br><span class="line"> 17) &quot;timeout&quot;</span><br><span class="line"> 18) &quot;0&quot;</span><br><span class="line"> 19) &quot;tcp-keepalive&quot;</span><br><span class="line"> 20) &quot;0&quot;</span><br><span class="line"> 21) &quot;auto-aof-rewrite-percentage&quot;</span><br><span class="line"> 22) &quot;100&quot;</span><br><span class="line"> 23) &quot;auto-aof-rewrite-min-size&quot;</span><br><span class="line"> 24) &quot;67108864&quot;</span><br><span class="line"> 25) &quot;hash-max-ziplist-entries&quot;</span><br><span class="line"> 26) &quot;512&quot;</span><br><span class="line"> 27) &quot;hash-max-ziplist-value&quot;</span><br><span class="line"> 28) &quot;64&quot;</span><br><span class="line"> 29) &quot;list-max-ziplist-entries&quot;</span><br><span class="line"> 30) &quot;512&quot;</span><br><span class="line"> 31) &quot;list-max-ziplist-value&quot;</span><br><span class="line"> 32) &quot;64&quot;</span><br><span class="line"> 33) &quot;set-max-intset-entries&quot;</span><br><span class="line"> 34) &quot;512&quot;</span><br><span class="line"> 35) &quot;zset-max-ziplist-entries&quot;</span><br><span class="line"> 36) &quot;128&quot;</span><br><span class="line"> 37) &quot;zset-max-ziplist-value&quot;</span><br><span class="line"> 38) &quot;64&quot;</span><br><span class="line"> 39) &quot;hll-sparse-max-bytes&quot;</span><br><span class="line"> 40) &quot;3000&quot;</span><br><span class="line"> 41) &quot;lua-time-limit&quot;</span><br><span class="line"> 42) &quot;5000&quot;</span><br><span class="line"> 43) &quot;slowlog-log-slower-than&quot;</span><br><span class="line"> 44) &quot;10000&quot;</span><br><span class="line"> 45) &quot;latency-monitor-threshold&quot;</span><br><span class="line"> 46) &quot;0&quot;</span><br><span class="line"> 47) &quot;slowlog-max-len&quot;</span><br><span class="line"> 48) &quot;128&quot;</span><br><span class="line"> 49) &quot;port&quot;</span><br><span class="line"> 50) &quot;6379&quot;</span><br><span class="line"> 51) &quot;tcp-backlog&quot;</span><br><span class="line"> 52) &quot;511&quot;</span><br><span class="line"> 53) &quot;databases&quot;</span><br><span class="line"> 54) &quot;16&quot;</span><br><span class="line"> 55) &quot;repl-ping-slave-period&quot;</span><br><span class="line"> 56) &quot;10&quot;</span><br><span class="line"> 57) &quot;repl-timeout&quot;</span><br><span class="line"> 58) &quot;60&quot;</span><br><span class="line"> 59) &quot;repl-backlog-size&quot;</span><br><span class="line"> 60) &quot;1048576&quot;</span><br><span class="line"> 61) &quot;repl-backlog-ttl&quot;</span><br><span class="line"> 62) &quot;3600&quot;</span><br><span class="line"> 63) &quot;maxclients&quot;</span><br><span class="line"> 64) &quot;10000&quot;</span><br><span class="line"> 65) &quot;watchdog-period&quot;</span><br><span class="line"> 66) &quot;0&quot;</span><br><span class="line"> 67) &quot;slave-priority&quot;</span><br><span class="line"> 68) &quot;100&quot;</span><br><span class="line"> 69) &quot;min-slaves-to-write&quot;</span><br><span class="line"> 70) &quot;0&quot;</span><br><span class="line"> 71) &quot;min-slaves-max-lag&quot;</span><br><span class="line"> 72) &quot;10&quot;</span><br><span class="line"> 73) &quot;hz&quot;</span><br><span class="line"> 74) &quot;10&quot;</span><br><span class="line"> 75) &quot;cluster-node-timeout&quot;</span><br><span class="line"> 76) &quot;15000&quot;</span><br><span class="line"> 77) &quot;cluster-migration-barrier&quot;</span><br><span class="line"> 78) &quot;1&quot;</span><br><span class="line"> 79) &quot;cluster-slave-validity-factor&quot;</span><br><span class="line"> 80) &quot;10&quot;</span><br><span class="line"> 81) &quot;repl-diskless-sync-delay&quot;</span><br><span class="line"> 82) &quot;5&quot;</span><br><span class="line"> 83) &quot;cluster-require-full-coverage&quot;</span><br><span class="line"> 84) &quot;yes&quot;</span><br><span class="line"> 85) &quot;no-appendfsync-on-rewrite&quot;</span><br><span class="line"> 86) &quot;no&quot;</span><br><span class="line"> 87) &quot;slave-serve-stale-data&quot;</span><br><span class="line"> 88) &quot;yes&quot;</span><br><span class="line"> 89) &quot;slave-read-only&quot;</span><br><span class="line"> 90) &quot;yes&quot;</span><br><span class="line"> 91) &quot;stop-writes-on-bgsave-error&quot;</span><br><span class="line"> 92) &quot;yes&quot;</span><br><span class="line"> 93) &quot;daemonize&quot;</span><br><span class="line"> 94) &quot;no&quot;</span><br><span class="line"> 95) &quot;rdbcompression&quot;</span><br><span class="line"> 96) &quot;yes&quot;</span><br><span class="line"> 97) &quot;rdbchecksum&quot;</span><br><span class="line"> 98) &quot;yes&quot;</span><br><span class="line"> 99) &quot;activerehashing&quot;</span><br><span class="line">100) &quot;yes&quot;</span><br><span class="line">101) &quot;repl-disable-tcp-nodelay&quot;</span><br><span class="line">102) &quot;no&quot;</span><br><span class="line">103) &quot;repl-diskless-sync&quot;</span><br><span class="line">104) &quot;no&quot;</span><br><span class="line">105) &quot;aof-rewrite-incremental-fsync&quot;</span><br><span class="line">106) &quot;yes&quot;</span><br><span class="line">107) &quot;aof-load-truncated&quot;</span><br><span class="line">108) &quot;yes&quot;</span><br><span class="line">109) &quot;appendonly&quot;</span><br><span class="line">110) &quot;no&quot;</span><br><span class="line">111) &quot;dir&quot;</span><br><span class="line">112) &quot;F:\\Redis&quot;</span><br><span class="line">113) &quot;maxmemory-policy&quot;</span><br><span class="line">114) &quot;noeviction&quot;</span><br><span class="line">115) &quot;appendfsync&quot;</span><br><span class="line">116) &quot;everysec&quot;</span><br><span class="line">117) &quot;save&quot;</span><br><span class="line">118) &quot;jd 900 jd 300 jd 60&quot;</span><br><span class="line">119) &quot;loglevel&quot;</span><br><span class="line">120) &quot;verbose&quot;</span><br><span class="line">121) &quot;client-output-buffer-limit&quot;</span><br><span class="line">122) &quot;normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60&quot;</span><br><span class="line">123) &quot;unixsocketperm&quot;</span><br><span class="line">124) &quot;0&quot;</span><br><span class="line">125) &quot;slaveof&quot;</span><br><span class="line">126) &quot;&quot;</span><br><span class="line">127) &quot;notify-keyspace-events&quot;</span><br><span class="line">128) &quot;&quot;</span><br><span class="line">129) &quot;bind&quot;</span><br><span class="line">130) &quot;&quot;</span><br><span class="line">127.0.0.1:6379&gt; config set save &quot;&quot;</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h4 id="flushdb-flushall"><a href="#flushdb-flushall" class="headerlink" title="flushdb/flushall"></a>flushdb/flushall</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; flushall</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><ul>
<li>redis删除有序集合部分过期元素：<a href="http://caozm.blog.51cto.com/1118764/1389168" target="_blank" rel="external">http://caozm.blog.51cto.com/1118764/1389168</a></li>
<li>节约内存：Instagram的Redis实践：<a href="http://blog.nosqlfan.com/html/3379.html" target="_blank" rel="external">http://blog.nosqlfan.com/html/3379.html</a></li>
<li>redis持久化机制：<a href="http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22" target="_blank" rel="external">http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22</a></li>
<li>Redis事务的分析及改进：<a href="https://segmentfault.com/a/1190000002594059" target="_blank" rel="external">https://segmentfault.com/a/1190000002594059</a></li>
<li>redis 多数据库：<a href="https://www.ttlsa.com/redis/redis-database/" target="_blank" rel="external">https://www.ttlsa.com/redis/redis-database/</a></li>
<li>利用Sorted Set数据结构，为元素设置有效期：<a href="http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set" target="_blank" rel="external">http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set</a></li>
<li>redis的Slave选举与优先级：<a href="https://segmentfault.com/a/1190000002685515" target="_blank" rel="external">https://segmentfault.com/a/1190000002685515</a></li>
<li>利用代理中间件实现大规模Redis集群：<a href="http://www.imooc.com/article/4343" target="_blank" rel="external">http://www.imooc.com/article/4343</a></li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Record/">Record</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Redis/">Redis</a><a href="/tags/Hash/">Hash</a><a href="/tags/Sharding/">Sharding</a><a href="/tags/Twemproxy/">Twemproxy</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://amao12580.github.io/post/2016/03/A-successful-redis-tuning-record/" data-title="记一次redis成功调优的过程 | Cat&#39;s Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/post/2016/03/JOOQ-from-entry-to-improve/"  title="JOOQ 3.6.1 使用总结：从入门到提高">
 <strong>下一篇：</strong><br/> 
 <span>JOOQ 3.6.1 使用总结：从入门到提高
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="post/2016/03/A-successful-redis-tuning-record/" data-title="记一次redis成功调优的过程" data-url="http://amao12580.github.io/post/2016/03/A-successful-redis-tuning-record/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#我们怎么使用Redis？"><span class="toc-number">1.</span> <span class="toc-text">我们怎么使用Redis？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存图片信息"><span class="toc-number">1.1.</span> <span class="toc-text">缓存图片信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存登录后的用户信息"><span class="toc-number">1.2.</span> <span class="toc-text">缓存登录后的用户信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#这次的问题的描述？"><span class="toc-number">2.</span> <span class="toc-text">这次的问题的描述？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何一步步的解决问题？"><span class="toc-number">3.</span> <span class="toc-text">如何一步步的解决问题？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#对缓存图片的处理存在的问题"><span class="toc-number">3.1.</span> <span class="toc-text">对缓存图片的处理存在的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方案"><span class="toc-number">3.1.1.</span> <span class="toc-text">方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对缓存用户登录的处理存在的问题"><span class="toc-number">3.2.</span> <span class="toc-text">对缓存用户登录的处理存在的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方案-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#遇到了一些问题"><span class="toc-number">4.</span> <span class="toc-text">遇到了一些问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#常用命令合集"><span class="toc-number">5.1.</span> <span class="toc-text">常用命令合集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker"><span class="toc-number">5.1.1.</span> <span class="toc-text">docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-cli-sh-info"><span class="toc-number">5.1.2.</span> <span class="toc-text">./redis-cli.sh/info</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#set-get"><span class="toc-number">5.1.3.</span> <span class="toc-text">set/get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hset-hmset-hget-hmget"><span class="toc-number">5.1.4.</span> <span class="toc-text">hset/hmset/hget/hmget</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hlen-keys"><span class="toc-number">5.1.5.</span> <span class="toc-text">hlen/keys</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#config-set-get"><span class="toc-number">5.1.6.</span> <span class="toc-text">config set/get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flushdb-flushall"><span class="toc-number">5.1.7.</span> <span class="toc-text">flushdb/flushall</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展阅读"><span class="toc-number">6.</span> <span class="toc-text">扩展阅读</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="amao12580" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Learning/" title="Learning">Learning<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Record/" title="Record">Record<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Tutorial/" title="Tutorial">Tutorial<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/SQL/" title="SQL">SQL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Markdown/" title="Markdown">Markdown<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ARM/" title="ARM">ARM<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ORM/" title="ORM">ORM<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/GitHub/" title="GitHub">GitHub<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Jacman/" title="Jacman">Jacman<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/JOOQ/" title="JOOQ">JOOQ<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Hash/" title="Hash">Hash<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Sharding/" title="Sharding">Sharding<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Twemproxy/" title="Twemproxy">Twemproxy<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Tech/" title="Tech">Tech<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Elegant/" title="Elegant">Elegant<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://segmentfault.com/blogs" target="_blank" title="专注高效地解决技术问题。内容质量的投票机制，合理区分答案与回馈信息，用户参与改进的维基化内容，帮你快捷地找到答案。">SegmentFault</a>
            
          </li>
        
          <li>
            
            	<a href="http://blog.jobbole.com/" target="_blank" title="伯乐在线">伯乐在线</a>
            
          </li>
        
          <li>
            
            	<a href="http://cnpolitics.org/" target="_blank" title="政见">政见</a>
            
          </li>
        
          <li>
            
            	<a href="http://dajia.qq.com/" target="_blank" title="大家">大家</a>
            
          </li>
        
          <li>
            
            	<a href="https://imququ.com/" target="_blank" title="JerryQu 的小站">JerryQu 的小站</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m steven. This is my blog on GitHub. <br/>
			Whenever you feel like criticizing any one, just remember that all the people in this world haven’t had the advantages that you’ve had.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3201133445" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/amao12580" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:chengliangchengliang888@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		© 2016
		
		<a href="/about" target="_blank" title="Steven Cheng">Steven Cheng</a>
		

		<!-- 不蒜子统计 -->

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
本站总访问量<span id="busuanzi_value_site_pv"></span>,本站访客数<span id="busuanzi_value_site_uv"></span>，本文总阅读量<span id="busuanzi_value_page_pv"></span>
</span>

		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"amao12580"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-75497011-1', 'http://amao12580.github.io');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
