<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.css" rel="stylesheet"><link href="//cdn.bootcss.com/animate.css/3.5.0/animate.css" rel="stylesheet"><link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet"><link href="//fonts.proxy.ustclug.org/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css?v=5.0.1" rel="stylesheet"><meta name="keywords" content="Redis,Hash,Sharding,Twemproxy,"><link rel="alternate" href="/atom.xml" title="Cat's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1"><meta name="description" content="在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。"><meta name="keywords" content="Redis,Hash,Sharding,Twemproxy"><meta property="og:type" content="article"><meta property="og:title" content="记一次redis成功调优的过程"><meta property="og:url" content="https://amao12580.github.io/post/2016/03/A-successful-redis-tuning-record/index.html"><meta property="og:site_name" content="Cat&#39;s Blog"><meta property="og:description" content="在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://amao12580.github.io/img/photos在redis的数据结构示例.png"><meta property="og:updated_time" content="2016-04-20T10:27:57.287Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="记一次redis成功调优的过程"><meta name="twitter:description" content="在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。"><meta name="twitter:image" content="https://amao12580.github.io/img/photos在redis的数据结构示例.png"><script id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:void 0,author:"博主"}}</script><title>记一次redis成功调优的过程 | Cat's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Cat's Blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">一饮一啄，莫非前定.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-index"><a href="/index/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>索引</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="#" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline">记一次redis成功调优的过程</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2016-03-23T16:09:12+08:00" content="2016-03-23">2016-03-23</time></span> <span class="post-category">&nbsp; | &nbsp;<span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/Record/" itemprop="url" rel="index"><span itemprop="name">Record</span></a></span></span> <span id="busuanzi_container_page_pv">&nbsp; | &nbsp; 热度&nbsp;<span id="busuanzi_value_page_pv"></span> °C</span></div></header><div class="post-body" itemprop="articleBody"><h2 id="我们怎么使用Redis？"><a href="#我们怎么使用Redis？" class="headerlink" title="我们怎么使用Redis？"></a>我们怎么使用Redis？</h2><p>公司目前主力开发的产品，是一个典型的平台电商型产品，包含了平台运营方、商家、消费者等角色。</p><p>公司提供电商平台，同时负责系统维护和系统保障；商家与公司进行签约后，入驻平台，将商品投放到平台进行展示；平台依据商家签约信息，进行商品与消费者之间的兴趣推荐，消费者通过商品与商家达成消费订单后，平台按单依据签约与商家抽取利润。商家发现日订单分析有了提升后，可能会与平台达成更多的合作。从而演变出了良好的商业发展模式。</p><p>平台电商型产品中，非常满足80/20法则(又称为:<a href="https://zh.wikipedia.org/wiki/%E5%B8%95%E9%9B%B7%E6%89%98%E6%B3%95%E5%88%99" target="_blank" rel="external">帕雷托法则</a>),查询的业务量远远多于写入的业务量，为了提高<a href="http://www.ha97.com/5095.html" target="_blank" rel="external">TPS</a>，降低对数据库的访问。我们也采取常规的做法，选用redis进行缓存常用业务数据。其中典型的就有：1.图片的信息、2.登录后的用户信息、3.全局超时锁、4.验证码。</p><p>关于redis的技术选型，其实在我参与产品开发之前就已经完成了，在这个产品里也作为缓存层在使用。产品目前还在雏形孵化阶段，没有考虑太多关于分布式以及高可用的方案，对redis的使用很粗糙，在团队内可能熟悉redis的Developer不多，或者说有空又有耐心还熟悉redis的Developer没有吧？后来与PM的沟通后得知确实如此！</p><h3 id="缓存图片信息"><a href="#缓存图片信息" class="headerlink" title="缓存图片信息"></a>缓存图片信息</h3><p>目前有很多业务在使用该缓存：商品的图片编辑，商家店面形象的图文自我介绍，用户针对订单的图文评价.</p><p>这一部分的数据，在产品启动时(没有黑科技，就是在web.xml，自定义listener。)，读取Mysql中的File表，load进redis，数据量约120W条，没有做任何的分库分表处理。</p><p>File表的结构如下：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`file`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'图片ID'</span>,</div><div class="line">  <span class="string">`uid`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'上传用户Id'</span>,</div><div class="line">  <span class="string">`crc32`</span> <span class="built_in">char</span>(<span class="number">8</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'crc32校验和'</span>,</div><div class="line">  <span class="string">`url`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'对外访问的URL'</span>,</div><div class="line">  <span class="string">`path`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'存储的相对路径'</span>,</div><div class="line">  <span class="string">`filename`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'文件名字'</span>,</div><div class="line">  <span class="string">`size`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'图片大小(单位byte)'</span>,</div><div class="line">  <span class="string">`ext`</span> <span class="built_in">char</span>(<span class="number">5</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'图片后缀'</span>,</div><div class="line">  <span class="string">`is_image`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'是否是图片，0为不是，1为是'</span>,</div><div class="line">  <span class="string">`create_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</div><div class="line">  <span class="string">`storage_type`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'图片存储介质，0为fileSystem，1阿里云,2表示ppw老数据'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`filename`</span> (<span class="string">`filename`</span>) <span class="keyword">USING</span> BTREE</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1146617</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci <span class="keyword">COMMENT</span>=<span class="string">'文件信息表'</span>;</div></pre></td></tr></table></figure><p></p><p>有意思的是，每次产品启动时，读取到的所有File表记录，进行for循环，每一次循环中，访问一次redis。而在产品关闭时，删除redis的key，从而清除缓存？如果数据量愈来愈多，不就像做过山车一样，启动时加载全量数据，使用量飚的很高，关闭时删除全量缓存，使用量逐渐落回低谷(redis有<a href="http://wangneng-168.iteye.com/blog/2100379" target="_blank" rel="external">内存释放机制</a>)。对于内存型中间件产品，这样的使用会带来很多的不可靠性。</p><p>启动时加载数据到redis时的处理过程,部分为伪码：<br></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">File</span>表对应的实体类：</div><div class="line"><span class="keyword">public</span> class <span class="built_in">File</span>&#123;<span class="comment">//与数据库字段名完全的一致</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> uid;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> crc32;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> url;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> path;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> filename;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> <span class="built_in">size</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> ext;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> is_image;</div><div class="line">    <span class="keyword">private</span> Timestamp create_time;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> storage_type;</div><div class="line"></div><div class="line">    <span class="comment">//忽略 getter\setter</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//调用Dao层访问Mysql数据库，取回File表的所有记录，每条记录包含所有字段。</span></div><div class="line">List&lt;<span class="built_in">File</span>&gt; files=<span class="keyword">this</span>.fileDao.getAll();</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//读取File表的SQL：SELECT * FROM FILE;</span></div><div class="line"></div><div class="line"><span class="built_in">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;files.<span class="built_in">size</span>();i++)&#123;</div><div class="line">    <span class="keyword">this</span>.cacheDao.setOneFileToRedis(files.<span class="built_in">get</span>(i).getId(),files.<span class="built_in">get</span>(i).getUrl());<span class="comment">//调用Dao层访问Redis，将数据存入redis</span></div><div class="line">    <span class="comment">//WTF?只需要2个字段，然而取回了所有字段？而且不能批量存入redis?</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">cacheDao的实现</div><div class="line"><span class="keyword">private</span> final <span class="keyword">static</span> <span class="keyword">String</span> PHOTO_CACHE_KEY=<span class="string">"photos"</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> setOneFileToRedis(<span class="keyword">int</span> id,<span class="keyword">String</span> url)&#123;</div><div class="line">    <span class="keyword">this</span>.jedis.hset(PHOTO_CACHE_KEY, id.toString(), url);<span class="comment">//1.使用[Hash数据结构](https://redis.readthedocs.org/en/2.4/hash.html)。2.没有设置key有效期，即永久有效。</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">String</span> getOneFileInRedis(<span class="keyword">int</span> id)&#123;</div><div class="line">    <span class="built_in">return</span> <span class="keyword">this</span>.jedis.hget(PHOTO_CACHE_KEY, id.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>这样图片信息缓存的结构看起来是这样:<br><img src="/img/photos在redis的数据结构示例.png" alt="photos在redis的数据结构示例"><br>实际的情况下，size远大于1000，上文说了约在120w左右，我的这个redis可视化工具(redisclient-win32.x86.2.0)无法获取size这样大的key，报SocketTimeOutException。猜测是向redis获取大key时，无法在一个socket包中写入，造成通讯失败。</p><p>以上cacheDao的实现中，没有提供一次批量获取所需的多个图片信息，例如“public Map<integer ,string>getBatchFileInRedis(int[] ids)”，甚至在cache interface中都没有提供这样的接口定义。</integer></p><p>这样导致在上层逻辑中，出现大量一次性代码。因为调用不集中，给重构带来很大麻烦。<br></p><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">这是分页获取商品列表的伪代码实现</div><div class="line"></div><div class="line">与数据库product表对应的实体类</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> price;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> photoId;</div><div class="line"></div><div class="line">    <span class="comment">//忽略 getter\setter</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">真实的返回到app端的对象</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductFull</span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> price;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> photoId;</div><div class="line">    <span class="keyword">private</span> String photoUrl;</div><div class="line"></div><div class="line">    <span class="comment">//忽略 getter\setter</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;ProductFull&gt; <span class="title">findProductByPage</span>(<span class="params"><span class="keyword">int</span> pageSize,<span class="keyword">int</span> pageNo</span>)</span>&#123;</div><div class="line">    List&lt;Product&gt; products=<span class="keyword">this</span>.productDao.findByPage(<span class="keyword">int</span> pageSize,<span class="keyword">int</span> pageNo);<span class="comment">//调用Dao层访问Mysql</span></div><div class="line">    List&lt;ProductFull&gt; results=<span class="keyword">new</span> ArrayList&lt;&gt;(products.size());</div><div class="line">    <span class="keyword">for</span>(Product product:products)&#123;</div><div class="line">        ProductFull pf=<span class="keyword">new</span> ProductFull();</div><div class="line">        pf.setId(product.getId());<span class="comment">//其他的属性值都是类似的拷贝，或借助Apache-Common beanUtils组件进行拷贝。</span></div><div class="line"></div><div class="line"></div><div class="line">        String url=<span class="keyword">this</span>.cacheDao.getOneFileInRedis(product.getPhotoId());<span class="comment">//每一个循环项都访问了redis</span></div><div class="line">        pf.setPhotoUrl(url);</div><div class="line">        results.<span class="keyword">add</span>(pf);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> results;</div><div class="line">&#125;</div><div class="line"></div><div class="line">如果每个商品分页是<span class="number">10</span>条，最坏情况下，需要访问<span class="number">1</span>次Mysql+访问<span class="number">10</span>次redis。非常严重的是，每个分页条数的大小由app端决定，服务端不限制，WTF?</div></pre></td></tr></table></figure><p></p><h3 id="缓存登录后的用户信息"><a href="#缓存登录后的用户信息" class="headerlink" title="缓存登录后的用户信息"></a>缓存登录后的用户信息</h3><p>在这个产品面向消费者以及商家，都推出了不同的APP。互联网APP为了提高用户体验，以及降低用户登录登出频次(用户的登录/登出操作，对服务器是比较大的开销)，都会对一次登陆成功的用户，默认在一段时间不需要再次登录。即服务器分配Token给APP本地保存，同时服务器保存Token，设置该Token在一段时间不活动后自动失效，APP后续与服务器的通信中，都需要提交该Token鉴权。这是很常规的做法，短时间有效，而且是非关键性小数据，一次写入多次读取，对于服务器来说，没有比memcached或redis更合适的选择了，那为什么没有选择memcached？我个人的猜测是memcached更适合做Object Store Server，而且很重要的redis具有丰富数据结构与<a href="http://www.cnblogs.com/EE-NovRain/p/3268476.html" target="_blank" rel="external">扩容与容灾机制</a>。</p><p>用户的第一次登录，服务端进行参数解析，鉴权后，就需要写入2次redis。<br>用户的登出接口中，直接是删除当前会话的redis记录。</p><p>第一次：写入本次登入的Token与用户信息的关联<br></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">登录成功后，从DB或Cache层获取用户数据，构造用户数据JSON</div><div class="line"><span class="keyword">String</span> userLoginSuccessInfo=<span class="string">"&#123;"</span>uid<span class="string">":12321,"</span>name<span class="string">":"</span>张三<span class="string">","</span>sex<span class="string">":0,"</span>avatar_id<span class="string">":345643&#125;"</span>;</div><div class="line"></div><div class="line">cacheDao的实现</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">String</span> SESSION_CACHE_KEY=<span class="string">"session:"</span>;</div><div class="line"><span class="comment">//登录成功</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> setOneLoginSuccessToRedis(<span class="keyword">String</span> token,<span class="keyword">String</span> userLoginSuccessInfo)&#123;</div><div class="line">    <span class="keyword">this</span>.jedis.setex(SESSION_CACHE_KEY+token, <span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>, userLoginSuccessInfo);<span class="comment">//1.使用String数据结构。2.设置key有效期30天。</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//鉴权</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">String</span> getOneLoginSuccessInRedis(<span class="keyword">String</span> token)&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jedis.<span class="built_in">get</span>(SESSION_CACHE_KEY+token);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//登出</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> logoutSuccessInRedis(<span class="keyword">String</span> token)&#123;</div><div class="line">    <span class="keyword">this</span>.jedis.del(SESSION_CACHE_KEY+token);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">这个以<span class="string">"session:"</span>开头的<span class="built_in">key</span>里，并没有实现从uid如何获取token值？</div><div class="line">这会引发的问题：一个用户的多次登录，会生成多个以<span class="string">"session:"</span>开头的<span class="built_in">key</span>，没有覆盖之前登录的token。造成内存空间的浪费，以及不安全。正确的做法在下文会提到。</div></pre></td></tr></table></figure><p></p><p>第二次：写入本次登入的用户id与24小时内的积分获取信息。</p><p>有一个需求定义用户在登录后可以获取积分，但在24小时内的登录只算一次。</p><p>那在服务器端的是实现是，用户第一次登录成功后，在redis写入一个与该用户相关的key，并设置24小时后失效，然后再增加积分。用户在24小时内进行第二次登录，先读取redis是否有相关的key，使用exist命令，如果已经有了，就不增加积分了。</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">登录成功后，从DB或Cache层获取用户数据，构造用户与积分业务数据JSON</div><div class="line"><span class="keyword">int</span> uid=<span class="number">158263</span>;</div><div class="line"></div><div class="line">cacheDao的实现</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String USER_ACTIVITY_CACHE_KEY=<span class="string">"daily_activity_"</span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setOneUserWithActivityToRedis</span><span class="params">(<span class="keyword">int</span> uid)</span></span>&#123;</div><div class="line">    <span class="keyword">this</span>.jedis.setex(USER_ACTIVITY_CACHE_KEY+uid, <span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>, <span class="string">""</span>);<span class="comment">//1.使用String数据结构。2.设置key有效期24h。3.value部分为空字符串？</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">checkOneUserWithActivityToRedis</span><span class="params">(<span class="keyword">int</span> uid)</span></span>&#123;</div><div class="line">    <span class="keyword">this</span>.jedis.exists(USER_ACTIVITY_CACHE_KEY+uid);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这部分的业务属于典型案例，浪费内存空间。<br>第一个问题，不应该使用长前缀，每个key都需要set进内存，长前缀意味着空间占用，以及效率低下。<br>第二个问题，这不是明显可以使用<a href="https://redis.readthedocs.org/en/2.4/sorted_set.html" target="_blank" rel="external">Sorted Set数据结构</a>?，还可以省掉一次exists检查。</p><p>虽然redis的TPS很高，但是我们依旧要避免滥用。</p><h2 id="这次的问题的描述？"><a href="#这次的问题的描述？" class="headerlink" title="这次的问题的描述？"></a>这次的问题的描述？</h2><p>测试MM提出在性能测试环境中，有一些API在并发数到250~300时，出现很多报错。<br></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis的相关错误</div><div class="line">Could <span class="keyword">not</span> <span class="builtin-name">get</span> a<span class="built_in"> resource </span><span class="keyword">from</span> the pool</div></pre></td></tr></table></figure><p></p><p>典型报错的接口有</p><ul><li>分页获取商品列表</li><li>用户登录</li></ul><p>应用中配置redis连接池上限值是1000，而在redis server端配置maxClients=10000;区区这点并发，就耗尽redis连接池资源了？绝不可能，问题还在更远的地方等着我.</p><p>性能测试环境配置<br></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">硬件配置</div><div class="line">操作系统    Linux Ubuntu <span class="number">14.04</span><span class="number">.4</span> LTS</div><div class="line">CPU个数   <span class="number">4</span></div><div class="line">CPU时钟频率 <span class="number">2.6</span>G</div><div class="line">内存  <span class="number">4</span>G</div><div class="line">有无外部存储  云端存储</div><div class="line"></div><div class="line">软件配置</div><div class="line">docker  <span class="number">1.9</span><span class="number">.1</span></div><div class="line">mysql   <span class="number">5.6</span></div><div class="line">jdk <span class="number">1.8</span><span class="number">.0</span>_72</div><div class="line">solr    <span class="number">5.3</span><span class="number">.0</span></div><div class="line">redis   <span class="number">3.0</span><span class="number">.5</span></div></pre></td></tr></table></figure><p></p><h2 id="如何一步步的解决问题？"><a href="#如何一步步的解决问题？" class="headerlink" title="如何一步步的解决问题？"></a>如何一步步的解决问题？</h2><p>在描述问题产生背景时，其实也提到了很多不合理的地方，但<em>存在即合理</em>，处在现在的困境，一定有当时的无奈。现在我们一起来总结一下问题所在。</p><h3 id="对缓存图片的处理存在的问题"><a href="#对缓存图片的处理存在的问题" class="headerlink" title="对缓存图片的处理存在的问题"></a>对缓存图片的处理存在的问题</h3><ul><li>产品初始化时全量塞入redis/产品停止运行是全量卸掉</li><li>产品初始化时塞入redis时，没有做批量操作</li><li>对批量获取图片信息不支持，在接口层面就已经没有定义，对于可预见的需求没有进行考虑，这是架构设计的缺陷。</li><li>引申：大量的数据，放在一个key里，会出现问题，需要进行水平切分(Sharding)。</li></ul><h4 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h4><p>1.图片的Id数据在File表采用了<em>自增长</em>的方式生成，不会出现重复，并且有顺序。我们可以利用这一点，在产品初始化时，在Mysql数据库File表只查找2个字段：id/url。程序处理时，先写入reids一个key，使用Hash数据结构，isInitIng:photos-true，标明到正在初始化，其他产品节点不需要重复初始化。使用hmset的方式，一次性将多个键值对存入到redis。完成后，修改isInitIng:photos-false。当有了新图片时，先在Mysql数据库File表进行保存，得到这个图片的Id以及url，使用hset加入该图片到redis。如果需要修改某一张图片的url，也可以用hset。这样在产品停止运行时，是不需要删除redis关于图片的数据的。</p><p>2.cache层加入新接口，支持批量获取图片信息<br></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">String</span> PHOTO_CACHE_KEY=<span class="string">"photos"</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> setFileToRedis(Map&lt;Integer,<span class="keyword">String</span>&gt; photos)&#123;</div><div class="line">    <span class="keyword">this</span>.jedis.hmset(PHOTO_CACHE_KEY, photos);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> Map&lt;Integer,<span class="keyword">String</span>&gt; getBatchFileInRedis(<span class="built_in">int</span>[] ids)&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jedis.hmget(PHOTO_CACHE_KEY, coverArrayToString(ids));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span>[] coverArrayToString(<span class="built_in">int</span>[] ids)&#123;</div><div class="line">    <span class="keyword">String</span>[] results=<span class="keyword">new</span> <span class="keyword">String</span>[ids.length];</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; ids.length; i++) &#123;</div><div class="line">        results[i]=ids[i]+<span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> results;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>对之前循环调用的上层代码进行修改，改为调用批量获取接口。</p><p>3.对于单个key承载大量的数据的情况，方案是对key下的values hash key进行分割，使用一定的算法将块状的数据均匀分布在多个key里。给一个<a href="http://blog.nosqlfan.com/html/3379.html" target="_blank" rel="external">参考链接</a>。</p><h3 id="对缓存用户登录的处理存在的问题"><a href="#对缓存用户登录的处理存在的问题" class="headerlink" title="对缓存用户登录的处理存在的问题"></a>对缓存用户登录的处理存在的问题</h3><ul><li>session的存储不合理，每次登陆都会生成一个新的key值</li><li>对USER_ACTIVITY_CACHE_KEY在value部分的数据结构不合理，应采用Sorted Set</li><li>对USER_ACTIVITY_CACHE_KEY的命名不合适，过长导致空间浪费和效率低下</li><li>因采用错误数据结构，USER_ACTIVITY_CACHE_KEY需要进行多一次的exists判断。</li></ul><h4 id="方案-1"><a href="#方案-1" class="headerlink" title="方案"></a>方案</h4><p>session的存储不合理的解决，通过新的key(uid:token)来反向标记uid与token的关系，2个key的超时时间保持一致，例如<br></p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">uid:</span><span class="number">158742</span>-token001</div></pre></td></tr></table></figure><p></p><p>在写入SESSION_CACHE_KEY时，同时写入到redis，为保证2次写入的原子性，需要使用<a href="https://redis.readthedocs.org/en/2.4/transaction.html" target="_blank" rel="external">redis的事务</a>。如果支持用户的多设备在线，只需要将key(uid:token)更改为Sorted Set结构。因为不存在资源的争夺，这个事务几乎不会失败。在用户登出时，删除掉当前会话信息以及用户关联的会话信息(同样是使用redis事务)。</p><p>注意，单机redis环境下，事务命令被完整的支持。扩展到多机redis协同工作时，如果使用了twemproxy，则事务命令不受支持，无法应用该方案。<a href="https://github.com/twitter/twemproxy/blob/master/notes/redis.md" target="_blank" rel="external">查看twemproxy对redis命令的支持情况</a>。<br></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">cacheDao的实现</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">String</span> SESSION_CACHE_KEY=<span class="string">"se:"</span>;<span class="comment">//全称："session:"，改善key命名，按业务进行简略，提升网络传输和存储效率。</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">String</span> USER_TOKEN_CACHE_KEY=<span class="string">"u:t:"</span>;<span class="comment">//uid:token:</span></div><div class="line"><span class="comment">//登录成功，保存用户登录Token。接收建议的token参数值，返回实际保存的token值。</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">String</span> setOneLoginSuccessToRedis(<span class="built_in">int</span> uid,<span class="keyword">String</span> token,<span class="keyword">String</span> userLoginSuccessInfo)&#123;<span class="comment">//重构</span></div><div class="line">    <span class="keyword">if</span>(checkOneUserTokenExists(uid))&#123;</div><div class="line">        token=getOneUserToken(uid);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">long</span> expireTime=<span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>;<span class="comment">//设置key有效期30天。</span></div><div class="line">    <span class="keyword">String</span> ret=<span class="keyword">this</span>.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);<span class="comment">//乐观锁，重试，在这里几乎不存在</span></div><div class="line">    <span class="keyword">if</span>(ret==<span class="keyword">null</span>||!ret.equals(<span class="string">"OK"</span>))&#123;</div><div class="line">        <span class="built_in">log</span>.error(<span class="string">"redis watch 操作失败.ret:&#123;&#125;"</span>,ret);</div><div class="line">        <span class="keyword">this</span>.jedis.unwatch();</div><div class="line">    &#125;</div><div class="line">    Transaction tx = <span class="keyword">this</span>.jedis.multi();</div><div class="line">    tx.setex(SESSION_CACHE_KEY+token, expireTime, userLoginSuccessInfo);</div><div class="line">    tx.setex(USER_TOKEN_CACHE_KEY+uid, expireTime, token);</div><div class="line">    List&lt;<span class="keyword">Object</span>&gt; results = tx.exec();</div><div class="line">    <span class="keyword">return</span> token;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//检查用户登录Token是否已经存在</span></div><div class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> checkOneUserTokenExists(<span class="built_in">int</span> uid)&#123;<span class="comment">//新方法</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jedis.exists(USER_TOKEN_CACHE_KEY+uid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//获取用户登录Token信息</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">String</span> getOneUserToken(<span class="built_in">int</span> uid)&#123;<span class="comment">//新方法</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jedis.<span class="built_in">get</span>(USER_TOKEN_CACHE_KEY+uid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//鉴权</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">String</span> getOneLoginSuccessInRedis(<span class="keyword">String</span> token)&#123;<span class="comment">//不改动</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jedis.<span class="built_in">get</span>(SESSION_CACHE_KEY+token);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//登出</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> logoutSuccessInRedis(<span class="keyword">String</span> token)&#123;</div><div class="line">    <span class="keyword">String</span> ret=<span class="keyword">this</span>.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);<span class="comment">//乐观锁，重试，在这里几乎不存在</span></div><div class="line">    <span class="keyword">if</span>(ret==<span class="keyword">null</span>||!ret.equals(<span class="string">"OK"</span>))&#123;</div><div class="line">        <span class="built_in">log</span>.error(<span class="string">"redis watch 操作失败.ret:&#123;&#125;"</span>,ret);</div><div class="line">        <span class="keyword">this</span>.jedis.unwatch();</div><div class="line">    &#125;</div><div class="line">    Transaction tx = <span class="keyword">this</span>.jedis.multi();</div><div class="line">    tx.del(SESSION_CACHE_KEY+token);</div><div class="line">    tx.del(USER_TOKEN_CACHE_KEY+uid);</div><div class="line">    List&lt;<span class="keyword">Object</span>&gt; results = tx.exec();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h4 id="隐患和思考"><a href="#隐患和思考" class="headerlink" title="隐患和思考"></a>隐患和思考</h4><p>redis事务带来的问题，redis的事务设计比较暴力，这给应用层带来了麻烦。</p><ul><li>Redis的基本事务（basic transaction）需要用到MULTI命令和EXEC命令，这种事务可以让一个客户端在不被其他客户端打断的情况下执行多个命令。和关系数据库那种可以在执行的过程中进行回滚（rollback）的事务不同，在Redis里面，被MULTI命令和EXEC命令包围的所有命令会一个接一个地执行，直到所有命令都执行完毕为止。当一个事务执行完毕之后，Redis才会处理其他客户端的命令。</li><li><a href="http://redisdoc.com/topic/transaction.html" target="_blank" rel="external">Redis 在事务失败时不进行回滚，而是继续执行余下的命令</a></li></ul><p>基于此，redis事务会在客户端高并发时，其他客户端命令产生阻塞，而且事务回滚需要应用层自己解决。关于事务无法自动回滚，这在NoSQL领域是常见问题了。</p><h4 id="redis时间线设计"><a href="#redis时间线设计" class="headerlink" title="redis时间线设计"></a>redis时间线设计</h4><p>接下来对用户在24小时内的积分信息的处理进行改进，以及redis不支持对Set内的单个Element进行有效期设置，我们采用Sorted Set结构，结合Score特性和Quartz来达到元素过期被删除的目的。<br></p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">cacheDao的实现</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String USER_ACTIVITY_CACHE_KEY=<span class="string">"a:d"</span>;<span class="comment">//全称："activity:daily:"，改善key命名，按业务进行简略，提升网络传输和存储效率。</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setOneUserWithActivityToRedis</span><span class="params">(<span class="keyword">int</span> uid)</span></span>&#123;</div><div class="line">    <span class="keyword">this</span>.jedis.zadd(USER_ACTIVITY_CACHE_KEY,System.currentTimeMillis(),uid+<span class="string">""</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">checkOneUserWithActivityToRedis</span><span class="params">(<span class="keyword">int</span> uid)</span></span>&#123;</div><div class="line">    <span class="keyword">this</span>.jedis.sismember(USER_ACTIVITY_CACHE_KEY,uid+<span class="string">""</span>);</div><div class="line">    <span class="keyword">long</span> score=<span class="keyword">this</span>.jedis.zscore(USER_ACTIVITY_CACHE_KEY,uid+<span class="string">""</span>);</div><div class="line">    <span class="keyword">if</span>(score&gt;<span class="number">0</span>)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">另外加入一个计划任务，借助Quartz即可。</div><div class="line">String corn=*/<span class="number">1</span> * * * * ?  <span class="comment">//每1秒钟执行1次</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">cleanExpireUserWithActivity</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">long</span> now=System.currentTimeMillis();</div><div class="line">    <span class="keyword">long</span> <span class="number">1</span>MAgo=now<span class="number">-60</span>*<span class="number">1000</span>;<span class="comment">//1分钟前的时间</span></div><div class="line">    <span class="keyword">long</span> remCount=<span class="keyword">this</span>.jedis.zremrangeByScore(USER_ACTIVITY_CACHE_KEY,<span class="number">1</span>MAgo,now);</div><div class="line">    log.info(<span class="string">"成功删除的元素数量是：&#123;&#125;，执行时间是：&#123;&#125;"</span>,remCount,now);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h4 id="隐患和思考-1"><a href="#隐患和思考-1" class="headerlink" title="隐患和思考"></a>隐患和思考</h4><p>在上文给出的代码中，我们做了一定的容错性，每次删除过去1分钟的所有Element，这样Quartz出现故障时，如果在1分钟内得到fixed，影响的数据只限于1分钟内的Element。每1秒钟触发一次Quartz与删除过去1分钟的所有Element，这2个维度的频率需要权衡。</p><ul><li>过高频率的访问redis是否会有稳定性问题？</li><li>删除Element的时间区间过大，是否会影响redis执行效率(时间复杂度:<a href="http://redisdoc.com/sorted_set/zrevrangebyscore.html" target="_blank" rel="external">O(log(N)+M)</a>)，导致阻塞？</li><li>高频率删除Element，是否会影响redis的RDB与AOF备份，因此造成额外的问题？</li></ul><p>借助Quartz还有misfire的隐患，如何保障Quartz在每一秒钟都顺畅执行一次(Once and only once)，这涉及到操作系统、内存的可靠性，这是一个大的命题，我们不过多讨论。</p><p>记录一下对这类问题的思考</p><ul><li>可以对这个计划任务进行多机并行运行。例如：A计划与B计划都处于运行状态，A在奇数秒触发，B在偶数秒触发。进一步降低2秒内misfire的概率。</li><li>在Quartz启动Job时，检测到是业务高峰期，另开启一个异步线程，调用cleanExpireUserWithActivity方法，而cleanExpireUserWithActivity需要承受并发，即redis需要对zremrangeByScore命令支持并发，但redis是<a href="http://www.blogjava.net/caojianhua/archive/2013/01/28/394847.html" target="_blank" rel="external">单进程单线程模型</a>。</li><li>异步线程受制于redis，还可以进行改进，使用队列，如ActiveMQ。调用cleanExpireUserWithActivity逻辑进行调整，将命令序列化后写入到点对点队列，另外使用程序监听队列(即消费者端)，有新命令时取出，这里实际调用cleanExpireUserWithActivity，仅在调用成功后释放命令。</li><li>现在问题在于如何保障ActiveMQ的稳定运行了，应该还有改进方案。</li></ul><p>按照以上的方案进行重构后，性能得到显著提升，按理论来说稳定性会有提高，因为不具备稳定性测试的条件，没法比较。</p><h2 id="遇到了一些问题"><a href="#遇到了一些问题" class="headerlink" title="遇到了一些问题"></a>遇到了一些问题</h2><p>1.redis一次批量hmset过多时报错<br>hmset操作时，对于一次传入参数数量上限有要求。这取决于你的网络环境下，socket一次写入的字节数上限。<br></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">String</span> hmset(<span class="keyword">final</span> <span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">final</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; hash);</div></pre></td></tr></table></figure><p></p><p>在我本机的环境下(应用与redis都在本机，不同端口，redis以默认配置运行)，Map<string , string="">hash的size大于5w左右就会报错。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">redis<span class="selector-class">.clients</span><span class="selector-class">.jedis</span><span class="selector-class">.exceptions</span><span class="selector-class">.JedisConnectionException</span>: java<span class="selector-class">.net</span><span class="selector-class">.SocketException</span>: Software caused connection abort: socket write error</div><div class="line">    at redis<span class="selector-class">.clients</span><span class="selector-class">.jedis</span><span class="selector-class">.Protocol</span><span class="selector-class">.sendCommand</span>(Protocol<span class="selector-class">.java</span>:<span class="number">98</span>)</div><div class="line">    at redis<span class="selector-class">.clients</span><span class="selector-class">.jedis</span><span class="selector-class">.Protocol</span><span class="selector-class">.sendCommand</span>(Protocol<span class="selector-class">.java</span>:<span class="number">78</span>)</div><div class="line">    at redis<span class="selector-class">.clients</span><span class="selector-class">.jedis</span><span class="selector-class">.Connection</span><span class="selector-class">.sendCommand</span>(Connection<span class="selector-class">.java</span>:<span class="number">101</span>)</div><div class="line">    at redis<span class="selector-class">.clients</span><span class="selector-class">.jedis</span><span class="selector-class">.BinaryClient</span><span class="selector-class">.hmset</span>(BinaryClient<span class="selector-class">.java</span>:<span class="number">246</span>)</div><div class="line">    at redis<span class="selector-class">.clients</span><span class="selector-class">.jedis</span><span class="selector-class">.Client</span><span class="selector-class">.hmset</span>(Client<span class="selector-class">.java</span>:<span class="number">171</span>)</div><div class="line">    at redis<span class="selector-class">.clients</span><span class="selector-class">.jedis</span><span class="selector-class">.Jedis</span><span class="selector-class">.hmset</span>(Jedis<span class="selector-class">.java</span>:<span class="number">652</span>)</div></pre></td></tr></table></figure></string></p><p>在这种情况下，必需要将大Map切分成一块块的Map，循环调用hmset<br></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="built_in">int</span> maxEveryTurn=<span class="number">5000</span>;<span class="comment">//定义每次最多批量塞入redis的key数量</span></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 批量存储到redis的key数量太多，必需切分成小块存储</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> setTooManyToJedis(Jedis jedis, Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span>) &#123;</div><div class="line">        <span class="built_in">int</span> <span class="built_in">size</span>=<span class="built_in">map</span>.<span class="built_in">size</span>();</div><div class="line">        <span class="built_in">int</span> pieceNum=<span class="built_in">size</span>/maxEveryTurn;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">size</span>&gt;(pieceNum*maxEveryTurn))&#123;</div><div class="line">            pieceNum+=<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        Iterator&lt;Map.Entry&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt;&gt; iterator = <span class="built_in">map</span>.entrySet().iterator();</div><div class="line">        List&lt;Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt;&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;(pieceNum);</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i=<span class="number">0</span>;i&lt;pieceNum;i++)&#123;</div><div class="line">            list.<span class="built_in">add</span>(<span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;&gt;(maxEveryTurn));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</div><div class="line">            Map.Entry&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; entry = iterator.next();</div><div class="line">            <span class="keyword">String</span> <span class="built_in">key</span> = entry.getKey();</div><div class="line">            <span class="built_in">int</span> hashCode = Math.<span class="built_in">abs</span>(<span class="keyword">String</span>.valueOf(<span class="built_in">key</span>).hashCode());</div><div class="line">            <span class="built_in">int</span> index=hashCode % pieceNum;</div><div class="line">            list.<span class="built_in">get</span>(index).put(<span class="built_in">key</span>, <span class="built_in">map</span>.<span class="built_in">get</span>(<span class="built_in">key</span>));</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">map</span>.<span class="built_in">clear</span>();</div><div class="line">        <span class="keyword">for</span> (Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; pieceMap:list)&#123;</div><div class="line">            setToJedis(jedis, pieceMap);</div><div class="line">        &#125;</div><div class="line">        list.<span class="built_in">clear</span>();</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p></p><p>2.持续写redis时遇到rdb问题<br>在完成以上方案的改进后，测试人员的用户登录这个接口在进行性能回归测试时，使用gatling配置250个工作线程进行并发，一共完成50w的用户登录后就算是结束，再根据生成的测试报告分析。<br>刚开始每次压到20多w的用户登录时，就会报错，redis连接池无连接了。分析代码是配置了testOnBorrow:true，这个配置会在获取到连接后检查该连接的有效性，如果无效就丢弃，即在连接池删掉一个连接。而此时redis因为问题无法执行用户端的任何命令，所以所有连接都被当做无效连接被丢弃？直到连接池空了。<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">在redis命令行执行</div><div class="line"><span class="keyword">set</span> <span class="keyword">test</span> <span class="number">12321</span></div><div class="line">返回错误：</div><div class="line">(<span class="keyword">error</span>) MISCONF Redis <span class="keyword">is</span> configured <span class="keyword">to</span> <span class="keyword">save</span> RDB snapshots, but <span class="keyword">is</span> currently <span class="keyword">not</span> able <span class="keyword">to</span> persist <span class="keyword">on</span> disk. Commands that may <span class="keyword">modify</span> the <span class="keyword">data</span> <span class="keyword">set</span> <span class="keyword">are</span> disabled. Please <span class="keyword">check</span> Redis <span class="keyword">logs</span> <span class="keyword">for</span> details about the error.</div></pre></td></tr></table></figure><p></p><p>这是因为默认的redis配置是以<a href="http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22" target="_blank" rel="external">RDB的方式</a>进行定期存盘，而存盘时，会拒绝所有外部命令的写入(存盘失败后也会拒绝写入)。因为目前在redis的数据都处于可丢，解决方式也相当的粗暴。<br></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">1.保证redis处于运行状态，查询系统6379端口的监听情况</div><div class="line">2.顺序执行以下命令行，遇到错误请终止</div><div class="line">docker exec -it test_redis_1 /bin/bash</div><div class="line">cd usr/local/bin</div><div class="line">./redis-cli.sh</div><div class="line">config <span class="builtin-name">set</span> stop-writes-on-bgsave-<span class="builtin-name">error</span> <span class="literal">no</span></div><div class="line">config <span class="builtin-name">set</span> save <span class="string">""</span></div><div class="line">quit</div><div class="line">exit</div></pre></td></tr></table></figure><p></p><p>执行完以后，重启应用，再压测，呵呵，bug关闭。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。。注意Slave与Master第一次进行同步时会使用全量复制，对资源会有比较大的消耗，尽量选择在业务平峰期进行。<br>引申阅读，Master在这里成为了单点，为了Master的高可用，还有进一步的方案，1个Master下挂2个Slave，其中1个Slave(称为A)负责2种方式的存盘，另一个Slave(称为B)作为Master的热备，在Master故障后，参与到投票，成为新的Master，而B节点切换到A，接受A的增量同步。注意自动failover时，外部需要关闭写入命令。完成failover后，使用ip映射切换，使应用层重新恢复使用，相应的，应用层需要做到一定的容错性。实际生产中，不会要求应用层去做容错性措施，会有各种中间件(twemproxy)自动处理。</p><p>2.以上业务中对<a href="https://www.ttlsa.com/redis/redis-database/" target="_blank" rel="external">redis的16个数据库</a>没有使用好，可以按业务将数据存储到不同数据库，隔离影响。</p><h3 id="常用命令合集"><a href="#常用命令合集" class="headerlink" title="常用命令合集"></a>常用命令合集</h3><p>调试过程中，由于可视化工具对redis支持的不够好，使用了很多redis的命令行，现在我们总结一下吧！<br>由于docker的风行，好处多多，我们在测试环境、线上环境也使用了docker/docker-compose</p><h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker-compose ps          <span class="comment">//查看yml文件中所有容器的运行情况</span></div><div class="line">docker-compose up -d xw    <span class="comment">//将yml文件中容器名称定义为xw的容器，以后台运行的方式运行起来，如果是tomcat镜像，会调用tomcat的startup.sh.</span></div><div class="line">docker-compose <span class="built_in">stop</span> xw     <span class="comment">//将yml文件中容器名称定义为xw的容器停止，如果是tomcat镜像，会调用tomcat的shutdown.sh</span></div><div class="line">docker-compose <span class="built_in">stop</span>        <span class="comment">//查看yml文件中所有容器进行停止</span></div><div class="line">docker-compose rm xw       <span class="comment">//移除xw镜像</span></div><div class="line">docker-compose build xw    <span class="comment">//对xw进行镜像构建</span></div></pre></td></tr></table></figure><h4 id="redis-cli-sh-info"><a href="#redis-cli-sh-info" class="headerlink" title="./redis-cli.sh/info"></a>./redis-cli.sh/info</h4><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">F:</span>\Redis&gt; ./redis-<span class="keyword">cli</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; info</div><div class="line"><span class="meta"># Server</span></div><div class="line"><span class="symbol">redis_version:</span><span class="number">3.0</span><span class="number">.501</span></div><div class="line"><span class="symbol">redis_git_sha1:</span><span class="number">00000000</span></div><div class="line"><span class="symbol">redis_git_dirty:</span><span class="number">0</span></div><div class="line"><span class="symbol">redis_build_id:</span>ba05b51e58eb9205</div><div class="line"><span class="symbol">redis_mode:</span>standalone</div><div class="line"><span class="symbol">os:</span>Windows</div><div class="line"><span class="symbol">arch_bits:</span><span class="number">64</span></div><div class="line"><span class="symbol">multiplexing_api:</span>WinSock_IOCP</div><div class="line"><span class="symbol">process_id:</span><span class="number">1552</span></div><div class="line"><span class="symbol">run_id:</span>d3f2efa1c6cf26c7cf9246c2fcaca89b8e109439</div><div class="line"><span class="symbol">tcp_port:</span><span class="number">6379</span></div><div class="line"><span class="symbol">uptime_in_seconds:</span><span class="number">462095</span></div><div class="line"><span class="symbol">uptime_in_days:</span><span class="number">5</span></div><div class="line"><span class="symbol">hz:</span><span class="number">10</span></div><div class="line"><span class="symbol">lru_clock:</span><span class="number">16404129</span></div><div class="line"><span class="symbol">config_file:</span>F:\Redis\redis.windows.conf</div><div class="line"></div><div class="line"><span class="meta"># Clients</span></div><div class="line"><span class="symbol">connected_clients:</span><span class="number">1</span></div><div class="line"><span class="symbol">client_longest_output_list:</span><span class="number">0</span></div><div class="line"><span class="symbol">client_biggest_input_buf:</span><span class="number">0</span></div><div class="line"><span class="symbol">blocked_clients:</span><span class="number">0</span></div><div class="line"></div><div class="line"><span class="meta"># Memory</span></div><div class="line"><span class="symbol">used_memory:</span><span class="number">842704</span></div><div class="line"><span class="symbol">used_memory_human:</span><span class="number">822.95</span>K</div><div class="line"><span class="symbol">used_memory_rss:</span><span class="number">804920</span></div><div class="line"><span class="symbol">used_memory_peak:</span><span class="number">374731600</span></div><div class="line"><span class="symbol">used_memory_peak_human:</span><span class="number">357.37</span>M</div><div class="line"><span class="symbol">used_memory_lua:</span><span class="number">36864</span></div><div class="line"><span class="symbol">mem_fragmentation_ratio:</span><span class="number">0.96</span></div><div class="line"><span class="symbol">mem_allocator:</span>jemalloc<span class="number">-3.6</span><span class="number">.0</span></div><div class="line"></div><div class="line"><span class="meta"># Persistence</span></div><div class="line"><span class="symbol">loading:</span><span class="number">0</span></div><div class="line"><span class="symbol">rdb_changes_since_last_save:</span><span class="number">0</span></div><div class="line"><span class="symbol">rdb_bgsave_in_progress:</span><span class="number">0</span></div><div class="line"><span class="symbol">rdb_last_save_time:</span><span class="number">1459242952</span></div><div class="line"><span class="symbol">rdb_last_bgsave_status:</span>ok</div><div class="line"><span class="symbol">rdb_last_bgsave_time_sec:</span><span class="number">1</span></div><div class="line"><span class="symbol">rdb_current_bgsave_time_sec:</span><span class="number">-1</span></div><div class="line"><span class="symbol">aof_enabled:</span><span class="number">0</span></div><div class="line"><span class="symbol">aof_rewrite_in_progress:</span><span class="number">0</span></div><div class="line"><span class="symbol">aof_rewrite_scheduled:</span><span class="number">0</span></div><div class="line"><span class="symbol">aof_last_rewrite_time_sec:</span><span class="number">-1</span></div><div class="line"><span class="symbol">aof_current_rewrite_time_sec:</span><span class="number">-1</span></div><div class="line"><span class="symbol">aof_last_bgrewrite_status:</span>ok</div><div class="line"><span class="symbol">aof_last_write_status:</span>ok</div><div class="line"></div><div class="line"><span class="meta"># Stats</span></div><div class="line"><span class="symbol">total_connections_received:</span><span class="number">1010</span></div><div class="line"><span class="symbol">total_commands_processed:</span><span class="number">49859</span></div><div class="line"><span class="symbol">instantaneous_ops_per_sec:</span><span class="number">0</span></div><div class="line"><span class="symbol">total_net_input_bytes:</span><span class="number">1822381802</span></div><div class="line"><span class="symbol">total_net_output_bytes:</span><span class="number">3650427</span></div><div class="line"><span class="symbol">instantaneous_input_kbps:</span><span class="number">0.00</span></div><div class="line"><span class="symbol">instantaneous_output_kbps:</span><span class="number">0.00</span></div><div class="line"><span class="symbol">rejected_connections:</span><span class="number">0</span></div><div class="line"><span class="symbol">sync_full:</span><span class="number">0</span></div><div class="line"><span class="symbol">sync_partial_ok:</span><span class="number">0</span></div><div class="line"><span class="symbol">sync_partial_err:</span><span class="number">0</span></div><div class="line"><span class="symbol">expired_keys:</span><span class="number">1073</span></div><div class="line"><span class="symbol">evicted_keys:</span><span class="number">0</span></div><div class="line"><span class="symbol">keyspace_hits:</span><span class="number">20782</span></div><div class="line"><span class="symbol">keyspace_misses:</span><span class="number">738</span></div><div class="line"><span class="symbol">pubsub_channels:</span><span class="number">0</span></div><div class="line"><span class="symbol">pubsub_patterns:</span><span class="number">0</span></div><div class="line"><span class="symbol">latest_fork_usec:</span><span class="number">388023</span></div><div class="line"><span class="symbol">migrate_cached_sockets:</span><span class="number">0</span></div><div class="line"></div><div class="line"><span class="meta"># Replication</span></div><div class="line"><span class="symbol">role:</span>master</div><div class="line"><span class="symbol">connected_slaves:</span><span class="number">0</span></div><div class="line"><span class="symbol">master_repl_offset:</span><span class="number">0</span></div><div class="line"><span class="symbol">repl_backlog_active:</span><span class="number">0</span></div><div class="line"><span class="symbol">repl_backlog_size:</span><span class="number">1048576</span></div><div class="line"><span class="symbol">repl_backlog_first_byte_offset:</span><span class="number">0</span></div><div class="line"><span class="symbol">repl_backlog_histlen:</span><span class="number">0</span></div><div class="line"></div><div class="line"><span class="meta"># CPU</span></div><div class="line"><span class="symbol">used_cpu_sys:</span><span class="number">9.45</span></div><div class="line"><span class="symbol">used_cpu_user:</span><span class="number">38.25</span></div><div class="line"><span class="symbol">used_cpu_sys_children:</span><span class="number">0.00</span></div><div class="line"><span class="symbol">used_cpu_user_children:</span><span class="number">0.00</span></div><div class="line"></div><div class="line"><span class="meta"># Cluster</span></div><div class="line"><span class="symbol">cluster_enabled:</span><span class="number">0</span></div><div class="line"></div><div class="line"><span class="meta"># Keyspace</span></div><div class="line"><span class="symbol">db0:</span>keys=<span class="number">1</span>,expires=<span class="number">0</span>,avg_ttl=<span class="number">0</span></div></pre></td></tr></table></figure><h4 id="set-get"><a href="#set-get" class="headerlink" title="set/get"></a>set/get</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">test</span> 123456</div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">test</span></div><div class="line">"123456"</div></pre></td></tr></table></figure><h4 id="hset-hmset-hget-hmget"><a href="#hset-hmset-hget-hmget" class="headerlink" title="hset/hmset/hget/hmget"></a>hset/hmset/hget/hmget</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hset testHash key1 value11</div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hget testHash</div><div class="line">(error) ERR wrong number of arguments <span class="keyword">for</span> <span class="string">'hget'</span> command</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hget testHash key1</div><div class="line"><span class="string">"value11"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hset testHash key1 value11 key2 value22</div><div class="line">(error) ERR wrong number of arguments <span class="keyword">for</span> <span class="string">'hset'</span> command</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hmset testHash key1 value11 key2 value22</div><div class="line">OK</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hmget testHash key1 key2</div><div class="line"><span class="number">1</span>) <span class="string">"value11"</span></div><div class="line"><span class="number">2</span>) <span class="string">"value22"</span></div></pre></td></tr></table></figure><h4 id="hlen-keys"><a href="#hlen-keys" class="headerlink" title="hlen/keys"></a>hlen/keys</h4><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt; len <span class="keyword">test</span></div><div class="line">(error) ERR unknown command <span class="string">'len'</span></div><div class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt; hlen testHash</div><div class="line">(integer) <span class="number">2</span></div><div class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt; keys <span class="keyword">test</span></div><div class="line"><span class="number">1</span>) <span class="string">"test"</span></div><div class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt; keys testHash</div><div class="line"><span class="number">1</span>) <span class="string">"testHash"</span></div><div class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt; keys *</div><div class="line"><span class="number">1</span>) <span class="string">"testHash"</span></div><div class="line"><span class="number">2</span>) <span class="string">"test"</span></div><div class="line"><span class="number">3</span>) <span class="string">"message-queue-sms"</span></div></pre></td></tr></table></figure><h4 id="config-set-get"><a href="#config-set-get" class="headerlink" title="config set/get"></a>config set/get</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt;<span class="built_in"> config </span><span class="builtin-name">get</span> *</div><div class="line">  1) <span class="string">"dbfilename"</span></div><div class="line">  2) <span class="string">"dump.rdb"</span></div><div class="line">  3) <span class="string">"requirepass"</span></div><div class="line">  4) <span class="string">""</span></div><div class="line">  5) <span class="string">"masterauth"</span></div><div class="line">  6) <span class="string">""</span></div><div class="line">  7) <span class="string">"unixsocket"</span></div><div class="line">  8) <span class="string">""</span></div><div class="line">  9) <span class="string">"logfile"</span></div><div class="line"> 10) <span class="string">""</span></div><div class="line"> 11) <span class="string">"pidfile"</span></div><div class="line"> 12) <span class="string">"/var/run/redis.pid"</span></div><div class="line"> 13) <span class="string">"maxmemory"</span></div><div class="line"> 14) <span class="string">"512000000"</span></div><div class="line"> 15) <span class="string">"maxmemory-samples"</span></div><div class="line"> 16) <span class="string">"5"</span></div><div class="line"> 17) <span class="string">"timeout"</span></div><div class="line"> 18) <span class="string">"0"</span></div><div class="line"> 19) <span class="string">"tcp-keepalive"</span></div><div class="line"> 20) <span class="string">"0"</span></div><div class="line"> 21) <span class="string">"auto-aof-rewrite-percentage"</span></div><div class="line"> 22) <span class="string">"100"</span></div><div class="line"> 23) <span class="string">"auto-aof-rewrite-min-size"</span></div><div class="line"> 24) <span class="string">"67108864"</span></div><div class="line"> 25) <span class="string">"hash-max-ziplist-entries"</span></div><div class="line"> 26) <span class="string">"512"</span></div><div class="line"> 27) <span class="string">"hash-max-ziplist-value"</span></div><div class="line"> 28) <span class="string">"64"</span></div><div class="line"> 29) <span class="string">"list-max-ziplist-entries"</span></div><div class="line"> 30) <span class="string">"512"</span></div><div class="line"> 31) <span class="string">"list-max-ziplist-value"</span></div><div class="line"> 32) <span class="string">"64"</span></div><div class="line"> 33) <span class="string">"set-max-intset-entries"</span></div><div class="line"> 34) <span class="string">"512"</span></div><div class="line"> 35) <span class="string">"zset-max-ziplist-entries"</span></div><div class="line"> 36) <span class="string">"128"</span></div><div class="line"> 37) <span class="string">"zset-max-ziplist-value"</span></div><div class="line"> 38) <span class="string">"64"</span></div><div class="line"> 39) <span class="string">"hll-sparse-max-bytes"</span></div><div class="line"> 40) <span class="string">"3000"</span></div><div class="line"> 41) <span class="string">"lua-time-limit"</span></div><div class="line"> 42) <span class="string">"5000"</span></div><div class="line"> 43) <span class="string">"slowlog-log-slower-than"</span></div><div class="line"> 44) <span class="string">"10000"</span></div><div class="line"> 45) <span class="string">"latency-monitor-threshold"</span></div><div class="line"> 46) <span class="string">"0"</span></div><div class="line"> 47) <span class="string">"slowlog-max-len"</span></div><div class="line"> 48) <span class="string">"128"</span></div><div class="line"> 49) <span class="string">"port"</span></div><div class="line"> 50) <span class="string">"6379"</span></div><div class="line"> 51) <span class="string">"tcp-backlog"</span></div><div class="line"> 52) <span class="string">"511"</span></div><div class="line"> 53) <span class="string">"databases"</span></div><div class="line"> 54) <span class="string">"16"</span></div><div class="line"> 55) <span class="string">"repl-ping-slave-period"</span></div><div class="line"> 56) <span class="string">"10"</span></div><div class="line"> 57) <span class="string">"repl-timeout"</span></div><div class="line"> 58) <span class="string">"60"</span></div><div class="line"> 59) <span class="string">"repl-backlog-size"</span></div><div class="line"> 60) <span class="string">"1048576"</span></div><div class="line"> 61) <span class="string">"repl-backlog-ttl"</span></div><div class="line"> 62) <span class="string">"3600"</span></div><div class="line"> 63) <span class="string">"maxclients"</span></div><div class="line"> 64) <span class="string">"10000"</span></div><div class="line"> 65) <span class="string">"watchdog-period"</span></div><div class="line"> 66) <span class="string">"0"</span></div><div class="line"> 67) <span class="string">"slave-priority"</span></div><div class="line"> 68) <span class="string">"100"</span></div><div class="line"> 69) <span class="string">"min-slaves-to-write"</span></div><div class="line"> 70) <span class="string">"0"</span></div><div class="line"> 71) <span class="string">"min-slaves-max-lag"</span></div><div class="line"> 72) <span class="string">"10"</span></div><div class="line"> 73) <span class="string">"hz"</span></div><div class="line"> 74) <span class="string">"10"</span></div><div class="line"> 75) <span class="string">"cluster-node-timeout"</span></div><div class="line"> 76) <span class="string">"15000"</span></div><div class="line"> 77) <span class="string">"cluster-migration-barrier"</span></div><div class="line"> 78) <span class="string">"1"</span></div><div class="line"> 79) <span class="string">"cluster-slave-validity-factor"</span></div><div class="line"> 80) <span class="string">"10"</span></div><div class="line"> 81) <span class="string">"repl-diskless-sync-delay"</span></div><div class="line"> 82) <span class="string">"5"</span></div><div class="line"> 83) <span class="string">"cluster-require-full-coverage"</span></div><div class="line"> 84) <span class="string">"yes"</span></div><div class="line"> 85) <span class="string">"no-appendfsync-on-rewrite"</span></div><div class="line"> 86) <span class="string">"no"</span></div><div class="line"> 87) <span class="string">"slave-serve-stale-data"</span></div><div class="line"> 88) <span class="string">"yes"</span></div><div class="line"> 89) <span class="string">"slave-read-only"</span></div><div class="line"> 90) <span class="string">"yes"</span></div><div class="line"> 91) <span class="string">"stop-writes-on-bgsave-error"</span></div><div class="line"> 92) <span class="string">"yes"</span></div><div class="line"> 93) <span class="string">"daemonize"</span></div><div class="line"> 94) <span class="string">"no"</span></div><div class="line"> 95) <span class="string">"rdbcompression"</span></div><div class="line"> 96) <span class="string">"yes"</span></div><div class="line"> 97) <span class="string">"rdbchecksum"</span></div><div class="line"> 98) <span class="string">"yes"</span></div><div class="line"> 99) <span class="string">"activerehashing"</span></div><div class="line">100) <span class="string">"yes"</span></div><div class="line">101) <span class="string">"repl-disable-tcp-nodelay"</span></div><div class="line">102) <span class="string">"no"</span></div><div class="line">103) <span class="string">"repl-diskless-sync"</span></div><div class="line">104) <span class="string">"no"</span></div><div class="line">105) <span class="string">"aof-rewrite-incremental-fsync"</span></div><div class="line">106) <span class="string">"yes"</span></div><div class="line">107) <span class="string">"aof-load-truncated"</span></div><div class="line">108) <span class="string">"yes"</span></div><div class="line">109) <span class="string">"appendonly"</span></div><div class="line">110) <span class="string">"no"</span></div><div class="line">111) <span class="string">"dir"</span></div><div class="line">112) <span class="string">"F:\\Redis"</span></div><div class="line">113) <span class="string">"maxmemory-policy"</span></div><div class="line">114) <span class="string">"noeviction"</span></div><div class="line">115) <span class="string">"appendfsync"</span></div><div class="line">116) <span class="string">"everysec"</span></div><div class="line">117) <span class="string">"save"</span></div><div class="line">118) <span class="string">"jd 900 jd 300 jd 60"</span></div><div class="line">119) <span class="string">"loglevel"</span></div><div class="line">120) <span class="string">"verbose"</span></div><div class="line">121) <span class="string">"client-output-buffer-limit"</span></div><div class="line">122) <span class="string">"normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60"</span></div><div class="line">123) <span class="string">"unixsocketperm"</span></div><div class="line">124) <span class="string">"0"</span></div><div class="line">125) <span class="string">"slaveof"</span></div><div class="line">126) <span class="string">""</span></div><div class="line">127) <span class="string">"notify-keyspace-events"</span></div><div class="line">128) <span class="string">""</span></div><div class="line">129) <span class="string">"bind"</span></div><div class="line">130) <span class="string">""</span></div><div class="line">127.0.0.1:6379&gt;<span class="built_in"> config </span><span class="builtin-name">set</span> save <span class="string">""</span></div><div class="line">OK</div></pre></td></tr></table></figure><h4 id="flushdb-flushall"><a href="#flushdb-flushall" class="headerlink" title="flushdb/flushall"></a>flushdb/flushall</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">flushdb</span></div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">flushall</span></div><div class="line"><span class="selector-tag">OK</span></div></pre></td></tr></table></figure><h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><ul><li>redis删除有序集合部分过期元素：<a href="http://caozm.blog.51cto.com/1118764/1389168" target="_blank" rel="external">http://caozm.blog.51cto.com/1118764/1389168</a></li><li>节约内存：Instagram的Redis实践：<a href="http://blog.nosqlfan.com/html/3379.html" target="_blank" rel="external">http://blog.nosqlfan.com/html/3379.html</a></li><li>redis持久化机制：<a href="http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22" target="_blank" rel="external">http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22</a></li><li>Redis事务的分析及改进：<a href="https://segmentfault.com/a/1190000002594059" target="_blank" rel="external">https://segmentfault.com/a/1190000002594059</a></li><li>redis 多数据库：<a href="https://www.ttlsa.com/redis/redis-database/" target="_blank" rel="external">https://www.ttlsa.com/redis/redis-database/</a></li><li>利用Sorted Set数据结构，为元素设置有效期：<a href="http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set" target="_blank" rel="external">http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set</a></li><li>redis的Slave选举与优先级：<a href="https://segmentfault.com/a/1190000002685515" target="_blank" rel="external">https://segmentfault.com/a/1190000002685515</a></li><li>利用代理中间件实现大规模Redis集群：<a href="http://www.imooc.com/article/4343" target="_blank" rel="external">http://www.imooc.com/article/4343</a></li></ul></div><div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>Talk is cheap,show me the code.</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/rewards/wechat-reward-image.png" alt="Steven Cheng WeChat Pay"><p>微信打赏</p></div></div></div></div><footer class="post-footer"><div class="copyright" style="clear:both"><p><span>本文标题：</span><a href="/post/2016/03/A-successful-redis-tuning-record/">记一次redis成功调优的过程</a></p><p><span>文章作者：</span><a href="/" title="访问 Steven Cheng 的个人博客">Steven Cheng</a></p><p><span>发布时间：</span>2016年3月23日 - 16时03分</p><p><span>本文字数：</span><span class="page-count">17,309字</span></p><p><span>原始链接：</span><a href="/post/2016/03/A-successful-redis-tuning-record/" title="记一次redis成功调优的过程">https://amao12580.github.io/post/2016/03/A-successful-redis-tuning-record/</a></p><p><span>许可协议：</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" title="Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)">Attribution-NonCommercial 4.0</a></p><p><span>转载请保留以上信息。</span></p></div><div class="post-tags"><a href="/tags/Redis/" rel="tag">#Redis</a> <a href="/tags/Hash/" rel="tag">#Hash</a> <a href="/tags/Sharding/" rel="tag">#Sharding</a> <a href="/tags/Twemproxy/" rel="tag">#Twemproxy</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/2016/03/SQL-improve-elegant-use-join-query/" rel="next" title="SQL查询提高篇：捋清连接查询的那些事儿"><i class="fa fa-chevron-left"></i> SQL查询提高篇：捋清连接查询的那些事儿</a></div><div class="post-nav-prev post-nav-item"><a href="/post/2016/04/A-new-start/" rel="prev" title="从零开始Blogging with Hexo教程">从零开始Blogging with Hexo教程<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="gitment_container"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="https://amao12580.github.io/about"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Steven Cheng"><p class="site-author-name" itemprop="name">Steven Cheng</p><p class="site-description motion-element" itemprop="description">https://amao12580.github.io/about</p></a></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags"><span class="site-state-item-count">68</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/amao12580" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://segmentfault.com/blogs" title="SegmentFault" target="_blank">SegmentFault</a></li><li class="links-of-blogroll-item"><a href="http://blog.jobbole.com/" title="伯乐在线" target="_blank">伯乐在线</a></li><li class="links-of-blogroll-item"><a href="http://cnpolitics.org/" title="政见" target="_blank">政见</a></li><li class="links-of-blogroll-item"><a href="http://dajia.qq.com/" title="大家" target="_blank">大家</a></li><li class="links-of-blogroll-item"><a href="http://www.importnew.com/" title="ImportNew" target="_blank">ImportNew</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#我们怎么使用Redis？"><span class="nav-number">1.</span> <span class="nav-text">我们怎么使用Redis？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存图片信息"><span class="nav-number">1.1.</span> <span class="nav-text">缓存图片信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存登录后的用户信息"><span class="nav-number">1.2.</span> <span class="nav-text">缓存登录后的用户信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#这次的问题的描述？"><span class="nav-number">2.</span> <span class="nav-text">这次的问题的描述？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何一步步的解决问题？"><span class="nav-number">3.</span> <span class="nav-text">如何一步步的解决问题？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#对缓存图片的处理存在的问题"><span class="nav-number">3.1.</span> <span class="nav-text">对缓存图片的处理存在的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#方案"><span class="nav-number">3.1.1.</span> <span class="nav-text">方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对缓存用户登录的处理存在的问题"><span class="nav-number">3.2.</span> <span class="nav-text">对缓存用户登录的处理存在的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#方案-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#隐患和思考"><span class="nav-number">3.2.2.</span> <span class="nav-text">隐患和思考</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redis时间线设计"><span class="nav-number">3.2.3.</span> <span class="nav-text">redis时间线设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#隐患和思考-1"><span class="nav-number">3.2.4.</span> <span class="nav-text">隐患和思考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#遇到了一些问题"><span class="nav-number">4.</span> <span class="nav-text">遇到了一些问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常用命令合集"><span class="nav-number">5.1.</span> <span class="nav-text">常用命令合集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#docker"><span class="nav-number">5.1.1.</span> <span class="nav-text">docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redis-cli-sh-info"><span class="nav-number">5.1.2.</span> <span class="nav-text">./redis-cli.sh/info</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set-get"><span class="nav-number">5.1.3.</span> <span class="nav-text">set/get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hset-hmset-hget-hmget"><span class="nav-number">5.1.4.</span> <span class="nav-text">hset/hmset/hget/hmget</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hlen-keys"><span class="nav-number">5.1.5.</span> <span class="nav-text">hlen/keys</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#config-set-get"><span class="nav-number">5.1.6.</span> <span class="nav-text">config set/get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#flushdb-flushall"><span class="nav-number">5.1.7.</span> <span class="nav-text">flushdb/flushall</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展阅读"><span class="nav-number">6.</span> <span class="nav-text">扩展阅读</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 - <span itemprop="copyrightYear">2017</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Steven Cheng</span> <span class="post-count">&nbsp全站共170.8k字</span></div><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>访问量<span id="busuanzi_value_site_pv"></span> &nbsp 您是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴<script>var OriginTitile=document.title,st;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(つェ⊂)我藏好了哦~",clearTimeout(st)):(document.title="(*´∇｀*)被你发现啦~ "+OriginTitile,console.log("show"),st=setTimeout(function(){document.title=OriginTitile},4e3))})</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script><script src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script src="//cdn.bootcss.com/velocity/1.2.3/velocity.min.js"></script><script src="//cdn.bootcss.com/velocity/1.2.3/velocity.ui.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script src="/js/src/main.js?v=5.0.1"></script><script src="//cdn.bootcss.com/bootstrap/3.2.0/js/affix.js"></script><script src="/js/src/post.js?v=5.0.1"></script><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment=new Gitment({owner:"amao12580",repo:"amao12580.github.io",oauth:{client_id:"4af869efcafad6f5df55",client_secret:"778c271d1b466eca5b6d4d9bddde1a49dabb7511"}});gitment.render("gitment_container")</script><script>function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=r.url,i=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){i=s.indexOf(e),l=n.indexOf(e),0>i&&0>l?c=!1:(0>l&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;0>u&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").mousedown(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>